name: Verse Syntax Check

on:
  pull_request:
    branches:
      - main
    paths:
      - '**.verse'
      - 'tools/scripts/verse-lsp/**'
      - '.github/workflows/verse-syntax-check.yml'

jobs:
  verse-syntax-check:
    name: Check Verse Code Syntax
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Setup Verse LSP environment
        run: |
          echo "Setting up Verse LSP environment..."
          chmod +x tools/scripts/verse-lsp/setup-verse-env.sh
          ./tools/scripts/verse-lsp/setup-verse-env.sh
      
      - name: Install Python dependencies
        run: |
          pip install -r tools/scripts/verse-lsp/requirements.txt || echo "No additional dependencies needed"
      
      - name: Find Verse files
        id: find-verse
        run: |
          VERSE_FILES=$(find . -name "*.verse" -type f | tr '\n' ' ')
          if [ -z "$VERSE_FILES" ]; then
            echo "No Verse files found"
            echo "has_verse_files=false" >> $GITHUB_OUTPUT
          else
            echo "Found Verse files: $VERSE_FILES"
            echo "has_verse_files=true" >> $GITHUB_OUTPUT
            echo "verse_files=$VERSE_FILES" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Verse syntax
        if: steps.find-verse.outputs.has_verse_files == 'true'
        run: |
          echo "Checking Verse code syntax..."
          
          # Run check and capture exit code
          if python tools/scripts/verse-lsp/check-verse.py --dir . > verse-check-output.txt 2>&1; then
            echo "âœ… All Verse files passed syntax check"
            cat verse-check-output.txt
            echo '{"status": "success", "error_count": 0, "message": "All files passed"}' > verse-check-results.json
            exit 0
          else
            echo "âŒ Syntax errors found in Verse files"
            cat verse-check-output.txt
            
            # Count errors from output
            ERROR_COUNT=$(grep -c "âœ—" verse-check-output.txt || echo "1")
            echo "{\"status\": \"failed\", \"error_count\": $ERROR_COUNT, \"message\": \"Syntax errors found\"}" > verse-check-results.json
            exit 1
          fi
      
      - name: Upload check results
        if: always() && steps.find-verse.outputs.has_verse_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: verse-syntax-check-results
          path: |
            verse-check-results.json
            verse-check-output.txt
          retention-days: 30
      
      - name: Comment on PR with results
        if: always() && steps.find-verse.outputs.has_verse_files == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ğŸ” Verse è¯­æ³•æ£€æŸ¥ç»“æœ\n\n';
            
            try {
              const results = JSON.parse(fs.readFileSync('verse-check-results.json', 'utf8'));
              
              if (results.status === 'success') {
                comment += 'âœ… **æ‰€æœ‰ Verse æ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡**\n\n';
                comment += `- é”™è¯¯æ•°: ${results.error_count}\n`;
                
                // Try to read detailed output
                try {
                  const output = fs.readFileSync('verse-check-output.txt', 'utf8');
                  const fileCount = (output.match(/æ£€æŸ¥æ–‡ä»¶:/g) || []).length;
                  if (fileCount > 0) {
                    comment += `- æ£€æŸ¥çš„æ–‡ä»¶æ•°: ${fileCount}\n`;
                  }
                } catch (e) {}
              } else {
                comment += 'âŒ **å‘ç°è¯­æ³•é”™è¯¯**\n\n';
                comment += `- é”™è¯¯æ•°: ${results.error_count}\n`;
                
                // Try to include error details from output
                try {
                  const output = fs.readFileSync('verse-check-output.txt', 'utf8');
                  comment += '\n### æ£€æŸ¥è¾“å‡º\n\n```\n';
                  // Truncate if too long
                  const maxLength = 3000;
                  if (output.length > maxLength) {
                    comment += output.substring(0, maxLength) + '\n...(è¾“å‡ºè¿‡é•¿ï¼Œå·²æˆªæ–­)\n';
                  } else {
                    comment += output;
                  }
                  comment += '\n```\n';
                } catch (e) {}
              }
            } catch (error) {
              comment += 'âš ï¸ æ— æ³•è¯»å–æ£€æŸ¥ç»“æœ\n';
              comment += `é”™è¯¯: ${error.message}\n`;
            }
            
            comment += '\n---\n';
            comment += '*æ­¤æ£€æŸ¥ç”± [Verse LSP Checker](.github/workflows/verse-syntax-check.yml) è‡ªåŠ¨æ‰§è¡Œ*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

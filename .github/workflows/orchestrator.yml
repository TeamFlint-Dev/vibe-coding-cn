# Event Orchestrator
#
# 监听所有事件，根据任务配置协调各个工作流的执行

name: "Event Orchestrator"

on:
  repository_dispatch:
    types:
      - task:start
      - agent:complete
      - compile:complete

jobs:
  # ============================================
  # 处理 task:start - 任务启动
  # ============================================
  handle-task-start:
    name: "Handle Task Start"
    if: github.event.action == 'task:start'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse task config
        id: parse
        run: |
          echo "Received task:start event"
          echo '${{ toJson(github.event.client_payload) }}' | jq .

          WORKFLOW="${{ github.event.client_payload.workflow }}"
          echo "workflow=$WORKFLOW" >> $GITHUB_OUTPUT

      - name: Create task branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.event.client_payload.branch_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git push origin "$BRANCH"

          echo "Created branch: $BRANCH"

      - name: "Trigger Verse Dev Agent"
        if: github.event.client_payload.workflow == 'verse-dev' || github.event.client_payload.workflow == 'verse-dev-only'
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        run: |
          echo "Triggering verse-dev-loop agent"

          NEXT_STEP="${{ github.event.client_payload.workflow == 'verse-dev' && 'compile' || 'complete' }}"
          gh workflow run verse-dev-loop.lock.yml \
            -f requirement="${{ github.event.client_payload.requirement }}" \
            -f working_branch="${{ github.event.client_payload.branch_name }}" \
            -f task_id="${{ github.event.client_payload.task_id }}" \
            -f retry_count="0" \
            -f next_step="$NEXT_STEP"

      - name: "Trigger Compile Only"
        if: github.event.client_payload.workflow == 'compile-only'
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        run: |
          echo "Sending compile:request event"

          PAYLOAD=$(jq -n \
            --arg task_id "${{ github.event.client_payload.task_id }}" \
            --arg branch_name "${{ github.event.client_payload.branch_name }}" \
            '{task_id: $task_id, branch_name: $branch_name, retry_count: 0}')

          echo "{\"event_type\":\"compile:request\",\"client_payload\":$PAYLOAD}" | gh api repos/${{ github.repository }}/dispatches --input -

  # ============================================
  # 处理 agent:complete - Agent 完成
  # ============================================
  handle-agent-complete:
    name: "Handle Agent Complete"
    if: github.event.action == 'agent:complete'
    runs-on: ubuntu-latest

    steps:
      - name: Parse Agent result
        run: |
          echo "Agent complete event"
          echo '${{ toJson(github.event.client_payload) }}' | jq .

      - name: Trigger next step
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        run: |
          NEXT_STEP="${{ github.event.client_payload.next_step }}"
          STATUS="${{ github.event.client_payload.status }}"

          if [ "$STATUS" != "success" ]; then
            echo "Agent failed, task terminated"
            exit 0
          fi

          if [ "$NEXT_STEP" == "compile" ]; then
            echo "Sending compile:request event"

            PAYLOAD=$(jq -n \
              --arg task_id "${{ github.event.client_payload.task_id }}" \
              --arg branch_name "${{ github.event.client_payload.branch_name }}" \
              --arg requirement "${{ github.event.client_payload.requirement }}" \
              --argjson max_retries ${{ github.event.client_payload.max_retries }} \
              '{task_id: $task_id, branch_name: $branch_name, requirement: $requirement, max_retries: $max_retries, retry_count: 0}')

            echo "{\"event_type\":\"compile:request\",\"client_payload\":$PAYLOAD}" | gh api repos/${{ github.repository }}/dispatches --input -

          elif [ "$NEXT_STEP" == "complete" ]; then
            echo "Task complete!"
          fi

  # ============================================
  # 处理 compile:complete - 编译完成
  # ============================================
  handle-compile-complete:
    name: "Handle Compile Complete"
    if: github.event.action == 'compile:complete'
    runs-on: ubuntu-latest

    steps:
      - name: Parse compile result
        run: |
          echo "Compile complete event"
          echo '${{ toJson(github.event.client_payload) }}' | jq .

      - name: Handle compile result
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        run: |
          STATUS="${{ github.event.client_payload.status }}"
          RETRY_COUNT=${{ github.event.client_payload.retry_count }}
          MAX_RETRIES=${{ github.event.client_payload.max_retries }}

          if [ "$STATUS" == "success" ]; then
            echo "Compile success! Creating PR..."

            gh pr create \
              --base main \
              --head "${{ github.event.client_payload.branch_name }}" \
              --title "feat: ${{ github.event.client_payload.task_id }}" \
              --body "## Task Complete\n\n**Requirement**: ${{ github.event.client_payload.requirement }}\n\nAuto-generated PR, please review and merge." \
              || echo "PR may already exist"

          elif [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo "Compile failed, triggering fix (retry $((RETRY_COUNT + 1))/$MAX_RETRIES)"

            gh workflow run verse-dev-loop.lock.yml \
              -f requirement="${{ github.event.client_payload.requirement }}" \
              -f working_branch="${{ github.event.client_payload.branch_name }}" \
              -f task_id="${{ github.event.client_payload.task_id }}" \
              -f compile_errors="${{ github.event.client_payload.errors }}" \
              -f retry_count="${{ github.event.client_payload.retry_count }}" \
              -f next_step="compile"

          else
            echo "Max retries reached, task failed"
          fi

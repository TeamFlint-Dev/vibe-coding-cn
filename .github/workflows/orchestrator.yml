#  äº‹ä»¶åè°ƒ?- Event Orchestrator
#
# ç›‘å¬æ‰€æœ‰äº‹ä»¶ï¼Œæ ¹æ®ä»»åŠ¡é…ç½®åè°ƒå„ä¸ªå·¥ä½œæµçš„æ‰§è¡Œ

name: "ğŸ¯ Event Orchestrator"

on:
  repository_dispatch:
    types:
      - task:start
      - agent:complete
      - compile:complete

jobs:
  # ============================================
  # å¤„ç† task:start - ä»»åŠ¡å¯åŠ¨
  # ============================================
  handle-task-start:
    name: " å¤„ç†ä»»åŠ¡å¯åŠ¨"
    if: github.event.action == 'task:start'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: è§£æä»»åŠ¡é…ç½®
        id: parse
        run: |
          echo " æ”¶åˆ°ä»»åŠ¡å¯åŠ¨äº‹ä»¶"
          echo '${{ toJson(github.event.client_payload) }}' | jq .
          
          WORKFLOW="${{ github.event.client_payload.workflow }}"
          echo "workflow=$WORKFLOW" >> $GITHUB_OUTPUT
      
      - name: åˆ›å»ºä»»åŠ¡åˆ†æ”¯
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.event.client_payload.branch_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»ºæ–°åˆ†?
          git checkout -b "$BRANCH"
          git push origin "$BRANCH"
          
          echo " åˆ›å»ºåˆ†æ”¯: $BRANCH"
      
      # ---- verse-dev å·¥ä½œ?----
      - name: "è§¦å‘ Verse å¼€?Agent"
        if: github.event.client_payload.workflow == 'verse-dev' || github.event.client_payload.workflow == 'verse-dev-only'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo " å‘?agent:start äº‹ä»¶?verse-dev-loop"
          
          PAYLOAD=$(jq -n \
            --arg task_id "${{ github.event.client_payload.task_id }}" \
            --arg branch_name "${{ github.event.client_payload.branch_name }}" \
            --arg requirement "${{ github.event.client_payload.requirement }}" \
            --arg agent "verse-dev-loop" \
            --argjson max_retries ${{ github.event.client_payload.max_retries }} \
            --arg next_step "${{ github.event.client_payload.workflow == 'verse-dev' && 'compile' || 'complete' }}" \
            '{task_id: $task_id, branch_name: $branch_name, requirement: $requirement, agent: $agent, max_retries: $max_retries, next_step: $next_step, retry_count: 0}')
          
          # ä½¿ç”¨ workflow_dispatch è§¦å‘ Agent (é¿å…æƒé™é—®é¢˜)
          gh workflow run verse-dev-loop.lock.yml \
            -f requirement="${{ github.event.client_payload.requirement }}" \
            -f working_branch="${{ github.event.client_payload.branch_name }}" \
            -f task_id="${{ github.event.client_payload.task_id }}" \
            -f retry_count="0" \
            -f next_step="${{ github.event.client_payload.workflow == 'verse-dev' && 'compile' || 'complete' }}"
      
      # ---- compile-only å·¥ä½œ?----
      - name: "è§¦å‘ç¼–è¯‘"
        if: github.event.client_payload.workflow == 'compile-only'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo " å‘?compile:request äº‹ä»¶"
          
          PAYLOAD=$(jq -n \
            --arg task_id "${{ github.event.client_payload.task_id }}" \
            --arg branch_name "${{ github.event.client_payload.branch_name }}" \
            '{task_id: $task_id, branch_name: $branch_name, retry_count: 0}')
          
          echo "{\"event_type\":\"compile:request\",\"client_payload\":$PAYLOAD}" | gh api repos/${{ github.repository }}/dispatches --input -

  # ============================================
  # å¤„ç† agent:complete - Agent å®Œæˆ
  # ============================================
  handle-agent-complete:
    name: " å¤„ç† Agent å®Œæˆ"
    if: github.event.action == 'agent:complete'
    runs-on: ubuntu-latest
    
    steps:
      - name: è§£æ Agent ç»“æœ
        run: |
          echo " Agent å®Œæˆäº‹ä»¶"
          echo '${{ toJson(github.event.client_payload) }}' | jq .
      
      - name: è§¦å‘ä¸‹ä¸€?
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_STEP="${{ github.event.client_payload.next_step }}"
          STATUS="${{ github.event.client_payload.status }}"
          
          if [ "$STATUS" != "success" ]; then
            echo " Agent å¤±è´¥ï¼Œä»»åŠ¡ç»ˆ?
            exit 0
          fi
          
          if [ "$NEXT_STEP" == "compile" ]; then
            echo " å‘?compile:request äº‹ä»¶"
            
            PAYLOAD=$(jq -n \
              --arg task_id "${{ github.event.client_payload.task_id }}" \
              --arg branch_name "${{ github.event.client_payload.branch_name }}" \
              --arg requirement "${{ github.event.client_payload.requirement }}" \
              --argjson max_retries ${{ github.event.client_payload.max_retries }} \
              '{task_id: $task_id, branch_name: $branch_name, requirement: $requirement, max_retries: $max_retries, retry_count: 0}')
            
            echo "{\"event_type\":\"compile:request\",\"client_payload\":$PAYLOAD}" | gh api repos/${{ github.repository }}/dispatches --input -
          
          elif [ "$NEXT_STEP" == "complete" ]; then
            echo " ä»»åŠ¡å®Œæˆ!"
          fi

  # ============================================
  # å¤„ç† compile:complete - ç¼–è¯‘å®Œæˆ
  # ============================================
  handle-compile-complete:
    name: " å¤„ç†ç¼–è¯‘å®Œæˆ"
    if: github.event.action == 'compile:complete'
    runs-on: ubuntu-latest
    
    steps:
      - name: è§£æç¼–è¯‘ç»“æœ
        run: |
          echo " ç¼–è¯‘å®Œæˆäº‹ä»¶"
          echo '${{ toJson(github.event.client_payload) }}' | jq .
      
      - name: å¤„ç†ç¼–è¯‘ç»“æœ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS="${{ github.event.client_payload.status }}"
          RETRY_COUNT=${{ github.event.client_payload.retry_count }}
          MAX_RETRIES=${{ github.event.client_payload.max_retries }}
          
          if [ "$STATUS" == "success" ]; then
            echo " ç¼–è¯‘æˆåŠŸ! åˆ›å»º PR..."
            
            gh pr create \
              --base main \
              --head "${{ github.event.client_payload.branch_name }}" \
              --title "feat: ${{ github.event.client_payload.task_id }}" \
              --body "## ä»»åŠ¡å®Œæˆ\n\n**éœ€?*: ${{ github.event.client_payload.requirement }}\n\nè‡ªåŠ¨ç”Ÿæˆ?PRï¼Œè¯·å®¡æ ¸ååˆå¹¶? \
              || echo "PR å¯èƒ½å·²å­˜?
          
          elif [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo " ç¼–è¯‘å¤±è´¥ï¼Œè§¦å‘ä¿®?(é‡è¯• $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            
            PAYLOAD=$(jq -n \
              --arg task_id "${{ github.event.client_payload.task_id }}" \
              --arg branch_name "${{ github.event.client_payload.branch_name }}" \
              --arg requirement "${{ github.event.client_payload.requirement }}" \
              --arg compile_errors "${{ github.event.client_payload.errors }}" \
              --arg agent "verse-dev-loop" \
              --argjson max_retries $MAX_RETRIES \
              --argjson retry_count $((RETRY_COUNT + 1)) \
              '{task_id: $task_id, branch_name: $branch_name, requirement: $requirement, compile_errors: $compile_errors, agent: $agent, max_retries: $max_retries, retry_count: $retry_count, next_step: "compile"}')
            
            # ä½¿ç”¨ workflow_dispatch è§¦å‘ Agent (é¿å…æƒé™é—®é¢˜)
          gh workflow run verse-dev-loop.lock.yml \
            -f requirement="${{ github.event.client_payload.requirement }}" \
            -f working_branch="${{ github.event.client_payload.branch_name }}" \
            -f task_id="${{ github.event.client_payload.task_id }}" \
            -f retry_count="${{ github.event.client_payload.retry_count }}" \
            -f next_step="compile"
          
          else
            echo " è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä»»åŠ¡å¤±è´¥"
          fi

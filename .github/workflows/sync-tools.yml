name: Sync Tools from Skills
# è‡ªåŠ¨æ”¶é›†æ‰€æœ‰ Skill ä¸‹çš„ tools åˆ° .github/tools/

on:
  push:
    paths:
      - 'Core/skills/**/tools/**'
  workflow_dispatch:

jobs:
  sync-tools:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Collect tools from Skills
        run: |
          echo "ğŸ“¦ æ”¶é›†æ‰€æœ‰ Skill ä¸‹çš„å·¥å…·..."
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p .github/tools
          
          # æŸ¥æ‰¾æ‰€æœ‰ Skill ä¸‹çš„ tools ç›®å½•ä¸­çš„æ–‡ä»¶ï¼ˆæ’é™¤ __pycache__ ç­‰ï¼‰
          find Core/skills -path "*/tools/*" -type f \
            ! -name "*.pyc" \
            ! -name "__pycache__" \
            ! -path "*/__pycache__/*" \
            | while read src; do
            filename=$(basename "$src")
            echo "  â†’ å¤åˆ¶ $src â†’ .github/tools/$filename"
            cp "$src" ".github/tools/$filename"
          done
          
          # è®¾ç½®å¯æ‰§è¡Œæƒé™ï¼ˆå¯¹ .sh å’Œæ— æ‰©å±•åçš„è„šæœ¬ï¼‰
          find .github/tools -type f \( -name "*.sh" -o ! -name "*.*" \) -exec chmod +x {} \;
          # å¯¹ .py æ–‡ä»¶ä¹Ÿè®¾ç½®å¯æ‰§è¡Œæƒé™ï¼ˆå¦‚æœæœ‰ shebangï¼‰
          find .github/tools -name "*.py" -exec sh -c 'head -1 "$1" | grep -q "^#!" && chmod +x "$1"' _ {} \;
          
          echo "âœ… å·¥å…·æ”¶é›†å®Œæˆ"
      
      - name: Generate tools index
        run: |
          echo "ğŸ“ ç”Ÿæˆå·¥å…·ç´¢å¼•..."
          
          cat > .github/tools/INDEX.md << 'EOF'
          # CLI Tools ç´¢å¼•
          
          > æ­¤æ–‡ä»¶ç”± CI è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘
          
          ## å¯ç”¨å·¥å…·
          
          | å·¥å…· | æ¥æº Skill | è¯´æ˜ |
          |------|-----------|------|
          EOF
          
          # éå†æ‰€æœ‰å·¥å…·æ–‡ä»¶ç”Ÿæˆç´¢å¼•
          for tool in .github/tools/*; do
            [ -f "$tool" ] || continue
            name=$(basename "$tool")
            # è·³è¿‡ INDEX.md å’Œ README.md
            [[ "$name" == "INDEX.md" || "$name" == "README.md" ]] && continue
            
            # æå–è¯´æ˜ï¼ˆä» docstring æˆ–æ³¨é‡Šï¼‰
            desc=""
            if [[ "$name" == *.py ]]; then
              desc=$(grep -m1 '"""' -A1 "$tool" 2>/dev/null | tail -1 | sed 's/^[[:space:]]*//' || echo "")
            else
              desc=$(grep -m1 '^#' "$tool" 2>/dev/null | sed 's/^#[[:space:]]*//' | head -c 50 || echo "")
            fi
            
            # æŸ¥æ‰¾æ¥æº Skill
            source=$(find Core/skills -name "$name" -path "*/tools/*" 2>/dev/null | head -1 | sed 's|Core/skills/||' | sed 's|/tools/.*||')
            [ -z "$source" ] && source="unknown"
            
            echo "| \`$name\` | $source | $desc |" >> .github/tools/INDEX.md
          done
          
          echo "âœ… ç´¢å¼•ç”Ÿæˆå®Œæˆ"
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .github/tools/
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ›´æ”¹"
          else
            git commit -m "chore: sync tools from Skills [skip ci]"
            git push
            echo "âœ… å·¥å…·å·²åŒæ­¥"
          fi

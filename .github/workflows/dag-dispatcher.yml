name: DAG Dispatcher

on:
  issue_comment:
    types: [created]

# ğŸ”’ å…³é”®ï¼šåŒä¸€ä¸ª Issue çš„ Dispatcher ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…é‡å¤è§¦å‘ Worker
concurrency:
  group: dag-dispatcher-${{ github.event.issue.number }}
  cancel-in-progress: false  # ä¸å–æ¶ˆï¼Œæ’é˜Ÿç­‰å¾…

jobs:
  dispatch:
    # åªå¤„ç†åŒ…å« DAG ä¿¡å·çš„è¯„è®º
    if: |
      contains(github.event.comment.body, '<!-- DAG_READY') ||
      contains(github.event.comment.body, '<!-- TASK_DONE')
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read
      actions: write
    
    steps:
      - name: Parse signal type
        id: signal
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          
          if [[ "$COMMENT_BODY" == *"<!-- DAG_READY"* ]]; then
            echo "type=dag_ready" >> $GITHUB_OUTPUT
            # æå– PR ç¼–å·
            PR_NUM=$(echo "$COMMENT_BODY" | grep -oP '<!-- DAG_READY pr=\K\d+' || echo "")
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT_BODY" == *"<!-- TASK_DONE"* ]]; then
            echo "type=task_done" >> $GITHUB_OUTPUT
            # æå–å®Œæˆçš„ Issue ç¼–å·
            DONE_ISSUE=$(echo "$COMMENT_BODY" | grep -oP '<!-- TASK_DONE issue=\K\d+' || echo "")
            echo "done_issue=$DONE_ISSUE" >> $GITHUB_OUTPUT
          fi
          
          echo "parent_issue=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      - name: Get sub-issues
        id: sub_issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PARENT_ISSUE=${{ steps.signal.outputs.parent_issue }}
          
          # è·å–çˆ¶ Issue çš„æ‰€æœ‰å­ Issue
          # ä½¿ç”¨ GitHub CLI åˆ—å‡ºå­ Issue
          gh api graphql -f query='
            query($owner: String!, $repo: String!, $issue: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $issue) {
                  subIssues(first: 50) {
                    nodes {
                      number
                      title
                      state
                      body
                      labels(first: 10) {
                        nodes { name }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ github.repository_owner }}" \
            -f repo="${{ github.event.repository.name }}" \
            -F issue="$PARENT_ISSUE" \
            --jq '.data.repository.issue.subIssues.nodes' > /tmp/sub_issues.json
          
          echo "å­ Issue åˆ—è¡¨:"
          cat /tmp/sub_issues.json | jq -r '.[] | "  #\(.number) [\(.state)] \(.title)"'
          
          # ä¿å­˜åˆ° output
          echo "json=$(cat /tmp/sub_issues.json | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Find ready tasks
        id: ready
        run: |
          SUB_ISSUES='${{ steps.sub_issues.outputs.json }}'
          
          # æ‰¾å‡ºæ‰€æœ‰ OPEN ä¸”æœ‰ pending æ ‡ç­¾çš„ä»»åŠ¡
          PENDING_ISSUES=$(echo "$SUB_ISSUES" | jq -c '[.[] | select(.state == "OPEN") | select(.labels.nodes | any(.name == "pending"))]')
          
          echo "å¾…å¤„ç†ä»»åŠ¡:"
          echo "$PENDING_ISSUES" | jq -r '.[] | "  #\(.number) \(.title)"'
          
          # è·å–æ‰€æœ‰å·²å…³é—­çš„ Issue ç¼–å·
          CLOSED_ISSUES=$(echo "$SUB_ISSUES" | jq -r '[.[] | select(.state == "CLOSED") | .number] | @csv' | tr -d '"')
          echo "å·²å®Œæˆä»»åŠ¡: $CLOSED_ISSUES"
          
          # æ£€æŸ¥æ¯ä¸ª pending ä»»åŠ¡çš„ä¾èµ–æ˜¯å¦æ»¡è¶³
          READY_ISSUES="[]"
          
          for row in $(echo "$PENDING_ISSUES" | jq -r '.[] | @base64'); do
            _jq() {
              echo ${row} | base64 --decode | jq -r ${1}
            }
            
            ISSUE_NUM=$(_jq '.number')
            ISSUE_BODY=$(_jq '.body')
            
            # è§£æä¾èµ–: "Depends on: #X, #Y" æˆ– "ä¾èµ–"
            DEPS=$(echo "$ISSUE_BODY" | grep -oP 'Depends on:.*?#\K\d+' | tr '\n' ',' | sed 's/,$//')
            
            if [ -z "$DEPS" ]; then
              # æ— ä¾èµ–ï¼Œç›´æ¥å°±ç»ª
              echo "  #$ISSUE_NUM: æ— ä¾èµ– â†’ å°±ç»ª"
              READY_ISSUES=$(echo "$READY_ISSUES" | jq --argjson num "$ISSUE_NUM" '. + [$num]')
            else
              # æ£€æŸ¥æ‰€æœ‰ä¾èµ–æ˜¯å¦éƒ½å·²å…³é—­
              ALL_SATISFIED=true
              for DEP in $(echo "$DEPS" | tr ',' ' '); do
                if ! echo ",$CLOSED_ISSUES," | grep -q ",$DEP,"; then
                  echo "  #$ISSUE_NUM: ä¾èµ– #$DEP æœªå®Œæˆ"
                  ALL_SATISFIED=false
                  break
                fi
              done
              
              if [ "$ALL_SATISFIED" = true ]; then
                echo "  #$ISSUE_NUM: æ‰€æœ‰ä¾èµ–å·²æ»¡è¶³ â†’ å°±ç»ª"
                READY_ISSUES=$(echo "$READY_ISSUES" | jq --argjson num "$ISSUE_NUM" '. + [$num]')
              fi
            fi
          done
          
          echo "å°±ç»ªä»»åŠ¡: $READY_ISSUES"
          echo "issues=$READY_ISSUES" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
          OPEN_COUNT=$(echo "$SUB_ISSUES" | jq '[.[] | select(.state == "OPEN")] | length')
          echo "open_count=$OPEN_COUNT" >> $GITHUB_OUTPUT

      - name: Dispatch workers
        if: steps.ready.outputs.issues != '[]'
        env:
          GH_TOKEN: ${{ secrets.DAG_DISPATCH_TOKEN }}
        run: |
          READY_ISSUES='${{ steps.ready.outputs.issues }}'
          PR_NUMBER="${{ steps.signal.outputs.pr_number }}"
          PARENT_ISSUE="${{ steps.signal.outputs.parent_issue }}"
          
          # é™åˆ¶å¹¶è¡Œæ•°é‡ä¸º 5
          COUNT=0
          for ISSUE_NUM in $(echo "$READY_ISSUES" | jq -r '.[]'); do
            if [ $COUNT -ge 5 ]; then
              echo "å·²è¾¾åˆ°å¹¶è¡Œä¸Šé™ (5)ï¼Œå‰©ä½™ä»»åŠ¡ç­‰å¾…ä¸‹ä¸€è½®"
              break
            fi
            
            # ğŸ”’ äºŒæ¬¡æ£€æŸ¥ï¼šç¡®ä¿ä»»åŠ¡ä»æ˜¯ pending çŠ¶æ€ï¼ˆé˜²æ­¢å¹¶å‘é‡å¤è§¦å‘ï¼‰
            CURRENT_LABELS=$(gh issue view "$ISSUE_NUM" --json labels -q '.labels[].name' | tr '\n' ',')
            if [[ "$CURRENT_LABELS" != *"pending"* ]]; then
              echo "â­ï¸ è·³è¿‡ #$ISSUE_NUM: å·²ä¸æ˜¯ pending çŠ¶æ€ (å½“å‰: $CURRENT_LABELS)"
              continue
            fi
            
            # å…ˆæ›´æ–°æ ‡ç­¾ï¼ˆåŸå­æ“ä½œï¼Œä½œä¸ºé”ï¼‰
            echo "ğŸ”’ é”å®š #$ISSUE_NUM..."
            gh issue edit "$ISSUE_NUM" \
              --remove-label "pending" \
              --add-label "in-progress"
            
            echo "ğŸš€ è§¦å‘ Worker å¤„ç† #$ISSUE_NUM..."
            
            # ä½¿ç”¨ PAT è§¦å‘ workflow
            gh workflow run task-worker.md \
              --field issue_number="$ISSUE_NUM" \
              --field pr_number="$PR_NUMBER" \
              --field parent_issue="$PARENT_ISSUE"
            
            COUNT=$((COUNT + 1))
          done
          
          echo "å·²è§¦å‘ $COUNT ä¸ª Worker"

      - name: Check completion
        if: steps.ready.outputs.open_count == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PARENT_ISSUE: ${{ steps.signal.outputs.parent_issue }}
          PR_NUMBER: ${{ steps.signal.outputs.pr_number }}
        run: |
          echo "ğŸ‰ æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼"
          
          gh issue comment "$PARENT_ISSUE" \
            --body "## ğŸ‰ DAG æ‰§è¡Œå®Œæˆï¼

          æ‰€æœ‰å­ä»»åŠ¡å·²å®Œæˆã€‚

          **PR å¯ä¾›å®¡æ‰¹**: #$PR_NUMBER

          ---
          > ğŸ¤– DAG Dispatcher"

name: "PR Builder - Dispatch Trigger"

on:
  repository_dispatch:
    types: [build-pr]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: "pr-builder-${{ github.event.client_payload.pr_number }}"
  cancel-in-progress: true

run-name: "Build PR #${{ github.event.client_payload.pr_number }}"

jobs:
  build:
    runs-on: [self-hosted, windows, verse-builder]

    steps:
      - name: Display PR Info
        shell: pwsh
        run: |
          Write-Host "PR Number: ${{ github.event.client_payload.pr_number }}"
          Write-Host "PR Title: ${{ github.event.client_payload.pr_title }}"
          Write-Host "Head Ref: ${{ github.event.client_payload.head_ref }}"

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.head_ref }}
          fetch-depth: 0

      - name: Check for Verse files
        id: check_files
        shell: pwsh
        run: |
          # 获取 PR 的文件变更列表
          git fetch origin main:main
          $changedFiles = git diff --name-only main..HEAD
          
          Write-Host "Changed files:"
          $changedFiles | ForEach-Object { Write-Host "  - $_" }
          
          # 检查是否包含 .verse 文件或 Verse 相关目录
          $hasVerseFiles = $changedFiles | Where-Object { 
            $_ -match '\.verse$' -or 
            $_ -match '^UEFNgame/' -or
            $_ -match 'verse-cli/'
          }
          
          if ($hasVerseFiles) {
            Write-Host "Found Verse-related files, will proceed with build"
            echo "should_build=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No Verse files found, skipping build"
            echo "should_build=false" >> $env:GITHUB_OUTPUT
          }

      - name: Skip Build Comment
        if: steps.check_files.outputs.should_build == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: '## ⏭️ Build Skipped\n\nNo Verse code changes detected. Build skipped automatically.\n\n*Changed files do not include `.verse` files or Verse-related directories.*'
            });

      - name: Run Verse Build Script
        if: steps.check_files.outputs.should_build == 'true'
        id: build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          $env:UEFN_REPO_PATH = "E:\Game\FishTycoon\Content\AgentWorkSpace\VibeCodingCN"
          $buildScript = ".\i18n\zh\skills\verseDev\verse-cli\verse-build.ps1"

          if (Test-Path $buildScript) {
            try {
              $output = & $buildScript 2>&1 | Out-String
              $exitCode = $LASTEXITCODE
              $output | Out-File -FilePath "build_output.txt" -Encoding utf8

              if ($exitCode -eq 0) {
                echo "build_success=true" >> $env:GITHUB_OUTPUT
                echo "Build succeeded"
              } else {
                echo "build_success=false" >> $env:GITHUB_OUTPUT
                echo "Build failed with exit code: $exitCode"
              }
            } catch {
              $_.Exception.Message | Out-File -FilePath "build_output.txt" -Encoding utf8
              echo "build_success=false" >> $env:GITHUB_OUTPUT
              echo "Build threw exception: $_"
            }
          } else {
            echo "Build script not found: $buildScript" | Out-File -FilePath "build_output.txt" -Encoding utf8
            echo "build_success=false" >> $env:GITHUB_OUTPUT
            echo "Build script not found"
          }

      - name: Comment on PR - Success
        if: steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let output = 'Build output not available';
            try { output = fs.readFileSync('build_output.txt', 'utf8'); } catch (e) {}
            if (output.length > 60000) output = output.substring(0, 60000) + '\n\n... (truncated)';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: '## Build Succeeded\n\nThe Verse build completed successfully!\n\n<details>\n<summary>Build Output</summary>\n\n```\n' + output + '\n```\n\n</details>\n\n@Maybank01 Please review and merge this PR.'
            });

      - name: Comment on PR - Failure
        if: steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let output = 'Build output not available';
            try { output = fs.readFileSync('build_output.txt', 'utf8'); } catch (e) {}
            if (output.length > 60000) output = output.substring(0, 60000) + '\n\n... (truncated)';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: '## Build Failed\n\n@copilot The build failed. Please analyze the error and fix it:\n\n```\n' + output + '\n```\n\nPlease fix the issues and push a new commit.'
            });

      - name: Fail job if build failed
        if: steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'false'
        shell: pwsh
        run: exit 1

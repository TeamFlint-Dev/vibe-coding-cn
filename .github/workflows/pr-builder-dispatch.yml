name: "PR Builder - Dispatch Trigger"

on:
  repository_dispatch:
    types: [build-pr]

permissions:
  contents: read
  pull-requests: read  # 只需读取权限，评论由 Hub 发表

concurrency:
  group: "pr-builder-${{ github.event.client_payload.pr_number }}"
  cancel-in-progress: true

run-name: "Build PR #${{ github.event.client_payload.pr_number }}"

jobs:
  build:
    runs-on: [self-hosted, windows, verse-builder]

    steps:
      - name: Display PR Info
        shell: pwsh
        run: |
          Write-Host "PR Number: ${{ github.event.client_payload.pr_number }}"
          Write-Host "PR Title: ${{ github.event.client_payload.pr_title }}"
          Write-Host "Head Ref: ${{ github.event.client_payload.head_ref }}"
          Write-Host "Head SHA: ${{ github.event.client_payload.head_sha }}"
          Write-Host "Task ID: ${{ github.event.client_payload.task_id }}"

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.head_ref }}
          fetch-depth: 0

      - name: Check for Verse files
        id: check_files
        shell: pwsh
        run: |
          # 获取 PR 的文件变更列表
          git fetch origin main:main
          $changedFiles = git diff --name-only main..HEAD
          
          Write-Host "Changed files:"
          $changedFiles | ForEach-Object { Write-Host "  - $_" }
          
          # 检查是否包含 .verse 文件或 Verse 相关目录
          $hasVerseFiles = $changedFiles | Where-Object { 
            $_ -match '\.verse$' -or 
            $_ -match '^UEFNgame/' -or
            $_ -match 'verse-cli/'
          }
          
          if ($hasVerseFiles) {
            Write-Host "Found Verse-related files, will proceed with build"
            echo "should_build=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No Verse files found, skipping build"
            echo "should_build=false" >> $env:GITHUB_OUTPUT
          }

      - name: Report Skipped to Hub
        if: steps.check_files.outputs.should_build == 'false'
        shell: pwsh
        env:
          CALLBACK_URL: ${{ secrets.CALLBACK_URL }}
          CALLBACK_SECRET: ${{ secrets.CALLBACK_SECRET }}
        run: |
          $body = @{
            task_id = "${{ github.event.client_payload.task_id }}"
            result = "skipped"
            build_output = "No Verse code changes detected. Build skipped automatically."
          } | ConvertTo-Json -Compress
          
          # 计算签名
          $hmac = New-Object System.Security.Cryptography.HMACSHA256
          $hmac.Key = [Text.Encoding]::UTF8.GetBytes($env:CALLBACK_SECRET)
          $sig = [BitConverter]::ToString($hmac.ComputeHash([Text.Encoding]::UTF8.GetBytes($body))).Replace("-", "").ToLower()
          $signature = "sha256=$sig"
          
          if ($env:CALLBACK_URL) {
            try {
              $headers = @{
                "Content-Type" = "application/json"
                "X-Callback-Signature" = $signature
              }
              Invoke-RestMethod -Uri $env:CALLBACK_URL -Method POST -Body $body -Headers $headers
              Write-Host "Callback sent: skipped"
            } catch {
              Write-Host "Warning: Failed to send callback: $_"
            }
          }

      - name: Run Verse Build Script
        if: steps.check_files.outputs.should_build == 'true'
        id: build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          $env:UEFN_REPO_PATH = "E:\Game\FishTycoon\Content\AgentWorkSpace\VibeCodingCN"
          $buildScript = ".\i18n\zh\skills\verseDev\verse-cli\verse-build.ps1"

          if (Test-Path $buildScript) {
            try {
              $output = & $buildScript 2>&1 | Out-String
              $exitCode = $LASTEXITCODE
              $output | Out-File -FilePath "build_output.txt" -Encoding utf8

              if ($exitCode -eq 0) {
                echo "build_success=true" >> $env:GITHUB_OUTPUT
                echo "Build succeeded"
              } else {
                echo "build_success=false" >> $env:GITHUB_OUTPUT
                echo "Build failed with exit code: $exitCode"
              }
            } catch {
              $_.Exception.Message | Out-File -FilePath "build_output.txt" -Encoding utf8
              echo "build_success=false" >> $env:GITHUB_OUTPUT
              echo "Build threw exception: $_"
            }
          } else {
            echo "Build script not found: $buildScript" | Out-File -FilePath "build_output.txt" -Encoding utf8
            echo "build_success=false" >> $env:GITHUB_OUTPUT
            echo "Build script not found"
          }

      - name: Report Result to Hub
        if: steps.check_files.outputs.should_build == 'true'
        shell: pwsh
        env:
          CALLBACK_URL: ${{ secrets.CALLBACK_URL }}
          CALLBACK_SECRET: ${{ secrets.CALLBACK_SECRET }}
        run: |
          # 读取构建输出
          $buildOutput = ""
          if (Test-Path "build_output.txt") {
            $buildOutput = Get-Content -Path "build_output.txt" -Raw -Encoding utf8
            if ($buildOutput.Length -gt 8000) {
              $buildOutput = $buildOutput.Substring(0, 8000) + "`n`n... (truncated)"
            }
          }
          
          # 确定结果
          $result = if ("${{ steps.build.outputs.build_success }}" -eq "true") { "success" } else { "failure" }
          
          $body = @{
            task_id = "${{ github.event.client_payload.task_id }}"
            result = $result
            build_output = $buildOutput
          } | ConvertTo-Json -Compress
          
          # 计算签名
          $hmac = New-Object System.Security.Cryptography.HMACSHA256
          $hmac.Key = [Text.Encoding]::UTF8.GetBytes($env:CALLBACK_SECRET)
          $sig = [BitConverter]::ToString($hmac.ComputeHash([Text.Encoding]::UTF8.GetBytes($body))).Replace("-", "").ToLower()
          $signature = "sha256=$sig"
          
          if ($env:CALLBACK_URL) {
            try {
              $headers = @{
                "Content-Type" = "application/json"
                "X-Callback-Signature" = $signature
              }
              Invoke-RestMethod -Uri $env:CALLBACK_URL -Method POST -Body $body -Headers $headers
              Write-Host "Callback sent: $result"
            } catch {
              Write-Host "Warning: Failed to send callback: $_"
            }
          }

      - name: Fail job if build failed
        if: steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'false'
        shell: pwsh
        run: exit 1

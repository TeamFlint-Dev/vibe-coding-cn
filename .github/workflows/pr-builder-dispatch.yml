name: "PR Builder - Dispatch Trigger"

on:
  repository_dispatch:
    types: [build-pr]

permissions:
  contents: read
  pull-requests: read  # 只需读取权限，评论由 Hub 发表

concurrency:
  group: "pr-builder-${{ github.event.client_payload.pr_number }}"
  cancel-in-progress: true

run-name: "Build PR #${{ github.event.client_payload.pr_number }}"

jobs:
  build:
    runs-on: [self-hosted, windows, verse-builder]
    # 注意: runner 下载 actions 需要在 runner 启动前配置系统代理
    # job-level env 只对 steps 生效，不影响 actions 下载

    steps:
      - name: Display PR Info
        shell: pwsh
        run: |
          Write-Host "PR Number: ${{ github.event.client_payload.pr_number }}"
          Write-Host "PR Title: ${{ github.event.client_payload.pr_title }}"
          Write-Host "Head Ref: ${{ github.event.client_payload.head_ref }}"
          Write-Host "Head SHA: ${{ github.event.client_payload.head_sha }}"
          Write-Host "Task ID: ${{ github.event.client_payload.task_id }}"

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.head_ref }}
          fetch-depth: 0

      - name: Check for Verse files
        id: check_files
        shell: pwsh
        run: |
          # 获取 PR 的文件变更列表
          git fetch origin main:main
          $changedFiles = git diff --name-only main..HEAD
          
          Write-Host "Changed files:"
          $changedFiles | ForEach-Object { Write-Host "  - $_" }
          
          # 检查是否包含 .verse 文件或 Verse 相关目录
          $hasVerseFiles = $changedFiles | Where-Object { 
            $_ -match '\.verse$' -or 
            $_ -match '^UEFNgame/' -or
            $_ -match 'verse-cli/'
          }
          
          if ($hasVerseFiles) {
            Write-Host "Found Verse-related files, will proceed with build"
            echo "should_build=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No Verse files found, skipping build"
            echo "should_build=false" >> $env:GITHUB_OUTPUT
          }

      - name: Report Skipped to Hub
        if: steps.check_files.outputs.should_build == 'false'
        shell: pwsh
        env:
          CALLBACK_URL: ${{ secrets.CALLBACK_URL }}
          CALLBACK_SECRET: ${{ secrets.CALLBACK_SECRET }}
        run: |
          $body = @{
            task_id = "${{ github.event.client_payload.task_id }}"
            result = "skipped"
            build_output = "No Verse code changes detected. Build skipped automatically."
          } | ConvertTo-Json -Compress
          
          # 计算签名
          $hmac = New-Object System.Security.Cryptography.HMACSHA256
          $hmac.Key = [Text.Encoding]::UTF8.GetBytes($env:CALLBACK_SECRET)
          $sig = [BitConverter]::ToString($hmac.ComputeHash([Text.Encoding]::UTF8.GetBytes($body))).Replace("-", "").ToLower()
          $signature = "sha256=$sig"
          
          if ($env:CALLBACK_URL) {
            # 保存 body 到临时文件避免转义问题
            $body | Out-File -FilePath "callback_body.json" -Encoding utf8 -NoNewline
            
            # 使用 curl.exe 发送请求，--noproxy 绕过代理
            $curlResult = curl.exe --noproxy "*" -s -w "%{http_code}" `
              -X POST "$env:CALLBACK_URL" `
              -H "Content-Type: application/json" `
              -H "X-Callback-Signature: $signature" `
              -d "@callback_body.json"
            
            if ($curlResult -match "2\d\d$") {
              Write-Host "Callback sent: skipped"
            } else {
              Write-Host "Warning: Callback returned: $curlResult"
            }
          }

      - name: Run Verse Build Script
        if: steps.check_files.outputs.should_build == 'true'
        id: build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          
          # 尝试多个可能的脚本位置
          $possiblePaths = @(
            "${{ github.workspace }}\scripts\verse-loop.ps1",
            "E:\Game\FishTycoon\Content\AgentWorkSpace\VibeCodingCN\i18n\zh\skills\verseDev\verse-cli\verse-build.ps1",
            "${{ github.workspace }}\i18n\zh\skills\verseDev\verse-cli\verse-build.ps1"
          )
          
          $buildScript = $null
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              $buildScript = $path
              Write-Host "Found build script: $buildScript"
              break
            }
          }

          if ($buildScript) {
            try {
              $env:UEFN_REPO_PATH = "E:\Game\FishTycoon\Content\AgentWorkSpace\VibeCodingCN"
              $output = & $buildScript 2>&1 | Out-String
              $exitCode = $LASTEXITCODE
              $output | Out-File -FilePath "build_output.txt" -Encoding utf8

              if ($exitCode -eq 0) {
                echo "build_success=true" >> $env:GITHUB_OUTPUT
                Write-Host "Build succeeded"
              } else {
                echo "build_success=false" >> $env:GITHUB_OUTPUT
                Write-Host "Build failed with exit code: $exitCode"
              }
            } catch {
              $_.Exception.Message | Out-File -FilePath "build_output.txt" -Encoding utf8
              echo "build_success=false" >> $env:GITHUB_OUTPUT
              Write-Host "Build threw exception: $_"
            }
          } else {
            $msg = "Build script not found. Tried: $($possiblePaths -join ', ')"
            $msg | Out-File -FilePath "build_output.txt" -Encoding utf8
            echo "build_success=false" >> $env:GITHUB_OUTPUT
            Write-Host $msg
          }

      - name: Report Result to Hub
        if: steps.check_files.outputs.should_build == 'true'
        shell: pwsh
        env:
          CALLBACK_URL: ${{ secrets.CALLBACK_URL }}
          CALLBACK_SECRET: ${{ secrets.CALLBACK_SECRET }}
        run: |
          # 读取构建输出
          $buildOutput = ""
          if (Test-Path "build_output.txt") {
            $buildOutput = Get-Content -Path "build_output.txt" -Raw -Encoding utf8
            if ($buildOutput.Length -gt 8000) {
              $buildOutput = $buildOutput.Substring(0, 8000) + "`n`n... (truncated)"
            }
          }
          
          # 确定结果
          $result = if ("${{ steps.build.outputs.build_success }}" -eq "true") { "success" } else { "failure" }
          
          $body = @{
            task_id = "${{ github.event.client_payload.task_id }}"
            result = $result
            build_output = $buildOutput
          } | ConvertTo-Json -Compress
          
          # 计算签名
          $hmac = New-Object System.Security.Cryptography.HMACSHA256
          $hmac.Key = [Text.Encoding]::UTF8.GetBytes($env:CALLBACK_SECRET)
          $sig = [BitConverter]::ToString($hmac.ComputeHash([Text.Encoding]::UTF8.GetBytes($body))).Replace("-", "").ToLower()
          $signature = "sha256=$sig"
          
          if ($env:CALLBACK_URL) {
            # 保存 body 到临时文件避免转义问题
            $body | Out-File -FilePath "callback_body.json" -Encoding utf8 -NoNewline
            
            # 使用 curl.exe 发送请求，--noproxy 绕过代理
            $curlResult = curl.exe --noproxy "*" -s -w "%{http_code}" `
              -X POST "$env:CALLBACK_URL" `
              -H "Content-Type: application/json" `
              -H "X-Callback-Signature: $signature" `
              -d "@callback_body.json"
            
            if ($curlResult -match "2\d\d$") {
              Write-Host "Callback sent: $result"
            } else {
              Write-Host "Warning: Callback returned: $curlResult"
            }
          }

      - name: Fail job if build failed
        if: steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'false'
        shell: pwsh
        run: exit 1

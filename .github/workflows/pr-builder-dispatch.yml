name: "PR Builder - Dispatch Trigger"

on:
  repository_dispatch:
    types: [build-pr]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: "pr-builder-${{ github.event.client_payload.pr_number }}"
  cancel-in-progress: true

run-name: "Build PR #${{ github.event.client_payload.pr_number }}"

jobs:
  build:
    runs-on: [self-hosted, windows, verse-builder]

    steps:
      - name: Display PR Info
        shell: pwsh
        run: |
          Write-Host "PR Number: ${{ github.event.client_payload.pr_number }}"
          Write-Host "PR Title: ${{ github.event.client_payload.pr_title }}"
          Write-Host "Head Ref: ${{ github.event.client_payload.head_ref }}"
          Write-Host "Head SHA: ${{ github.event.client_payload.head_sha }}"

      - name: Check for duplicate run
        id: check_duplicate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const headSha = '${{ github.event.client_payload.head_sha }}';
            const prNumber = ${{ github.event.client_payload.pr_number }};
            
            if (!headSha) {
              console.log('No head_sha provided, proceeding with build');
              return 'proceed';
            }
            
            // 检查是否已有包含此 SHA 的评论
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 20
            });
            
            const shaMarker = `<!-- build-sha: ${headSha} -->`;
            const hasDuplicate = comments.data.some(c => c.body.includes(shaMarker));
            
            if (hasDuplicate) {
              console.log(`Found existing comment for SHA ${headSha.substring(0, 7)}, skipping`);
              return 'skip';
            }
            
            console.log(`No duplicate found for SHA ${headSha.substring(0, 7)}, proceeding`);
            return 'proceed';
          result-encoding: string

      - name: Skip duplicate notification
        if: steps.check_duplicate.outputs.result == 'skip'
        shell: pwsh
        run: |
          Write-Host "Skipping duplicate build for same commit SHA"
          exit 0

      - name: Checkout PR branch
        if: steps.check_duplicate.outputs.result != 'skip'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.head_ref }}
          fetch-depth: 0

      - name: Check for Verse files
        if: steps.check_duplicate.outputs.result != 'skip'
        id: check_files
        shell: pwsh
        run: |
          # 获取 PR 的文件变更列表
          git fetch origin main:main
          $changedFiles = git diff --name-only main..HEAD
          
          Write-Host "Changed files:"
          $changedFiles | ForEach-Object { Write-Host "  - $_" }
          
          # 检查是否包含 .verse 文件或 Verse 相关目录
          $hasVerseFiles = $changedFiles | Where-Object { 
            $_ -match '\.verse$' -or 
            $_ -match '^UEFNgame/' -or
            $_ -match 'verse-cli/'
          }
          
          if ($hasVerseFiles) {
            Write-Host "Found Verse-related files, will proceed with build"
            echo "should_build=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No Verse files found, skipping build"
            echo "should_build=false" >> $env:GITHUB_OUTPUT
          }

      - name: Skip Build Comment
        if: steps.check_duplicate.outputs.result != 'skip' && steps.check_files.outputs.should_build == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const headSha = '${{ github.event.client_payload.head_sha }}' || 'unknown';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: `## ⏭️ Build Skipped\n\nNo Verse code changes detected. Build skipped automatically.\n\n*Changed files do not include \`.verse\` files or Verse-related directories.*\n\n<!-- build-sha: ${headSha} -->`
            });

      - name: Run Verse Build Script
        if: steps.check_duplicate.outputs.result != 'skip' && steps.check_files.outputs.should_build == 'true'
        id: build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          $env:UEFN_REPO_PATH = "E:\Game\FishTycoon\Content\AgentWorkSpace\VibeCodingCN"
          $buildScript = ".\i18n\zh\skills\verseDev\verse-cli\verse-build.ps1"

          if (Test-Path $buildScript) {
            try {
              $output = & $buildScript 2>&1 | Out-String
              $exitCode = $LASTEXITCODE
              $output | Out-File -FilePath "build_output.txt" -Encoding utf8

              if ($exitCode -eq 0) {
                echo "build_success=true" >> $env:GITHUB_OUTPUT
                echo "Build succeeded"
              } else {
                echo "build_success=false" >> $env:GITHUB_OUTPUT
                echo "Build failed with exit code: $exitCode"
              }
            } catch {
              $_.Exception.Message | Out-File -FilePath "build_output.txt" -Encoding utf8
              echo "build_success=false" >> $env:GITHUB_OUTPUT
              echo "Build threw exception: $_"
            }
          } else {
            echo "Build script not found: $buildScript" | Out-File -FilePath "build_output.txt" -Encoding utf8
            echo "build_success=false" >> $env:GITHUB_OUTPUT
            echo "Build script not found"
          }

      - name: Comment on PR - Success
        if: steps.check_duplicate.outputs.result != 'skip' && steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const headSha = '${{ github.event.client_payload.head_sha }}' || 'unknown';
            let output = 'Build output not available';
            try { output = fs.readFileSync('build_output.txt', 'utf8'); } catch (e) {}
            if (output.length > 60000) output = output.substring(0, 60000) + '\n\n... (truncated)';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: `## ✅ Build Succeeded\n\nThe Verse build completed successfully!\n\n<details>\n<summary>Build Output</summary>\n\n\`\`\`\n${output}\n\`\`\`\n\n</details>\n\n@Maybank01 Please review and merge this PR.\n\n<!-- build-sha: ${headSha} -->`
            });

      - name: Comment on PR - Failure (System Notification)
        if: steps.check_duplicate.outputs.result != 'skip' && steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'false'
        id: failure_comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const headSha = '${{ github.event.client_payload.head_sha }}' || 'unknown';
            let output = 'Build output not available';
            try { output = fs.readFileSync('build_output.txt', 'utf8'); } catch (e) {}
            if (output.length > 60000) output = output.substring(0, 60000) + '\n\n... (truncated)';

            // 系统评论：仅记录构建失败信息，不@copilot
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: `## ❌ Build Failed\n\nThe Verse build failed. See error details below:\n\n\`\`\`\n${output}\n\`\`\`\n\n*Requesting Copilot assistance via webhook...*\n\n<!-- build-sha: ${headSha} -->`
            });
            
            // 返回构建输出供 webhook 使用
            core.setOutput('build_output', output);

      - name: Request Copilot Fix via Webhook
        if: steps.check_duplicate.outputs.result != 'skip' && steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'false'
        shell: pwsh
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          # 读取构建输出
          $buildOutput = ""
          if (Test-Path "build_output.txt") {
            $buildOutput = Get-Content -Path "build_output.txt" -Raw -Encoding utf8
            if ($buildOutput.Length -gt 8000) {
              $buildOutput = $buildOutput.Substring(0, 8000) + "`n`n... (truncated)"
            }
          }
          
          # 构建请求体
          $body = @{
            event_type = "copilot-fix-request"
            pr_number = ${{ github.event.client_payload.pr_number }}
            head_ref = "${{ github.event.client_payload.head_ref }}"
            head_sha = "${{ github.event.client_payload.head_sha }}"
            build_output = $buildOutput
          } | ConvertTo-Json -Depth 10
          
          # 发送到 webhook 服务器
          if ($env:WEBHOOK_URL) {
            try {
              $response = Invoke-RestMethod -Uri "$env:WEBHOOK_URL/copilot-request" -Method POST -Body $body -ContentType "application/json"
              Write-Host "Webhook response: $response"
            } catch {
              Write-Host "Warning: Failed to send webhook request: $_"
              # 不要因为 webhook 失败而导致整个 job 失败
            }
          } else {
            Write-Host "WEBHOOK_URL not configured, skipping Copilot request"
          }

      - name: Fail job if build failed
        if: steps.check_duplicate.outputs.result != 'skip' && steps.check_files.outputs.should_build == 'true' && steps.build.outputs.build_success == 'false'
        shell: pwsh
        run: exit 1

# PR Builder - Dispatch Trigger Workflow
#
# This workflow is triggered by repository_dispatch events from the external
# Webhook service, bypassing GitHub's Copilot workflow approval requirement.

name: "PR Builder - Dispatch Trigger"

on:
  repository_dispatch:
    types: [build-pr]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: "pr-builder-${{ github.event.client_payload.pr_number }}"
  cancel-in-progress: true

run-name: "Build PR #${{ github.event.client_payload.pr_number }}"

jobs:
  build:
    runs-on: [self-hosted, windows, verse-builder]
    
    steps:
      - name: Display PR Info
        run: |
          echo "PR Number: ${{ github.event.client_payload.pr_number }}"
          echo "PR Title: ${{ github.event.client_payload.pr_title }}"
          echo "Head Ref: ${{ github.event.client_payload.head_ref }}"
        shell: bash

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.head_ref }}
          fetch-depth: 0

      - name: Run Verse Build Script
        id: build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          
          # Set UEFN repository path environment variable
          $env:UEFN_REPO_PATH = "E:\Game\FishTycoon\Content\AgentWorkSpace\VibeCodingCN"
          
          # Build script path
          $buildScript = ".\i18n\zh\skills\verseDev\verse-cli\verse-build.ps1"
          
          if (Test-Path $buildScript) {
            try {
              $output = & $buildScript 2>&1 | Out-String
              $exitCode = $LASTEXITCODE
              
              # Save output for PR comment
              $output | Out-File -FilePath "build_output.txt" -Encoding utf8
              
              if ($exitCode -eq 0) {
                echo "build_success=true" >> $env:GITHUB_OUTPUT
                echo "Build succeeded"
              } else {
                echo "build_success=false" >> $env:GITHUB_OUTPUT
                echo "Build failed with exit code: $exitCode"
              }
            } catch {
              $_.Exception.Message | Out-File -FilePath "build_output.txt" -Encoding utf8
              echo "build_success=false" >> $env:GITHUB_OUTPUT
              echo "Build threw exception: $_"
            }
          } else {
            echo "Build script not found: $buildScript" | Out-File -FilePath "build_output.txt" -Encoding utf8
            echo "build_success=false" >> $env:GITHUB_OUTPUT
            echo "Build script not found"
          }

      - name: Comment on PR - Success
        if: steps.build.outputs.build_success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let buildOutput = '';
            try {
              buildOutput = fs.readFileSync('build_output.txt', 'utf8');
            } catch (e) {
              buildOutput = 'Build output not available';
            }
            
            // Truncate if too long
            if (buildOutput.length > 60000) {
              buildOutput = buildOutput.substring(0, 60000) + '\n\n... (truncated)';
            }
            
            const body = `## Build Succeeded

The Verse build completed successfully!

<details>
<summary>Build Output</summary>

\`\`\`
${buildOutput}
\`\`\`

</details>

@Maybank01 Please review and merge this PR.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: body
            });

      - name: Comment on PR - Failure
        if: steps.build.outputs.build_success == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let buildOutput = '';
            try {
              buildOutput = fs.readFileSync('build_output.txt', 'utf8');
            } catch (e) {
              buildOutput = 'Build output not available';
            }
            
            // Truncate if too long
            if (buildOutput.length > 60000) {
              buildOutput = buildOutput.substring(0, 60000) + '\n\n... (truncated)';
            }
            
            const body = `## Build Failed

@copilot The build failed. Please analyze the error and fix it:

\`\`\`
${buildOutput}
\`\`\`

Please fix the issues and push a new commit.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: body
            });

      - name: Fail job if build failed
        if: steps.build.outputs.build_success == 'false'
        run: exit 1
        shell: bash

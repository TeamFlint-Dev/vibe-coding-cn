#  任务控制中心 - Task Control Center
#
# 这是所有任务的统一入口，通过 UI 输入任务目标，选择执行模式
# 然后通过事件系统驱动后续工作流

name: " 任务控制中心"

on:
  workflow_dispatch:
    inputs:
      requirement:
        description: " 任务目标 (详细描述你想要实现的功能)"
        required: true
        type: string
      workflow:
        description: " 工作流类型"
        required: true
        type: choice
        options:
          - "verse-dev"
          - "verse-dev-only"
          - "compile-only"
          - "docs-update"
          - "custom"
        default: "verse-dev"
      execution_mode:
        description: " 执行模式"
        required: true
        type: choice
        options:
          - "auto"
          - "step-by-step"
          - "dry-run"
        default: "auto"
      max_retries:
        description: " 最大重试次数"
        required: false
        type: choice
        options: ["1", "2", "3", "5"]
        default: "3"
      debug:
        description: " 调试模式"
        required: false
        type: boolean
        default: false

env:
  TASK_PREFIX: "task"

jobs:
  initialize:
    name: " 初始化任务"
    runs-on: ubuntu-latest
    outputs:
      task_id: ${{ steps.create-task.outputs.task_id }}
      branch_name: ${{ steps.create-task.outputs.branch_name }}
    steps:
      - name: 生成任务 ID
        id: create-task
        run: |
          TASK_ID="${{ env.TASK_PREFIX }}-$(date +%Y%m%d-%H%M%S)-${{ github.run_number }}"
          BRANCH_NAME="task/$TASK_ID"
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "##  任务信息" >> $GITHUB_STEP_SUMMARY
          echo "| 属性 | 值 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| 任务 ID | \`$TASK_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 分支名 | \`$BRANCH_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 工作流 | ${{ inputs.workflow }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 发起人 | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "###  任务目标" >> $GITHUB_STEP_SUMMARY
          echo "${{ inputs.requirement }}" >> $GITHUB_STEP_SUMMARY

  dispatch:
    name: " 发送任务事件"
    runs-on: ubuntu-latest
    needs: initialize
    steps:
      - name: 发送 task:start 事件
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PAYLOAD=$(jq -n \
            --arg task_id "${{ needs.initialize.outputs.task_id }}" \
            --arg branch_name "${{ needs.initialize.outputs.branch_name }}" \
            --arg requirement "${{ inputs.requirement }}" \
            --arg workflow "${{ inputs.workflow }}" \
            --arg execution_mode "${{ inputs.execution_mode }}" \
            --argjson max_retries ${{ inputs.max_retries }} \
            --argjson debug ${{ inputs.debug }} \
            --arg triggered_by "${{ github.actor }}" \
            --arg run_id "${{ github.run_id }}" \
            '{task_id: $task_id, branch_name: $branch_name, requirement: $requirement, workflow: $workflow, execution_mode: $execution_mode, max_retries: $max_retries, debug: $debug, triggered_by: $triggered_by, run_id: $run_id}')
          
          echo " 发送事件: task:start"
          echo "$PAYLOAD" | jq .
          
          echo "{\"event_type\":\"task:start\",\"client_payload\":$PAYLOAD}" | gh api repos/${{ github.repository }}/dispatches --input -
          
          echo "##  任务已发起" >> $GITHUB_STEP_SUMMARY
          echo "事件 task:start 已发送" >> $GITHUB_STEP_SUMMARY

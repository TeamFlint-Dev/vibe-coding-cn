name: PR Builder
on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.verse'
      - '**/verse/**'

  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to build"
        required: false

jobs:
  build:
    runs-on: [self-hosted, windows, verse-builder]
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Run Verse Build
        id: compile
        shell: pwsh
        continue-on-error: true
        run: |
          $buildScript = "i18n\zh\skills\verseDev\verse-cli\verse-build.ps1"
          
          if (Test-Path $buildScript) {
            $output = & $buildScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          } else {
            $nodeScript = "i18n\zh\skills\verseDev\verse-cli\verse-build.js"
            $output = & node $nodeScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          }
          
          # 保存输出（处理多行）
          $output = $output -replace "`r`n", "%0A" -replace "`n", "%0A"
          "build_output=$output" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "exit_code=$exitCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          if ($exitCode -ne 0) {
            exit 1
          }

      - name: Comment - Build Success
        if: steps.compile.outcome == 'success' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        shell: pwsh
        run: |
          $comment = @"
          ## ✅ Build Success
          
          Local build verification passed!
          
          <details>
          <summary>Build Output</summary>
          
          ``````
          ${{ steps.compile.outputs.build_output }}
          ``````
          
          </details>
          
          @Maybank01 Ready for review.
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body $comment

      - name: Comment - Build Failed
        if: steps.compile.outcome == 'failure' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
          IS_COPILOT: ${{ startsWith(github.event.pull_request.head.ref, 'copilot/') }}
        shell: pwsh
        run: |
          $isCopilot = $env:IS_COPILOT -eq 'true'
          
          if ($isCopilot) {
            $mention = "@copilot Please fix the following build errors:"
          } else {
            $mention = "Build failed. Please fix the following errors:"
          }
          
          $comment = @"
          ## ❌ Build Failed
          
          $mention
          
          ``````
          ${{ steps.compile.outputs.build_output }}
          ``````
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body $comment
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body $comment

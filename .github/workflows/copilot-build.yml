name: Copilot PR Builder
on:
  pull_request:
    types: [opened, synchronize]
    branches-ignore:
      - 'copilot/**'  # Trigger on PR target, not source branch

jobs:
  build:
    # Handle Copilot PRs (from copilot/* branches)
    if: startsWith(github.event.pull_request.head.ref, 'copilot/')
    runs-on: [self-hosted, windows, verse-builder]
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Run Verse Build
        id: compile
        shell: pwsh
        continue-on-error: true
        run: |
          $buildScript = "i18n\zh\skills\verseDev\verse-cli\verse-build.ps1"
          
          if (Test-Path $buildScript) {
            $output = & $buildScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          } else {
            $nodeScript = "i18n\zh\skills\verseDev\verse-cli\verse-build.js"
            $output = & node $nodeScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          }
          
          # 保存输出（处理多行）
          $output = $output -replace "`r`n", "%0A" -replace "`n", "%0A"
          "build_output=$output" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "exit_code=$exitCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          if ($exitCode -ne 0) {
            exit 1
          }

      - name: Comment - Build Success
        if: steps.compile.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        shell: pwsh
        run: |
          $comment = @"
          ## ✅ 编译成功
          
          本地编译验证通过！
          
          <details>
          <summary>编译输出</summary>
          
          ``````
          ${{ steps.compile.outputs.build_output }}
          ``````
          
          </details>
          
          @Maybank01 请审阅此 PR。
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body $comment

      - name: Comment - Build Failed
        if: steps.compile.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        shell: pwsh
        run: |
          $comment = @"
          ## ❌ 编译失败
          
          @copilot 编译未通过，请根据以下错误信息修复代码：
          
          ``````
          ${{ steps.compile.outputs.build_output }}
          ``````
          
          请分析错误原因并推送修复后的代码。
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body $comment

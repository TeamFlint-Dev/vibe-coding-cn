name: PR Builder
on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.verse'
      - '**/verse/**'

  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to build"
        required: false

env:
  UEFN_VERSE_PATH: "E:\\Game\\FishTycoon\\Content\\Verse"
  REPO_VERSE_PATH: "UEFNgame/trophy-fishing/Verse"
  VERSE_CLI_PATH: "i18n\\zh\\skills\\verseDev\\verse-cli"

jobs:
  build:
    runs-on: [self-hosted, windows, verse-builder]
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Sync Verse to UEFN Project
        id: sync
        shell: pwsh
        run: |
          $source = "${{ github.workspace }}\${{ env.REPO_VERSE_PATH }}"
          $dest = "${{ env.UEFN_VERSE_PATH }}"
          
          Write-Host "Syncing Verse code to UEFN project..."
          Write-Host "   Source: $source"
          Write-Host "   Dest: $dest"
          
          if (-not (Test-Path $source)) {
            Write-Host "Source directory does not exist, skipping sync"
            exit 0
          }
          
          if (-not (Test-Path $dest)) {
            New-Item -ItemType Directory -Path $dest -Force | Out-Null
          }
          
          # Use robocopy for sync (mirror mode)
          robocopy $source $dest /MIR /R:3 /W:1 /NFL /NDL /NJH /NJS
          
          # robocopy return codes: 0-7 means success
          if ($LASTEXITCODE -le 7) {
            Write-Host "Sync completed"
          } else {
            Write-Host "::error::Sync failed with code: $LASTEXITCODE"
            exit 1
          }

      - name: Run Verse Build
        id: compile
        shell: pwsh
        continue-on-error: true
        run: |
          $buildScript = "${{ env.VERSE_CLI_PATH }}\verse-build.ps1"
          
          if (Test-Path $buildScript) {
            $output = & $buildScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          } else {
            $nodeScript = "${{ env.VERSE_CLI_PATH }}\verse-build.js"
            $output = & node $nodeScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          }
          
          # 保存输出（处理多行）
          $output = $output -replace "`r`n", "%0A" -replace "`n", "%0A"
          "build_output=$output" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "exit_code=$exitCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          if ($exitCode -ne 0) {
            exit 1
          }

      - name: Comment - Build Success
        if: steps.compile.outcome == 'success' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        shell: pwsh
        run: |
          $comment = @"
          ## ✅ Build Success
          
          Local build verification passed!
          
          <details>
          <summary>Build Output</summary>
          
          ``````
          ${{ steps.compile.outputs.build_output }}
          ``````
          
          </details>
          
          @Maybank01 Ready for review.
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body $comment

      - name: Comment - Build Failed
        if: steps.compile.outcome == 'failure' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
          IS_COPILOT: ${{ startsWith(github.event.pull_request.head.ref, 'copilot/') }}
        shell: pwsh
        run: |
          $isCopilot = $env:IS_COPILOT -eq 'true'
          
          if ($isCopilot) {
            $mention = "@copilot Please fix the following build errors:"
          } else {
            $mention = "Build failed. Please fix the following errors:"
          }
          
          $comment = @"
          ## ❌ Build Failed
          
          $mention
          
          ``````
          ${{ steps.compile.outputs.build_output }}
          ``````
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body $comment
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body $comment

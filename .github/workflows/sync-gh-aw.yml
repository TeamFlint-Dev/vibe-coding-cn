# æ¯æ—¥åŒæ­¥ gh-aw å®˜æ–¹ä»“åº“
# 
# åŠŸèƒ½ï¼š
# - ä» githubnext/gh-aw æ‹‰å–æœ€æ–°çš„ skills/workflows/agents/aw
# - åŒæ­¥åˆ°æœ¬åœ° gh-aw-raw ç›®å½•å’Œ .github/agents/gh-aw-official/
# - ç¼–è¯‘é¡¹ç›®å·¥ä½œæµ
# - åŒæ­¥å¤±è´¥æ—¶åˆ›å»º Issue é€šçŸ¥
#
# è§¦å‘æ–¹å¼ï¼š
# - æ¯æ—¥ UTC 6:00 (åŒ—äº¬ 14:00) å®šæ—¶æ‰§è¡Œ
# - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)

name: Sync gh-aw

on:
  schedule:
    # æ¯å¤© UTC 6:00 (åŒ—äº¬æ—¶é—´ 14:00)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ä»…é¢„è§ˆï¼Œä¸å®é™…åŒæ­¥'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"

      - name: Sync gh-aw files
        id: sync
        shell: pwsh
        run: |
          $dryRun = "${{ github.event.inputs.dry_run }}" -eq "true"
          
          if ($dryRun) {
            Write-Host "=== DRY RUN MODE ===" -ForegroundColor Yellow
            ./scripts/sync-gh-aw.ps1 -DryRun
          } else {
            ./scripts/sync-gh-aw.ps1
          }

      - name: Install gh-aw extension
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          gh extension install githubnext/gh-aw || true
          gh aw version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compile workflows
        if: ${{ github.event.inputs.dry_run != 'true' }}
        shell: pwsh
        run: |
          ./scripts/compile-gh-aw.ps1 -Strict

      - name: Check for changes
        id: check_changes
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="chore: sync gh-aw from official repo

          Synced at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Source: githubnext/gh-aw@main
          
          Directories synced:
          - skills/ â†’ gh-aw-raw/skills/
          - workflows/ â†’ gh-aw-raw/workflows/
          - agents/ â†’ .github/agents/gh-aw-official/
          - aw/ â†’ gh-aw-raw/aw/"
          
          git commit -m "$COMMIT_MSG"
          git push

      - name: Create failure issue
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "[Sync Failed] gh-aw åŒæ­¥å¤±è´¥ - $(date +%Y-%m-%d)" \
            --body "## ğŸ”´ gh-aw åŒæ­¥å¤±è´¥é€šçŸ¥

          ### åŸºæœ¬ä¿¡æ¯
          - **æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
          - **Run ID**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### é—®é¢˜æ’æŸ¥
          è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—æ’æŸ¥é—®é¢˜ï¼š
          1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
          2. githubnext/gh-aw ä»“åº“æ˜¯å¦å¯è®¿é—®
          3. è„šæœ¬æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
          
          ### ç›¸å…³æ–‡ä»¶
          - åŒæ­¥è„šæœ¬: \`scripts/sync-gh-aw.ps1\`
          - ç¼–è¯‘è„šæœ¬: \`scripts/compile-gh-aw.ps1\`
          - å·¥ä½œæµ: \`.github/workflows/sync-gh-aw.yml\`
          " \
            --label "sync-failure,automated"

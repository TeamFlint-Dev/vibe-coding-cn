name: Compile gh-aw Workflow

on:
  workflow_dispatch:
    inputs:
      workflow_file:
        description: 'Workflow markdown file to compile (e.g., workflow-case-study.md)'
        required: true
        default: 'workflow-case-study.md'

permissions:
  contents: write
  pull-requests: write

jobs:
  compile:
    name: Compile Workflow
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup gh CLI
        uses: cli/gh-extension-precompile@v2
        with:
          args: install githubnext/gh-aw
        continue-on-error: true
        
      - name: Install gh-aw via direct download
        if: steps.setup-gh.outcome != 'success'
        run: |
          # Try to install gh-aw extension
          gh extension install githubnext/gh-aw || true
          
      - name: Compile workflow
        run: |
          cd .github/workflows
          gh aw compile ${{ github.event.inputs.workflow_file }}
          
      - name: Commit compiled workflow
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          LOCK_FILE="${{ github.event.inputs.workflow_file/.md/.lock.yml }}"
          
          if git diff --quiet .github/workflows/$LOCK_FILE; then
            echo "No changes to commit"
          else
            git add .github/workflows/$LOCK_FILE
            git commit -m "chore: compile ${{ github.event.inputs.workflow_file }} to lock file"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

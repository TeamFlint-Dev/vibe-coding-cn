# Verse Local Build - Self-Hosted Runner 本地编译工作流
#
# 架构：事件驱动 + 本地编译服务
# - 监听 compile:request 事件
# - 本地 Runner 执行编译验证
# - 编译完成后发送 compile:complete 事件回调

name: "🔨 本地编译"

on:
  # 事件驱动：监听编译请求
  repository_dispatch:
    types: [compile:request]

  # 保留 PR 触发 (向后兼容)
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.verse'
      - '**/verse/**'

  # 支持手动触发
  workflow_dispatch:
    inputs:
      branch:
        description: "分支名称"
        required: false
        default: ""
      task_id:
        description: "任务 ID"
        required: false
        default: ""
      requirement:
        description: "任务需求 (用于修复上下文)"
        required: false
        default: ""
      retry_count:
        description: "当前重试次数"
        required: false
        default: "0"
      max_retries:
        description: "最大重试次数"
        required: false
        default: "3"

# 确保同一时间只有一个编译任务运行
concurrency:
  group: verse-local-build-${{ github.event.client_payload.branch_name || github.head_ref || github.ref_name }}
  cancel-in-progress: false

env:
  VERSE_CLI_PATH: "i18n/zh/skills/verseDev/verse-cli/verse-build.js"
  # UEFN 项目 Verse 代码目录 (本地路径)
  UEFN_VERSE_PATH: "E:\\Game\\FishTycoon\\Content\\Verse"
  # 仓库中的 Verse 源码路径
  REPO_VERSE_PATH: "UEFNgame\\trophy-fishing\\Verse"

jobs:
  local-build:
    # 运行在本地 Self-Hosted Runner
    runs-on: [self-hosted, windows]
    timeout-minutes: 20

    permissions:
      contents: write
      pull-requests: write
      actions: write

    outputs:
      build_result: ${{ steps.build.outputs.result }}
      build_errors: ${{ steps.build.outputs.errors }}

    steps:
      # ============================================
      # 0. 解析事件参数
      # ============================================
      - name: 解析参数
        id: params
        shell: powershell
        run: |
          # 从不同事件源获取参数
          $branchName = "${{ github.event.client_payload.branch_name }}"
          if (-not $branchName) { $branchName = "${{ inputs.branch }}" }
          if (-not $branchName) { $branchName = "${{ github.head_ref }}" }
          if (-not $branchName) { $branchName = "${{ github.ref_name }}" }
          
          $taskId = "${{ github.event.client_payload.task_id }}"
          if (-not $taskId) { $taskId = "${{ inputs.task_id }}" }
          if (-not $taskId) { $taskId = "manual-$(Get-Date -Format 'yyyyMMdd-HHmmss')" }
          
          $requirement = "${{ github.event.client_payload.requirement }}"
          if (-not $requirement) { $requirement = "${{ inputs.requirement }}" }
          
          $retryCount = "${{ github.event.client_payload.retry_count }}"
          if (-not $retryCount) { $retryCount = "${{ inputs.retry_count }}" }
          if (-not $retryCount) { $retryCount = "0" }
          
          $maxRetries = "${{ github.event.client_payload.max_retries }}"
          if (-not $maxRetries) { $maxRetries = "${{ inputs.max_retries }}" }
          if (-not $maxRetries) { $maxRetries = "3" }
          
          "branch_name=$branchName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "task_id=$taskId" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "requirement=$requirement" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "retry_count=$retryCount" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "max_retries=$maxRetries" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          Write-Host "📋 任务参数:"
          Write-Host "   分支: $branchName"
          Write-Host "   任务ID: $taskId"
          Write-Host "   重试: $retryCount / $maxRetries"

      # ============================================
      # 1. 准备环境
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.params.outputs.branch_name }}
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ============================================
      # 1.5 同步 Verse 代码到 UEFN 项目
      # ============================================
      - name: Validate File Names
        id: validate
        shell: powershell
        run: |
          $versePath = "${{ github.workspace }}\${{ env.REPO_VERSE_PATH }}"
          Write-Host "🔍 检查文件名是否包含违规字符..."
          
          if (Test-Path $versePath) {
            $invalidFiles = Get-ChildItem -Path $versePath -Recurse -File | 
              Where-Object { $_.Name -match '[-\s]' }
            
            if ($invalidFiles) {
              Write-Host "::error:: 发现包含违规字符的文件名 (- 或空格):"
              $invalidFiles | ForEach-Object { Write-Host "   - $($_.FullName)" }
              'valid=false' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              exit 1
            }
          }
          
          Write-Host " 文件名检查通过"
          'valid=true' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Sync Verse to UEFN Project
        id: sync
        shell: powershell
        run: |
          $source = "${{ github.workspace }}\${{ env.REPO_VERSE_PATH }}"
          $dest = "${{ env.UEFN_VERSE_PATH }}"
          
          Write-Host " 同步 Verse 代码到 UEFN 项目..."
          Write-Host "   源: $source"
          Write-Host "   目标: $dest"
          
          if (-not (Test-Path $source)) {
            Write-Host " 源目录不存在，跳过同步"
            'synced=skipped' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 0
          }
          
          # 确保目标目录存在
          if (-not (Test-Path $dest)) {
            New-Item -ItemType Directory -Path $dest -Force | Out-Null
          }
          
          # 使用 robocopy 同步 (镜像模式)
          robocopy $source $dest /MIR /R:3 /W:1 /NFL /NDL /NJH /NJS
          
          # robocopy 返回码: 0-7 表示成功
          if ($LASTEXITCODE -le 7) {
            Write-Host " 同步完成"
            'synced=true' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            Write-Host "::error:: 同步失败，错误码: $LASTEXITCODE"
            'synced=false' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 1
          }

      # ============================================
      # 2. 检查 UEFN 连接
      # ============================================
      - name: Check UEFN Connection
        id: uefn-check
        shell: powershell
        run: |
          $maxAttempts = 5
          $attempt = 0
          $connected = $false

          Write-Host "🔌 Checking UEFN Workflow Server connection..."

          while ($attempt -lt $maxAttempts -and -not $connected) {
            try {
              $tcp = New-Object System.Net.Sockets.TcpClient
              $tcp.Connect("127.0.0.1", 1962)
              $tcp.Close()
              $connected = $true
              Write-Host "✅ UEFN Workflow Server is running on port 1962"
            } catch {
              $attempt++
              Write-Host "⏳ Waiting for UEFN... (attempt $attempt/$maxAttempts)"
              Start-Sleep -Seconds 5
            }
          }

          if (-not $connected) {
            Write-Host "::error::❌ UEFN is not running. Please open UEFN with your project."
            'connected=false' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 1
          }

          'connected=true' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # ============================================
      # 3. 执行 Verse 编译
      # ============================================
      - name: Run Verse Build
        id: build
        shell: powershell
        continue-on-error: true
        run: |
          $buildScript = "${{ github.workspace }}/${{ env.VERSE_CLI_PATH }}"

          Write-Host "🔨 Running Verse compilation..."
          Write-Host "   Script: $buildScript"

          # 运行编译并捕获输出
          $output = ""
          try {
            $output = node $buildScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          } catch {
            $output = $_.Exception.Message
            $exitCode = 1
          }

          # 保存完整输出到文件
          $output | Out-File -FilePath "build-output.txt" -Encoding utf8

          Write-Host "--- Build Output ---"
          Write-Host $output
          Write-Host "--- End Output ---"

          if ($exitCode -eq 0) {
            Write-Host "✅ Build succeeded!"
            'result=success' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            Write-Host "❌ Build failed with exit code: $exitCode"
            'result=failure' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

            # 提取并截断错误信息（保留关键部分）
            $errorOutput = $output
            if ($errorOutput.Length -gt 4000) {
              # 保留开头和结尾的错误信息
              $head = $errorOutput.Substring(0, 2000)
              $tail = $errorOutput.Substring($errorOutput.Length - 1500)
              $errorOutput = "$head`n`n... [truncated] ...`n`n$tail"
            }

            # 转义多行输出
            $escapedOutput = $errorOutput -replace '%', '%25' -replace "`n", '%0A' -replace "`r", ''
            'errors<<EOF' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            $errorOutput | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            'EOF' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }

      # ============================================
      # 4. 上传构建日志
      # ============================================
      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.run_number }}
          path: build-output.txt
          retention-days: 7

      # ============================================
      # 5. 处理构建结果
      # ============================================

      # 5a. 发送编译完成事件 (事件驱动模式)
      - name: 发送 compile:complete 事件
        if: github.event_name == 'repository_dispatch'
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $result = "${{ steps.build.outputs.result }}"
          $errors = ""
          if ($result -ne "success") {
            $errors = Get-Content -Path "build-output.txt" -Raw -ErrorAction SilentlyContinue
            if ($errors.Length -gt 3000) {
              $errors = $errors.Substring(0, 3000) + "... [truncated]"
            }
            $errors = $errors -replace '"', '\"' -replace "`n", '\n' -replace "`r", ''
          }
          
          $payload = @{
            task_id = "${{ steps.params.outputs.task_id }}"
            branch_name = "${{ steps.params.outputs.branch_name }}"
            requirement = "${{ steps.params.outputs.requirement }}"
            status = $result
            errors = $errors
            retry_count = [int]"${{ steps.params.outputs.retry_count }}"
            max_retries = [int]"${{ steps.params.outputs.max_retries }}"
          } | ConvertTo-Json -Compress
          
          Write-Host "📤 发送 compile:complete 事件"
          Write-Host "   状态: $result"
          
          $body = @{event_type="compile:complete";client_payload=$payload} | ConvertTo-Json -Compress; $body | gh api repos/${{ github.repository }}/dispatches --input -

      # 5b. PR 模式：成功评论
      - name: Comment Success on PR
        if: steps.build.outputs.result == 'success' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ✅ Verse Build Succeeded!

            **Runner**: \`${{ runner.name }}\`
            **Commit**: \`${{ github.sha }}\`

            🎉 Code compiled successfully. Ready for review!
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      # 5c. PR 模式：失败时触发修复 (向后兼容)
      - name: Trigger Fix Loop (PR mode)
        if: steps.build.outputs.result == 'failure' && github.event_name == 'pull_request'
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $branchName = "${{ github.head_ref }}"
          if (-not $branchName) { $branchName = "${{ github.ref_name }}" }

          $errors = Get-Content -Path "build-output.txt" -Raw -ErrorAction SilentlyContinue
          if ($errors.Length -gt 4000) {
            $errors = $errors.Substring(0, 4000) + "`n... [truncated]"
          }

          Write-Host "🔄 Triggering verse-dev-loop to fix errors..."
          
          gh workflow run verse-dev-loop.lock.yml `
            --ref "$branchName" `
            -f requirement="Fix compilation errors" `
            -f compile_errors="$errors" `
            -f working_branch="$branchName"

      # 5d. 设置 Job 状态
      - name: Set Job Status
        if: steps.build.outputs.result == 'failure'
        shell: powershell
        run: |
          Write-Host "::error::Build failed. Check the build output for details."
          exit 1

# Verse Local Build - Self-Hosted Runner
#
# Event-driven local compilation workflow
# - Listens for compile:request events
# - Local Runner executes compilation
# - Sends compile:complete callback on finish

name: "Local Build"

on:
  # Event-driven: listen for compile requests
  repository_dispatch:
    types: [compile:request]

  # Keep PR trigger for backward compatibility
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.verse'
      - '**/verse/**'

  # Support manual trigger
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch name"
        required: false
        default: ""
      task_id:
        description: "Task ID"
        required: false
        default: ""

env:
  UEFN_VERSE_PATH: "E:\\Game\\FishTycoon\\Content\\Verse"
  REPO_VERSE_PATH: "UEFNgame/trophy-fishing/Verse"
  VERSE_CLI_PATH: "E:\\Game\\FishTycoon\\Content\\AgentWorkSpace\\vibe_coding\\i18n\\zh\\skills\\verseDev\\verse-cli"

jobs:
  build:
    name: "Verse Build"
    runs-on: [self-hosted, windows, verse-builder]

    outputs:
      result: ${{ steps.build.outputs.result }}
      errors: ${{ steps.build.outputs.errors }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch_name || inputs.branch || github.head_ref || 'main' }}

      - name: Parse event parameters
        id: params
        shell: powershell
        run: |
          $branchName = "${{ github.event.client_payload.branch_name }}"
          if (-not $branchName) { $branchName = "${{ inputs.branch }}" }
          if (-not $branchName) { $branchName = "${{ github.head_ref }}" }
          if (-not $branchName) { $branchName = "main" }

          $taskId = "${{ github.event.client_payload.task_id }}"
          if (-not $taskId) { $taskId = "${{ inputs.task_id }}" }

          $requirement = "${{ github.event.client_payload.requirement }}"

          $retryCount = "${{ github.event.client_payload.retry_count }}"
          if (-not $retryCount) { $retryCount = "0" }

          $maxRetries = "${{ github.event.client_payload.max_retries }}"
          if (-not $maxRetries) { $maxRetries = "${{ inputs.max_retries }}" }
          if (-not $maxRetries) { $maxRetries = "3" }

          "branch_name=$branchName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "task_id=$taskId" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "requirement=$requirement" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "retry_count=$retryCount" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "max_retries=$maxRetries" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          Write-Host "Task parameters:"
          Write-Host "   Branch: $branchName"
          Write-Host "   Task ID: $taskId"
          Write-Host "   Retry: $retryCount / $maxRetries"

      # ============================================
      # 1. Pre-build checks and sync
      # ============================================
      - name: Check filenames for invalid characters
        id: check-files
        shell: powershell
        run: |
          $versePath = "${{ github.workspace }}\${{ env.REPO_VERSE_PATH }}"

          Write-Host "Checking filenames for invalid characters..."
          if (Test-Path $versePath) {
            $invalidFiles = Get-ChildItem -Path $versePath -Recurse -File |
              Where-Object { $_.Name -match '[-\s]' }

            if ($invalidFiles) {
              Write-Host "::error::Found files with invalid characters (- or space):"
              $invalidFiles | ForEach-Object { Write-Host "   - $($_.FullName)" }
              'valid=false' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              exit 1
            }
          }

          Write-Host "Filename check passed"
          'valid=true' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Sync Verse to UEFN Project
        id: sync
        shell: powershell
        run: |
          $source = "${{ github.workspace }}\${{ env.REPO_VERSE_PATH }}"
          $dest = "${{ env.UEFN_VERSE_PATH }}"

          Write-Host "Syncing Verse code to UEFN project..."
          Write-Host "   Source: $source"
          Write-Host "   Dest: $dest"

          if (-not (Test-Path $source)) {
            Write-Host "Source directory does not exist, skipping sync"
            'synced=skipped' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 0
          }

          # Ensure destination directory exists
          if (-not (Test-Path $dest)) {
            New-Item -ItemType Directory -Path $dest -Force | Out-Null
          }

          # Use robocopy for sync (mirror mode)
          robocopy $source $dest /MIR /R:3 /W:1 /NFL /NDL /NJH /NJS

          # robocopy return codes: 0-7 means success
          if ($LASTEXITCODE -le 7) {
            Write-Host "Sync completed"
            'synced=true' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            Write-Host "::error::Sync failed with code: $LASTEXITCODE"
            'synced=false' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 1
          }

      # ============================================
      # 2. Check UEFN connection
      # ============================================
      - name: Check UEFN Connection
        id: uefn-check
        shell: powershell
        run: |
          Write-Host "Checking UEFN connection..."

          # Check if UEFN process is running
          $uefnProcess = Get-Process -Name "UnrealEditor*" -ErrorAction SilentlyContinue

          if (-not $uefnProcess) {
            # Try alternative process names
            $uefnProcess = Get-Process -Name "FortniteClient*" -ErrorAction SilentlyContinue
          }

          if (-not $uefnProcess) {
            Write-Host "::error::UEFN is not running. Please open UEFN with your project."
            'connected=false' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 1
          }

          Write-Host "Found UEFN process: $($uefnProcess.Name)"

          # Test TCP connection to Verse Workflow Server (port 1962)
          try {
            $tcpClient = New-Object System.Net.Sockets.TcpClient
            $tcpClient.Connect("127.0.0.1", 1962)
            $tcpClient.Close()
            Write-Host "Verse Workflow Server is accessible on port 1962"
          } catch {
            Write-Host "::warning::Cannot connect to Verse Workflow Server on port 1962"
          }

          'connected=true' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # ============================================
      # 3. Execute Verse Build
      # ============================================
      - name: Run Verse Build
        id: build
        shell: powershell
        run: |
          Write-Host "Starting Verse build..."

          # Use verse-build.js CLI tool (connects to UEFN via TCP:1962)
          $verseCli = "${{ env.VERSE_CLI_PATH }}\verse-build.js"

          if (-not (Test-Path $verseCli)) {
            Write-Host "::error::Verse CLI not found at: $verseCli"
            'result=failure' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            'errors=Verse CLI tool not found' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 1
          }

          Write-Host "Using Verse CLI: $verseCli"

          # Run verse-build.js
          Push-Location "${{ env.VERSE_CLI_PATH }}"
          try {
            $output = node verse-build.js --push 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          } finally {
            Pop-Location
          }

          Write-Host "--- Build Output ---"
          Write-Host $output
          Write-Host "--- End Output ---"

          if ($exitCode -eq 0) {
            Write-Host "Build succeeded!"
            'result=success' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } elseif ($exitCode -eq 2) {
            Write-Host "::error::UEFN not running or connection failed"
            'result=failure' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            'errors=UEFN not running or connection failed (exit code 2)' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            Write-Host "Build failed with exit code: $exitCode"
            'result=failure' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

            # Extract and truncate error message
            $errorOutput = $output
            if ($errorOutput.Length -gt 4000) {
              $head = $errorOutput.Substring(0, 2000)
              $tail = $errorOutput.Substring($errorOutput.Length - 2000)
              $errorOutput = "$head`n`n... [truncated] ...`n`n$tail"
            }

            'errors<<EOF' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            $errorOutput | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            'EOF' | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }

      # ============================================
      # 4. Upload build logs
      # ============================================
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ${{ github.workspace }}/build.log
            ${{ github.workspace }}/verse_build.log
          if-no-files-found: ignore

  # ============================================
  # Event callback job
  # ============================================
  event_callback:
    name: "Send Event Callback"
    needs: build
    if: always() && (github.event_name == 'repository_dispatch' || inputs.task_id != '')
    runs-on: ubuntu-latest

    steps:
      - name: Send compile:complete event
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
          TASK_ID: ${{ needs.build.outputs.task_id || github.event.client_payload.task_id }}
          BRANCH_NAME: ${{ needs.build.outputs.branch_name || github.event.client_payload.branch_name }}
          REQUIREMENT: ${{ needs.build.outputs.requirement || github.event.client_payload.requirement }}
          RETRY_COUNT: ${{ needs.build.outputs.retry_count || github.event.client_payload.retry_count || '0' }}
          MAX_RETRIES: ${{ needs.build.outputs.max_retries || github.event.client_payload.max_retries || '3' }}
          BUILD_RESULT: ${{ needs.build.outputs.result }}
          BUILD_ERRORS: ${{ needs.build.outputs.errors }}
        run: |
          echo "Sending compile:complete event..."

          # Skip if no task_id (manual trigger without task context)
          if [ -z "$TASK_ID" ]; then
            echo "No task_id, skipping event callback"
            exit 0
          fi

          PAYLOAD=$(jq -n \
            --arg task_id "$TASK_ID" \
            --arg branch_name "$BRANCH_NAME" \
            --arg requirement "$REQUIREMENT" \
            --arg status "$BUILD_RESULT" \
            --arg errors "$BUILD_ERRORS" \
            --arg retry_count "$RETRY_COUNT" \
            --arg max_retries "$MAX_RETRIES" \
            '{task_id: $task_id, branch_name: $branch_name, requirement: $requirement, status: $status, errors: $errors, retry_count: $retry_count, max_retries: $max_retries}')

          echo "Payload: $PAYLOAD"

          echo "{\"event_type\":\"compile:complete\",\"client_payload\":$PAYLOAD}" | \
            gh api repos/${{ github.repository }}/dispatches --input -

          echo "Event sent successfully"

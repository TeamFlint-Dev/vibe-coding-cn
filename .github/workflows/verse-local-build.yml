# Verse Local Build - Self-Hosted Runner æœ¬åœ°ç¼–è¯‘å·¥ä½œæµ
#
# æ¶æ„ï¼šäº‘ç«¯ä¸»æ§ + æœ¬åœ°ç¼–è¯‘æœåŠ¡
# - äº‘ç«¯ Agent (verse-dev-loop) ç”Ÿæˆä»£ç å¹¶æ¨é€åˆ° PR åˆ†æ”¯
# - æœ¬åœ° Runner è‡ªåŠ¨è§¦å‘ç¼–è¯‘éªŒè¯
# - ç¼–è¯‘å¤±è´¥æ—¶ï¼Œåœ¨åŒä¸€åˆ†æ”¯ä¸Šè§¦å‘äº‘ç«¯ Agent ä¿®å¤ï¼ˆæœ€å¤šé‡è¯• 3 æ¬¡ï¼‰
# - ç¼–è¯‘æˆåŠŸåï¼ŒPR å‡†å¤‡å°±ç»ªç­‰å¾…äººå·¥å®¡æ ¸

name: Verse Local Build

on:
  # å½“ PR ä¸­çš„ .verse æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨è§¦å‘
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.verse'
      - '**/verse/**'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to build (leave empty for current branch)"
        required: false
        default: ""
      requirement:
        description: "Original requirement (for retry context)"
        required: false
        default: ""
      retry_count:
        description: "Current retry count (0-3)"
        required: false
        default: "0"

# ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªç¼–è¯‘ä»»åŠ¡è¿è¡Œ
concurrency:
  group: verse-local-build-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: false

env:
  MAX_RETRIES: 3
  VERSE_CLI_PATH: "i18n/zh/skills/verseDev/verse-cli/verse-build.js"

jobs:
  local-build:
    # è¿è¡Œåœ¨æœ¬åœ° Self-Hosted Runner
    runs-on: [self-hosted, windows]
    timeout-minutes: 20

    permissions:
      contents: write
      pull-requests: write
      actions: write

    outputs:
      build_result: ${{ steps.build.outputs.result }}
      build_errors: ${{ steps.build.outputs.errors }}

    steps:
      # ============================================
      # 1. å‡†å¤‡ç¯å¢ƒ
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0
          # å…è®¸åç»­ push
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get retry count
        id: retry
        shell: powershell
        run: |
          $retryCount = "${{ inputs.retry_count }}"
          if (-not $retryCount) { $retryCount = "0" }
          "count=$retryCount" >> $env:GITHUB_OUTPUT
          Write-Host "ğŸ“Š Current retry count: $retryCount / ${{ env.MAX_RETRIES }}"

      # ============================================
      # 2. æ£€æŸ¥ UEFN è¿æ¥
      # ============================================
      - name: Check UEFN Connection
        id: uefn-check
        shell: powershell
        run: |
          $maxAttempts = 5
          $attempt = 0
          $connected = $false

          Write-Host "ğŸ”Œ Checking UEFN Workflow Server connection..."

          while ($attempt -lt $maxAttempts -and -not $connected) {
            try {
              $tcp = New-Object System.Net.Sockets.TcpClient
              $tcp.Connect("127.0.0.1", 1962)
              $tcp.Close()
              $connected = $true
              Write-Host "âœ… UEFN Workflow Server is running on port 1962"
            } catch {
              $attempt++
              Write-Host "â³ Waiting for UEFN... (attempt $attempt/$maxAttempts)"
              Start-Sleep -Seconds 5
            }
          }

          if (-not $connected) {
            Write-Host "::error::âŒ UEFN is not running. Please open UEFN with your project."
            "connected=false" >> $env:GITHUB_OUTPUT
            exit 1
          }

          "connected=true" >> $env:GITHUB_OUTPUT

      # ============================================
      # 3. æ‰§è¡Œ Verse ç¼–è¯‘
      # ============================================
      - name: Run Verse Build
        id: build
        shell: powershell
        continue-on-error: true
        run: |
          $buildScript = "${{ github.workspace }}/${{ env.VERSE_CLI_PATH }}"

          Write-Host "ğŸ”¨ Running Verse compilation..."
          Write-Host "   Script: $buildScript"

          # è¿è¡Œç¼–è¯‘å¹¶æ•è·è¾“å‡º
          $output = ""
          try {
            $output = node $buildScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          } catch {
            $output = $_.Exception.Message
            $exitCode = 1
          }

          # ä¿å­˜å®Œæ•´è¾“å‡ºåˆ°æ–‡ä»¶
          $output | Out-File -FilePath "build-output.txt" -Encoding utf8

          Write-Host "--- Build Output ---"
          Write-Host $output
          Write-Host "--- End Output ---"

          if ($exitCode -eq 0) {
            Write-Host "âœ… Build succeeded!"
            "result=success" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âŒ Build failed with exit code: $exitCode"
            "result=failure" >> $env:GITHUB_OUTPUT

            # æå–å¹¶æˆªæ–­é”™è¯¯ä¿¡æ¯ï¼ˆä¿ç•™å…³é”®éƒ¨åˆ†ï¼‰
            $errorOutput = $output
            if ($errorOutput.Length -gt 4000) {
              # ä¿ç•™å¼€å¤´å’Œç»“å°¾çš„é”™è¯¯ä¿¡æ¯
              $head = $errorOutput.Substring(0, 2000)
              $tail = $errorOutput.Substring($errorOutput.Length - 1500)
              $errorOutput = "$head`n`n... [truncated] ...`n`n$tail"
            }

            # è½¬ä¹‰å¤šè¡Œè¾“å‡º
            $escapedOutput = $errorOutput -replace '%', '%25' -replace "`n", '%0A' -replace "`r", ''
            "errors<<EOF" >> $env:GITHUB_OUTPUT
            $errorOutput >> $env:GITHUB_OUTPUT
            "EOF" >> $env:GITHUB_OUTPUT
          }

      # ============================================
      # 4. ä¸Šä¼ æ„å»ºæ—¥å¿—
      # ============================================
      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.run_number }}
          path: build-output.txt
          retention-days: 7

      # ============================================
      # 5. å¤„ç†æ„å»ºç»“æœ
      # ============================================

      # 5a. æˆåŠŸï¼šåœ¨ PR ä¸­è¯„è®º
      - name: Comment Success on PR
        if: steps.build.outputs.result == 'success' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âœ… Verse Build Succeeded!

            **Runner**: \`${{ runner.name }}\`
            **Commit**: \`${{ github.sha }}\`
            **Retry Count**: ${{ steps.retry.outputs.count }} / ${{ env.MAX_RETRIES }}

            ğŸ‰ Code compiled successfully. Ready for review!
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      # 5b. å¤±è´¥ä¸”æœªè¶…è¿‡é‡è¯•æ¬¡æ•°ï¼šè§¦å‘ä¿®å¤å¾ªç¯
      - name: Trigger Fix Loop
        if: steps.build.outputs.result == 'failure' && steps.retry.outputs.count < env.MAX_RETRIES
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $retryCount = [int]"${{ steps.retry.outputs.count }}" + 1
          $branchName = "${{ github.head_ref }}"
          if (-not $branchName) { $branchName = "${{ github.ref_name }}" }

          $requirement = "${{ inputs.requirement }}"
          if (-not $requirement) {
            $requirement = "Fix compilation errors in the current PR"
          }

          # è¯»å–é”™è¯¯ä¿¡æ¯
          $errors = Get-Content -Path "build-output.txt" -Raw -ErrorAction SilentlyContinue
          if ($errors.Length -gt 4000) {
            $errors = $errors.Substring(0, 4000) + "`n... [truncated]"
          }

          Write-Host "ğŸ”„ Triggering verse-dev-loop to fix errors..."
          Write-Host "   Branch: $branchName"
          Write-Host "   Retry: $retryCount / ${{ env.MAX_RETRIES }}"

          # è§¦å‘äº‘ç«¯ Agent ä¿®å¤ï¼ŒæŒ‡å®šåŒä¸€åˆ†æ”¯ï¼Œä¼ é€’ working_branch é˜²æ­¢åˆ›å»ºæ–°åˆ†æ”¯
          gh workflow run verse-dev-loop.lock.yml `
            --ref "$branchName" `
            -f requirement="$requirement" `
            -f compile_errors="$errors" `
            -f retry_count="$retryCount" `
            -f working_branch="$branchName"

          Write-Host "âœ… Fix workflow triggered on branch: $branchName"

      # 5c. å¤±è´¥ä¸”è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼šæ ‡è®°å¤±è´¥
      - name: Comment Max Retries Exceeded
        if: steps.build.outputs.result == 'failure' && steps.retry.outputs.count >= env.MAX_RETRIES
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âŒ Verse Build Failed - Max Retries Exceeded

            **Runner**: \`${{ runner.name }}\`
            **Commit**: \`${{ github.sha }}\`
            **Retry Count**: ${{ steps.retry.outputs.count }} / ${{ env.MAX_RETRIES }}

            ğŸš« Automatic fix loop has reached the maximum retry limit.

            **Next Steps**:
            1. Review the build logs in the Artifacts
            2. Manually fix the remaining issues
            3. Push your changes to trigger a new build

            <details>
            <summary>Build Errors</summary>

            \`\`\`
            ${{ steps.build.outputs.errors }}
            \`\`\`

            </details>
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request?.number || 0,
              body: body
            });

            // æ·»åŠ å¤±è´¥æ ‡ç­¾
            if (context.payload.pull_request) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['build-failed', 'needs-manual-fix']
              });
            }

      # 5d. è®¾ç½® Job çŠ¶æ€
      - name: Set Job Status
        if: steps.build.outputs.result == 'failure'
        shell: powershell
        run: |
          Write-Host "::error::Build failed. Check the build output for details."
          exit 1

# Verse Local Build - Self-Hosted Runner æœ¬åœ°ç¼–è¯‘å·¥ä½œæµ
#
# æ¶æ„ï¼šäº‹ä»¶é©±åŠ¨ + æœ¬åœ°ç¼–è¯‘æœåŠ¡
# - ç›‘å¬ compile:request äº‹ä»¶
# - æœ¬åœ° Runner æ‰§è¡Œç¼–è¯‘éªŒè¯
# - ç¼–è¯‘å®Œæˆåå‘é€ compile:complete äº‹ä»¶å›è°ƒ

name: "ğŸ”¨ æœ¬åœ°ç¼–è¯‘"

on:
  # äº‹ä»¶é©±åŠ¨ï¼šç›‘å¬ç¼–è¯‘è¯·æ±‚
  repository_dispatch:
    types: [compile:request]

  # ä¿ç•™ PR è§¦å‘ (å‘åå…¼å®¹)
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.verse'
      - '**/verse/**'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      branch:
        description: "åˆ†æ”¯åç§°"
        required: false
        default: ""
      task_id:
        description: "ä»»åŠ¡ ID"
        required: false
        default: ""
      requirement:
        description: "ä»»åŠ¡éœ€æ±‚ (ç”¨äºä¿®å¤ä¸Šä¸‹æ–‡)"
        required: false
        default: ""
      retry_count:
        description: "å½“å‰é‡è¯•æ¬¡æ•°"
        required: false
        default: "0"
      max_retries:
        description: "æœ€å¤§é‡è¯•æ¬¡æ•°"
        required: false
        default: "3"

# ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªç¼–è¯‘ä»»åŠ¡è¿è¡Œ
concurrency:
  group: verse-local-build-${{ github.event.client_payload.branch_name || github.head_ref || github.ref_name }}
  cancel-in-progress: false

env:
  VERSE_CLI_PATH: "i18n/zh/skills/verseDev/verse-cli/verse-build.js"

jobs:
  local-build:
    # è¿è¡Œåœ¨æœ¬åœ° Self-Hosted Runner
    runs-on: [self-hosted, windows]
    timeout-minutes: 20

    permissions:
      contents: write
      pull-requests: write
      actions: write

    outputs:
      build_result: ${{ steps.build.outputs.result }}
      build_errors: ${{ steps.build.outputs.errors }}

    steps:
      # ============================================
      # 0. è§£æäº‹ä»¶å‚æ•°
      # ============================================
      - name: è§£æå‚æ•°
        id: params
        shell: powershell
        run: |
          # ä»ä¸åŒäº‹ä»¶æºè·å–å‚æ•°
          $branchName = "${{ github.event.client_payload.branch_name }}"
          if (-not $branchName) { $branchName = "${{ inputs.branch }}" }
          if (-not $branchName) { $branchName = "${{ github.head_ref }}" }
          if (-not $branchName) { $branchName = "${{ github.ref_name }}" }
          
          $taskId = "${{ github.event.client_payload.task_id }}"
          if (-not $taskId) { $taskId = "${{ inputs.task_id }}" }
          if (-not $taskId) { $taskId = "manual-$(Get-Date -Format 'yyyyMMdd-HHmmss')" }
          
          $requirement = "${{ github.event.client_payload.requirement }}"
          if (-not $requirement) { $requirement = "${{ inputs.requirement }}" }
          
          $retryCount = "${{ github.event.client_payload.retry_count }}"
          if (-not $retryCount) { $retryCount = "${{ inputs.retry_count }}" }
          if (-not $retryCount) { $retryCount = "0" }
          
          $maxRetries = "${{ github.event.client_payload.max_retries }}"
          if (-not $maxRetries) { $maxRetries = "${{ inputs.max_retries }}" }
          if (-not $maxRetries) { $maxRetries = "3" }
          
          "branch_name=$branchName" >> $env:GITHUB_OUTPUT
          "task_id=$taskId" >> $env:GITHUB_OUTPUT
          "requirement=$requirement" >> $env:GITHUB_OUTPUT
          "retry_count=$retryCount" >> $env:GITHUB_OUTPUT
          "max_retries=$maxRetries" >> $env:GITHUB_OUTPUT
          
          Write-Host "ğŸ“‹ ä»»åŠ¡å‚æ•°:"
          Write-Host "   åˆ†æ”¯: $branchName"
          Write-Host "   ä»»åŠ¡ID: $taskId"
          Write-Host "   é‡è¯•: $retryCount / $maxRetries"

      # ============================================
      # 1. å‡†å¤‡ç¯å¢ƒ
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.params.outputs.branch_name }}
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ============================================
      # 2. æ£€æŸ¥ UEFN è¿æ¥
      # ============================================
      - name: Check UEFN Connection
        id: uefn-check
        shell: powershell
        run: |
          $maxAttempts = 5
          $attempt = 0
          $connected = $false

          Write-Host "ğŸ”Œ Checking UEFN Workflow Server connection..."

          while ($attempt -lt $maxAttempts -and -not $connected) {
            try {
              $tcp = New-Object System.Net.Sockets.TcpClient
              $tcp.Connect("127.0.0.1", 1962)
              $tcp.Close()
              $connected = $true
              Write-Host "âœ… UEFN Workflow Server is running on port 1962"
            } catch {
              $attempt++
              Write-Host "â³ Waiting for UEFN... (attempt $attempt/$maxAttempts)"
              Start-Sleep -Seconds 5
            }
          }

          if (-not $connected) {
            Write-Host "::error::âŒ UEFN is not running. Please open UEFN with your project."
            "connected=false" >> $env:GITHUB_OUTPUT
            exit 1
          }

          "connected=true" >> $env:GITHUB_OUTPUT

      # ============================================
      # 3. æ‰§è¡Œ Verse ç¼–è¯‘
      # ============================================
      - name: Run Verse Build
        id: build
        shell: powershell
        continue-on-error: true
        run: |
          $buildScript = "${{ github.workspace }}/${{ env.VERSE_CLI_PATH }}"

          Write-Host "ğŸ”¨ Running Verse compilation..."
          Write-Host "   Script: $buildScript"

          # è¿è¡Œç¼–è¯‘å¹¶æ•è·è¾“å‡º
          $output = ""
          try {
            $output = node $buildScript 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
          } catch {
            $output = $_.Exception.Message
            $exitCode = 1
          }

          # ä¿å­˜å®Œæ•´è¾“å‡ºåˆ°æ–‡ä»¶
          $output | Out-File -FilePath "build-output.txt" -Encoding utf8

          Write-Host "--- Build Output ---"
          Write-Host $output
          Write-Host "--- End Output ---"

          if ($exitCode -eq 0) {
            Write-Host "âœ… Build succeeded!"
            "result=success" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âŒ Build failed with exit code: $exitCode"
            "result=failure" >> $env:GITHUB_OUTPUT

            # æå–å¹¶æˆªæ–­é”™è¯¯ä¿¡æ¯ï¼ˆä¿ç•™å…³é”®éƒ¨åˆ†ï¼‰
            $errorOutput = $output
            if ($errorOutput.Length -gt 4000) {
              # ä¿ç•™å¼€å¤´å’Œç»“å°¾çš„é”™è¯¯ä¿¡æ¯
              $head = $errorOutput.Substring(0, 2000)
              $tail = $errorOutput.Substring($errorOutput.Length - 1500)
              $errorOutput = "$head`n`n... [truncated] ...`n`n$tail"
            }

            # è½¬ä¹‰å¤šè¡Œè¾“å‡º
            $escapedOutput = $errorOutput -replace '%', '%25' -replace "`n", '%0A' -replace "`r", ''
            "errors<<EOF" >> $env:GITHUB_OUTPUT
            $errorOutput >> $env:GITHUB_OUTPUT
            "EOF" >> $env:GITHUB_OUTPUT
          }

      # ============================================
      # 4. ä¸Šä¼ æ„å»ºæ—¥å¿—
      # ============================================
      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.run_number }}
          path: build-output.txt
          retention-days: 7

      # ============================================
      # 5. å¤„ç†æ„å»ºç»“æœ
      # ============================================

      # 5a. å‘é€ç¼–è¯‘å®Œæˆäº‹ä»¶ (äº‹ä»¶é©±åŠ¨æ¨¡å¼)
      - name: å‘é€ compile:complete äº‹ä»¶
        if: github.event_name == 'repository_dispatch'
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $result = "${{ steps.build.outputs.result }}"
          $errors = ""
          if ($result -ne "success") {
            $errors = Get-Content -Path "build-output.txt" -Raw -ErrorAction SilentlyContinue
            if ($errors.Length -gt 3000) {
              $errors = $errors.Substring(0, 3000) + "... [truncated]"
            }
            $errors = $errors -replace '"', '\"' -replace "`n", '\n' -replace "`r", ''
          }
          
          $payload = @{
            task_id = "${{ steps.params.outputs.task_id }}"
            branch_name = "${{ steps.params.outputs.branch_name }}"
            requirement = "${{ steps.params.outputs.requirement }}"
            status = $result
            errors = $errors
            retry_count = [int]"${{ steps.params.outputs.retry_count }}"
            max_retries = [int]"${{ steps.params.outputs.max_retries }}"
          } | ConvertTo-Json -Compress
          
          Write-Host "ğŸ“¤ å‘é€ compile:complete äº‹ä»¶"
          Write-Host "   çŠ¶æ€: $result"
          
          gh api repos/${{ github.repository }}/dispatches `
            -f event_type="compile:complete" `
            -f client_payload="$payload"

      # 5b. PR æ¨¡å¼ï¼šæˆåŠŸè¯„è®º
      - name: Comment Success on PR
        if: steps.build.outputs.result == 'success' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âœ… Verse Build Succeeded!

            **Runner**: \`${{ runner.name }}\`
            **Commit**: \`${{ github.sha }}\`

            ğŸ‰ Code compiled successfully. Ready for review!
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      # 5c. PR æ¨¡å¼ï¼šå¤±è´¥æ—¶è§¦å‘ä¿®å¤ (å‘åå…¼å®¹)
      - name: Trigger Fix Loop (PR mode)
        if: steps.build.outputs.result == 'failure' && github.event_name == 'pull_request'
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $branchName = "${{ github.head_ref }}"
          if (-not $branchName) { $branchName = "${{ github.ref_name }}" }

          $errors = Get-Content -Path "build-output.txt" -Raw -ErrorAction SilentlyContinue
          if ($errors.Length -gt 4000) {
            $errors = $errors.Substring(0, 4000) + "`n... [truncated]"
          }

          Write-Host "ğŸ”„ Triggering verse-dev-loop to fix errors..."
          
          gh workflow run verse-dev-loop.lock.yml `
            --ref "$branchName" `
            -f requirement="Fix compilation errors" `
            -f compile_errors="$errors" `
            -f working_branch="$branchName"

      # 5d. è®¾ç½® Job çŠ¶æ€
      - name: Set Job Status
        if: steps.build.outputs.result == 'failure'
        shell: powershell
        run: |
          Write-Host "::error::Build failed. Check the build output for details."
          exit 1

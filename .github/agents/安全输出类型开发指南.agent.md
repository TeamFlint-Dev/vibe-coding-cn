---
description: ä¸º GitHub Agentic Workflows æ·»åŠ æ–°çš„ Safe Output ç±»å‹
infer: false
---

# æ·»åŠ æ–°çš„ Safe Output ç±»å‹

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä¸º GitHub Agentic Workflows æ·»åŠ æ–°çš„ Safe Output ç±»å‹ï¼Œé€šè¿‡éªŒè¯ç®¡é“ï¼ˆTypeScript ç±»å‹ â†’ JSON Schema â†’ JavaScript æ”¶é›†ï¼‰å¤„ç† JSONL æ ¼å¼çš„ AI Agent è¾“å‡ºã€‚

## å®ç°æ­¥éª¤

### 1. æ›´æ–° JSON Schemaï¼ˆ`schemas/agent-output.json`ï¼‰

åœ¨ `$defs` éƒ¨åˆ†æ·»åŠ å¯¹è±¡å®šä¹‰ï¼š
   ```json
   "YourNewTypeOutput": {
     "title": "Your New Type Output",
     "description": "ä½ çš„æ–°åŠŸèƒ½çš„è¾“å‡º",
     "type": "object",
     "properties": {
       "type": {
         "const": "your-new-type"
       },
       "required_field": {
         "type": "string",
         "description": "å¿…éœ€å­—æ®µçš„æè¿°",
         "minLength": 1
       },
       "optional_field": {
         "type": "string", 
         "description": "å¯é€‰å­—æ®µçš„æè¿°"
       }
     },
     "required": ["type", "required_field"],
     "additionalProperties": false
   }
   ```

æ·»åŠ åˆ° `SafeOutput` oneOf æ•°ç»„ï¼š`{"$ref": "#/$defs/YourNewTypeOutput"}`

**éªŒè¯æ³¨æ„äº‹é¡¹**ï¼šå¯¹ type å­—æ®µä½¿ç”¨ `const`ï¼Œå¯¹å¿…éœ€å­—ç¬¦ä¸²ä½¿ç”¨ `minLength: 1`ï¼Œè®¾ç½® `additionalProperties: false`ï¼Œå¯¹è”åˆç±»å‹ä½¿ç”¨ `oneOf`ã€‚

### 2. æ›´æ–° TypeScript ç±»å‹

**æ–‡ä»¶**ï¼š`pkg/workflow/js/types/safe-outputs.d.ts`
   ```typescript
   /**
    * [æè¿°] çš„ JSONL é¡¹
    */
   interface YourNewTypeItem extends BaseSafeOutputItem {
     type: "your-new-type";
     /** å¿…éœ€å­—æ®µæè¿° */
     required_field: string;
     /** å¯é€‰å­—æ®µæè¿° */
     optional_field?: string;
   }
   ```

æ·»åŠ åˆ° `SafeOutputItem` è”åˆç±»å‹å’Œå¯¼å‡ºåˆ—è¡¨ã€‚

**æ–‡ä»¶**ï¼š`pkg/workflow/js/types/safe-outputs-config.d.ts` - æ·»åŠ é…ç½®æ¥å£ï¼Œæ·»åŠ åˆ° `SpecificSafeOutputConfig` è”åˆç±»å‹ï¼Œå¯¼å‡ºã€‚

### 3. æ›´æ–° Safe Output Tool JSONï¼ˆ`pkg/workflow/js/safe_outputs_tools.json`ï¼‰

æ·»åŠ  Tool ç­¾åä»¥æš´éœ²ç»™ AI Agentï¼š

```json
{
  "name": "your_new_type",
  "description": "æ­¤ Tool åŠŸèƒ½çš„ç®€çŸ­æè¿°ï¼ˆåç§°ä½¿ç”¨ä¸‹åˆ’çº¿ï¼Œä¸ä½¿ç”¨è¿å­—ç¬¦ï¼‰",
  "inputSchema": {
    "type": "object",
    "required": ["required_field"],
    "properties": {
      "required_field": {
        "type": "string",
        "description": "å¿…éœ€å­—æ®µçš„æè¿°"
      },
      "optional_field": {
        "type": "string",
        "description": "å¯é€‰å­—æ®µçš„æè¿°"
      },
      "numeric_field": {
        "type": ["number", "string"],
        "description": "æ¥å—æ•°å­—å’Œå­—ç¬¦ä¸²ç±»å‹çš„æ•°å€¼å­—æ®µ"
      }
    },
    "additionalProperties": false
  }
}
```

**æŒ‡å—**ï¼šTool `name` ä½¿ç”¨ä¸‹åˆ’çº¿ï¼Œä¸ type å­—æ®µåŒ¹é…ï¼Œè®¾ç½® `additionalProperties: false`ï¼Œæ•°å€¼å­—æ®µä½¿ç”¨ `"type": ["number", "string"]`ã€‚

**é‡è¦**ï¼šæ–‡ä»¶é€šè¿‡ `//go:embed` åµŒå…¥ - æ›´æ”¹å**å¿…é¡»é‡æ–°æ„å»º** `make build`ã€‚

### 4. æ›´æ–° MCP Server JavaScriptï¼ˆå¦‚éœ€è‡ªå®šä¹‰å¤„ç†ç¨‹åºï¼‰ï¼ˆ`pkg/workflow/js/safe_outputs_mcp_server.cjs`ï¼‰

å¤§å¤šæ•°ç±»å‹ä½¿ç”¨é»˜è®¤çš„ JSONL å¤„ç†ç¨‹åºã€‚ä»…åœ¨éœ€è¦æ–‡ä»¶æ“ä½œã€git å‘½ä»¤æˆ–å¤æ‚éªŒè¯æ—¶æ·»åŠ è‡ªå®šä¹‰å¤„ç†ç¨‹åºï¼š

```javascript
/**
 * your_new_type Safe Output çš„å¤„ç†ç¨‹åº
 * @param {Object} args - ä¼ é€’ç»™ Tool çš„å‚æ•°
 * @returns {Object} MCP Tool å“åº”
 */
const yourNewTypeHandler = args => {
  // æ‰§è¡Œä»»ä½•è‡ªå®šä¹‰éªŒè¯
  if (!args.required_field || typeof args.required_field !== "string") {
    return {
      content: [
        {
          type: "text",
          text: JSON.stringify({
            error: "required_field æ˜¯å¿…éœ€çš„ä¸”å¿…é¡»æ˜¯å­—ç¬¦ä¸²",
          }),
        },
      ],
      isError: true,
    };
  }

  // æ‰§è¡Œè‡ªå®šä¹‰æ“ä½œï¼ˆä¾‹å¦‚æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€git å‘½ä»¤ï¼‰
  try {
    // ä½ çš„è‡ªå®šä¹‰é€»è¾‘
    const result = performCustomOperation(args);
    
    // å†™å…¥ JSONL æ¡ç›®
    const entry = {
      type: "your_new_type",
      required_field: args.required_field,
      optional_field: args.optional_field,
      // æ·»åŠ æ¥è‡ªè‡ªå®šä¹‰å¤„ç†çš„ä»»ä½•é¢å¤–å­—æ®µ
      result_data: result,
    };
    
    appendSafeOutput(entry);
    
    return {
      content: [
        {
          type: "text",
          text: JSON.stringify({
            success: true,
            message: "ä½ çš„æ–°ç±»å‹å¤„ç†æˆåŠŸ",
            result: result,
          }),
        },
      ],
    };
  } catch (error) {
    return {
      content: [
        {
          type: "text",
          text: JSON.stringify({
            error: error instanceof Error ? error.message : String(error),
          }),
        },
      ],
      isError: true,
    };
  }
};
```

2. **å°†å¤„ç†ç¨‹åºé™„åŠ åˆ° Tool**ï¼ˆçº¦ç¬¬ 570-580 è¡Œï¼‰ï¼š

```javascript
// å°†å¤„ç†ç¨‹åºé™„åŠ åˆ°éœ€è¦å®ƒä»¬çš„ Tool
ALL_TOOLS.forEach(tool => {
  if (tool.name === "create_pull_request") {
    tool.handler = createPullRequestHandler;
  } else if (tool.name === "push_to_pull_request_branch") {
    tool.handler = pushToPullRequestBranchHandler;
  } else if (tool.name === "upload_asset") {
    tool.handler = uploadAssetHandler;
  } else if (tool.name === "your_new_type") {
    tool.handler = yourNewTypeHandler;  // åœ¨æ­¤æ·»åŠ ä½ çš„å¤„ç†ç¨‹åº
  }
});
```

**é»˜è®¤å¤„ç†ç¨‹åº**ï¼šè§„èŒƒåŒ– type å­—æ®µï¼Œå¤„ç†å¤§å†…å®¹ï¼ˆ>16000 tokenï¼‰ï¼Œå†™å…¥ JSONLï¼Œè¿”å›æˆåŠŸã€‚

### 5. æ›´æ–°æ”¶é›† JavaScriptï¼ˆ`pkg/workflow/js/collect_ndjson_output.ts`ï¼‰

åœ¨ä¸» switch è¯­å¥ä¸­æ·»åŠ éªŒè¯ï¼ˆçº¦ç¬¬ 700 è¡Œï¼‰ï¼š

```typescript
case "your-new-type":
  // éªŒè¯å¿…éœ€å­—æ®µ
  if (!item.required_field || typeof item.required_field !== "string") {
    errors.push(`ç¬¬ ${i + 1} è¡Œï¼šyour-new-type éœ€è¦ 'required_field' å­—ç¬¦ä¸²å­—æ®µ`);
    continue;
  }
  
  // å‡€åŒ–æ–‡æœ¬å†…å®¹
  item.required_field = sanitizeContent(item.required_field);
  
  // éªŒè¯å¯é€‰å­—æ®µ
  if (item.optional_field !== undefined) {
    if (typeof item.optional_field !== "string") {
      errors.push(`ç¬¬ ${i + 1} è¡Œï¼šyour-new-type 'optional_field' å¿…é¡»æ˜¯å­—ç¬¦ä¸²`);
      continue;
    }
    item.optional_field = sanitizeContent(item.optional_field);
  }
  break;
```

**æ¨¡å¼**ï¼šé¦–å…ˆæ£€æŸ¥å¿…éœ€å­—æ®µï¼Œå¯¹å­—ç¬¦ä¸²ä½¿ç”¨ `sanitizeContent()`ï¼Œå¯¹æ•°å­—ä½¿ç”¨éªŒè¯åŠ©æ‰‹ï¼Œå‡ºé”™æ—¶ç»§ç»­å¾ªç¯ã€‚

### 6. æ›´æ–° Go è¿‡æ»¤å‡½æ•°ï¼ˆ`pkg/workflow/safe_outputs.go`ï¼‰

åœ¨ `generateFilteredToolsJSON` ä¸­æ·»åŠ åˆ° `enabledTools` æ˜ å°„ï¼ˆçº¦ç¬¬ 1120 è¡Œï¼‰ï¼š

```go
// generateFilteredToolsJSON æ ¹æ®å¯ç”¨çš„ Safe Output è¿‡æ»¤ ALL_TOOLS æ•°ç»„
// è¿”å›ä»…åŒ…å« Workflow ä¸­å¯ç”¨çš„ Tool çš„ JSON å­—ç¬¦ä¸²
func generateFilteredToolsJSON(data *WorkflowData) (string, error) {
	if data.SafeOutputs == nil {
		return "[]", nil
	}

	safeOutputsLog.Print("ä¸º Workflow ç”Ÿæˆè¿‡æ»¤åçš„ Tool JSON")

	// åŠ è½½å®Œæ•´çš„ Tool JSON
	allToolsJSON := GetSafeOutputsToolsJSON()

	// è§£æ JSON è·å–æ‰€æœ‰ Tool
	var allTools []map[string]any
	if err := json.Unmarshal([]byte(allToolsJSON), &allTools); err != nil {
		return "", fmt.Errorf("è§£æ Safe Output Tool JSON å¤±è´¥: %w", err)
	}

	// åˆ›å»ºå¯ç”¨çš„ Tool åç§°é›†åˆ
	enabledTools := make(map[string]bool)

	// æ£€æŸ¥å“ªäº› Safe Output å·²å¯ç”¨å¹¶æ·»åŠ å¯¹åº”çš„ Tool åç§°
	if data.SafeOutputs.CreateIssues != nil {
		enabledTools["create_issue"] = true
	}
	// ... ç°æœ‰æ£€æŸ¥ ...
	if data.SafeOutputs.YourNewType != nil {
		enabledTools["your_new_type"] = true  // åœ¨æ­¤æ·»åŠ ä½ çš„æ–°ç±»å‹
	}

	// è¿‡æ»¤ Tool ä»…åŒ…å«å¯ç”¨çš„
	var filteredTools []map[string]any
	for _, tool := range allTools {
		toolName, ok := tool["name"].(string)
		if !ok {
			continue
		}
		if enabledTools[toolName] {
			filteredTools = append(filteredTools, tool)
		}
	}

	// åºåˆ—åŒ–è¿‡æ»¤åçš„ Tool ä¸º JSON
	filteredJSON, err := json.Marshal(filteredTools)
	if err != nil {
		return "", fmt.Errorf("åºåˆ—åŒ–è¿‡æ»¤åçš„ Tool å¤±è´¥: %w", err)
	}

	return string(filteredJSON), nil
}
```

**æµç¨‹**ï¼šWorkflow é…ç½® â†’ è§£æä¸ºç»“æ„ä½“ â†’ è¿‡æ»¤ Tool â†’ å†™å…¥ JSON â†’ MCP Server æš´éœ²ç»™ Agentã€‚

### 7. åˆ›å»º JavaScript å®ç°ï¼ˆ`pkg/workflow/js/your_new_type.cjs`ï¼‰

```javascript
async function main() {
  // æ£€æŸ¥æ˜¯å¦å¤„äºæš‚å­˜æ¨¡å¼
  const isStaged = process.env.GH_AW_SAFE_OUTPUTS_STAGED === "true";

  // ä»ç¯å¢ƒå˜é‡è¯»å–éªŒè¯åçš„è¾“å‡ºå†…å®¹
  const outputContent = process.env.GH_AW_AGENT_OUTPUT;
  if (!outputContent) {
    core.info("æœªæ‰¾åˆ° GH_AW_AGENT_OUTPUT ç¯å¢ƒå˜é‡");
    return;
  }

  if (outputContent.trim() === "") {
    core.info("Agent è¾“å‡ºå†…å®¹ä¸ºç©º");
    return;
  }

  core.info(`Agent è¾“å‡ºå†…å®¹é•¿åº¦: ${outputContent.length}`);

  // è§£æéªŒè¯åçš„è¾“å‡º JSON
  let validatedOutput;
  try {
    validatedOutput = JSON.parse(outputContent);
  } catch (error) {
    core.setFailed(`è§£æ Agent è¾“å‡º JSON å‡ºé”™: ${error instanceof Error ? error.message : String(error)}`);
    return;
  }

  if (!validatedOutput.items || !Array.isArray(validatedOutput.items)) {
    core.info("Agent è¾“å‡ºä¸­æœªæ‰¾åˆ°æœ‰æ•ˆé¡¹");
    return;
  }

  // æŸ¥æ‰¾æ‰€æœ‰ your-new-type é¡¹
  const items = validatedOutput.items.filter(/** @param {any} item */ item => item.type === "your-new-type");
  if (items.length === 0) {
    core.info("Agent è¾“å‡ºä¸­æœªæ‰¾åˆ° your-new-type é¡¹");
    return;
  }

  core.info(`æ‰¾åˆ° ${items.length} ä¸ª your-new-type é¡¹`);

  // å¦‚æœå¤„äºæš‚å­˜æ¨¡å¼ï¼Œè¾“å‡ºæ­¥éª¤æ‘˜è¦è€Œä¸æ˜¯æ‰§è¡Œæ“ä½œ
  if (isStaged) {
    let summaryContent = "## ğŸ­ æš‚å­˜æ¨¡å¼ï¼šä½ çš„æ–°ç±»å‹é¢„è§ˆ\n\n";
    summaryContent += "å¦‚æœç¦ç”¨æš‚å­˜æ¨¡å¼ï¼Œå°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n";

    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      summaryContent += `### æ“ä½œ ${i + 1}\n`;
      summaryContent += `**å¿…éœ€å­—æ®µ**: ${item.required_field}\n`;
      if (item.optional_field) {
        summaryContent += `**å¯é€‰å­—æ®µ**: ${item.optional_field}\n`;
      }
      summaryContent += "\n";
    }

    core.summary.addRaw(summaryContent).write();
    return;
  }

  // å¤„ç†æ¯ä¸ªé¡¹
  for (const item of items) {
    try {
      // åœ¨æ­¤å®ç°ä½ çš„å®é™…é€»è¾‘
      core.info(`å¤„ç† your-new-type: ${item.required_field}`);
      
      // ç¤ºä¾‹ GitHub API è°ƒç”¨æ¨¡å¼ï¼š
      // const result = await github.rest.yourApi.yourMethod({
      //   owner: context.repo.owner,
      //   repo: context.repo.repo,
      //   your_field: item.required_field,
      // });
      
      core.info("æˆåŠŸå¤„ç† your-new-type é¡¹");
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      core.error(`å¤„ç† your-new-type å¤±è´¥: ${errorMessage}`);
      core.setFailed(`å¤„ç† your-new-type å¤±è´¥: ${errorMessage}`);
      return;
    }
  }
}

// è°ƒç”¨ä¸»å‡½æ•°
await main();
```

**æŒ‡å—**ï¼šæ£€æŸ¥æš‚å­˜æ¨¡å¼ï¼Œä½¿ç”¨ `core.*` æ–¹æ³•ï¼ˆä¸ä½¿ç”¨ console.logï¼‰ï¼Œé¢„è§ˆä½¿ç”¨ `core.summary`ï¼Œä½¿ç”¨ try/catch å¤„ç†é”™è¯¯ã€‚

### 8. åˆ›å»ºæµ‹è¯•

**æ–‡ä»¶**ï¼š`pkg/workflow/js/your_new_type.test.cjs` - æµ‹è¯•ç©ºè¾“å…¥ã€æœ‰æ•ˆå¤„ç†ã€æš‚å­˜æ¨¡å¼ã€é”™è¯¯ã€‚ä½¿ç”¨ vitestã€‚

**æ–‡ä»¶**ï¼š`pkg/workflow/js/collect_ndjson_output.test.cjs` - ä½¿ç”¨æœ‰æ•ˆ/æ— æ•ˆå­—æ®µæµ‹è¯•éªŒè¯ã€‚

### 9. åˆ›å»ºæµ‹è¯• Workflow

ä¸ºæ¯ä¸ªå¼•æ“ï¼ˆclaude/codex/copilotï¼‰åœ¨ `pkg/cli/workflows/` ä¸­åˆ›å»ºï¼š

**ç¤ºä¾‹**ï¼š`test-claude-your-new-type.md`

```markdown
---
on: workflow_dispatch
permissions:
  contents: read
  actions: read
engine: claude
safe-outputs:
  your-new-type:
    max: 3
    custom-option: "test"
timeout-minutes: 5
---

# æµ‹è¯•ä½ çš„æ–°ç±»å‹

æµ‹è¯•æ–°çš„ Safe Output ç±»å‹åŠŸèƒ½ã€‚

åˆ›å»ºä¸€ä¸ª your-new-type è¾“å‡ºï¼ŒåŒ…å«ï¼š
- required_field: "Hello World"  
- optional_field: "è¿™æ˜¯å¯é€‰çš„"

ä»¥ JSONL æ ¼å¼è¾“å‡ºã€‚
```

### 10. åˆ›å»º Go æ­¥éª¤é…ç½®æ„å»ºå™¨ï¼ˆ`pkg/workflow/compiler_safe_outputs_consolidated.go`ï¼‰

åˆ›å»ºä¸€ä¸ªæ­¥éª¤é…ç½®æ„å»ºå™¨å‡½æ•°ï¼Œå°†ä» `buildConsolidatedSafeOutputsJob()` è°ƒç”¨ã€‚æ‰€æœ‰ Safe Output ç°åœ¨ä½œä¸ºå•ä¸ªåˆå¹¶ Job ä¸­çš„æ­¥éª¤è¿è¡Œï¼Œè€Œä¸æ˜¯å•ç‹¬çš„ Jobã€‚

**æ­¥éª¤ 1ï¼šæ·»åŠ é…ç½®ç±»å‹**ï¼ˆå¦‚æœå°šæœªåœ¨ `pkg/workflow/frontmatter_types.go` æˆ– `pkg/workflow/safe_output_builder.go` ä¸­å®šä¹‰ï¼‰ï¼š

```go
// YourNewTypeConfig ä¿å­˜æ¥è‡ª Agent è¾“å‡ºçš„æ–°ç±»å‹é…ç½®
// åµŒå…¥å…±äº«é…ç½®ç±»å‹ä»¥å‡å°‘é‡å¤
type YourNewTypeConfig struct {
	BaseSafeOutputConfig   `yaml:",inline"`
	SafeOutputTargetConfig `yaml:",inline"` // æä¾› Target å’Œ TargetRepoSlug å­—æ®µ
	CustomOption           string           `yaml:"custom-option,omitempty"`  // è‡ªå®šä¹‰é…ç½®é€‰é¡¹
	AnotherOption          *bool            `yaml:"another-option,omitempty"` // å¦ä¸€ä¸ªå¯é€‰é…ç½®
}
```

**æ­¥éª¤ 2ï¼šåœ¨ `pkg/workflow/compiler_safe_outputs_consolidated.go` ä¸­æ·»åŠ æ­¥éª¤é…ç½®æ„å»ºå™¨**ï¼š

```go
// buildYourNewTypeStepConfig ä¸º your_new_type åˆ›å»ºæ­¥éª¤é…ç½®
func (c *Compiler) buildYourNewTypeStepConfig(data *WorkflowData, mainJobName string, threatDetectionEnabled bool) SafeOutputStepConfig {
	cfg := data.SafeOutputs.YourNewType

	// æ„å»º your-new-type ç‰¹å®šçš„è‡ªå®šä¹‰ç¯å¢ƒå˜é‡
	var customEnvVars []string
	
	// å°†è‡ªå®šä¹‰é…ç½®é€‰é¡¹æ·»åŠ ä¸ºç¯å¢ƒå˜é‡
	if cfg.CustomOption != "" {
		customEnvVars = append(customEnvVars, fmt.Sprintf("          GH_AW_CUSTOM_OPTION: %q\n", cfg.CustomOption))
	}
	
	if cfg.AnotherOption != nil && *cfg.AnotherOption {
		customEnvVars = append(customEnvVars, "          GH_AW_ANOTHER_OPTION: \"true\"\n")
	}

	// å¯¹å¸¸è§å­—æ®µä½¿ç”¨å…±äº«ç¯å¢ƒå˜é‡æ„å»ºå™¨
	customEnvVars = append(customEnvVars, BuildTargetEnvVar("GH_AW_YOUR_NEW_TYPE_TARGET", cfg.Target)...)
	customEnvVars = append(customEnvVars, BuildMaxCountEnvVar("GH_AW_YOUR_NEW_TYPE_MAX_COUNT", cfg.Max)...)

	// æ·»åŠ æ ‡å‡† Safe Output ç¯å¢ƒå˜é‡
	customEnvVars = append(customEnvVars, c.buildStandardSafeOutputEnvVars(data, cfg.TargetRepoSlug)...)

	// æ„å»ºæ­¥éª¤æ¡ä»¶ - ä»…å½“ JSONL ä¸­æœ‰ your_new_type é¡¹æ—¶æ­¥éª¤æ‰è¿è¡Œ
	condition := BuildSafeOutputType("your_new_type")

	return SafeOutputStepConfig{
		StepName:      "æ‰§è¡Œä½ çš„æ–°ç±»å‹",
		StepID:        "your_new_type",
		ScriptName:    "your_new_type",       // ç”¨äºæ–‡ä»¶æ¨¡å¼ï¼ˆå¼•ç”¨ your_new_type.cjsï¼‰
		Script:        getYourNewTypeScript(), // ç”¨äºå†…è”æ¨¡å¼å›é€€
		CustomEnvVars: customEnvVars,
		Condition:     condition,
		Token:         cfg.GitHubToken,
	}
}
```

**æ­¥éª¤ 3ï¼šæ·»åŠ é…ç½®è§£æå™¨**ï¼ˆé€šå¸¸åœ¨ `pkg/workflow/safe_outputs.go` æˆ–ä¸æ­¥éª¤é…ç½®æ„å»ºå™¨ä¸€èµ·ï¼‰ï¼š

```go
// parseYourNewTypeConfig ä½¿ç”¨å…±äº«è§£æå™¨å¤„ç† your-new-type é…ç½®
func (c *Compiler) parseYourNewTypeConfig(outputMap map[string]any) *YourNewTypeConfig {
	if configData, exists := outputMap["your-new-type"]; exists {
		yourNewTypeConfig := &YourNewTypeConfig{}
		yourNewTypeConfig.Max = 1 // é»˜è®¤ max ä¸º 1

		if configMap, ok := configData.(map[string]any); ok {
			// è§£æå¸¸è§åŸºç¡€å­—æ®µ
			c.parseBaseSafeOutputConfig(configMap, &yourNewTypeConfig.BaseSafeOutputConfig)

			// ä½¿ç”¨å…±äº«åŠ©æ‰‹è§£æç›®æ ‡é…ç½®ï¼ˆå¤„ç† target å’Œ target-repoï¼‰
			targetConfig, isInvalid := ParseTargetConfig(configMap)
			if isInvalid {
				// target-repo éªŒè¯é”™è¯¯ï¼ˆä¸å…è®¸é€šé…ç¬¦ï¼‰
				return nil
			}
			yourNewTypeConfig.SafeOutputTargetConfig = targetConfig

			// ä½¿ç”¨é€šç”¨å­—ç¬¦ä¸²è§£æå™¨è§£æ custom-option
			yourNewTypeConfig.CustomOption = ParseStringFromConfig(configMap, "custom-option")

			// è§£æ another-optionï¼ˆå¸ƒå°”å€¼ç¤ºä¾‹ - è¿˜æ²¡æœ‰å¸ƒå°”å€¼çš„å…±äº«åŠ©æ‰‹ï¼‰
			if anotherOption, exists := configMap["another-option"]; exists {
				if anotherOptionBool, ok := anotherOption.(bool); ok {
					yourNewTypeConfig.AnotherOption = &anotherOptionBool
				}
			}
		}

		return yourNewTypeConfig
	}

	return nil
}

// getYourNewTypeScript è¿”å› JavaScript å®ç°
func getYourNewTypeScript() string {
	return embedJavaScript("your_new_type.cjs")
}
```

**æ­¥éª¤ 4ï¼šæ³¨å†Œè„šæœ¬**ï¼ˆå¦‚æœä½¿ç”¨æ–‡ä»¶æ¨¡å¼ï¼Œåœ¨ `pkg/workflow/scripts.go` ä¸­ï¼‰ï¼š

```go
// åœ¨ pkg/workflow/scripts.go ä¸­ï¼Œæ·»åŠ åˆ°è„šæœ¬æ³¨å†Œè¡¨ï¼š
registry.Register("your_new_type", ScriptInfo{
	Source:     getYourNewTypeScript(),
	ActionPath: "", // å¦‚æœä¸ä½¿ç”¨è‡ªå®šä¹‰ Action åˆ™ç•™ç©º
})
```

**æ­¥éª¤ 5ï¼šé›†æˆåˆ°åˆå¹¶ Job**ï¼ˆåœ¨ `pkg/workflow/compiler_safe_outputs_consolidated.go` ä¸­ï¼‰ï¼š

åœ¨ `buildConsolidatedSafeOutputsJob()` å‡½æ•°ä¸­æ·»åŠ ä½ çš„æ­¥éª¤ï¼š

```go
// æ·»åŠ åˆ°è„šæœ¬æ”¶é›†éƒ¨åˆ†ï¼ˆçº¦ç¬¬ 62-128 è¡Œï¼‰
if data.SafeOutputs.YourNewType != nil {
	scriptNames = append(scriptNames, "your_new_type")
}

// æ·»åŠ æ­¥éª¤æ„å»ºéƒ¨åˆ†ï¼ˆçº¦ç¬¬ 163-435 è¡Œï¼‰
// N. ä½ çš„æ–°ç±»å‹æ­¥éª¤
if data.SafeOutputs.YourNewType != nil {
	stepConfig := c.buildYourNewTypeStepConfig(data, mainJobName, threatDetectionEnabled)
	stepYAML := c.buildConsolidatedSafeOutputStep(data, stepConfig)
	steps = append(steps, stepYAML...)
	safeOutputStepNames = append(safeOutputStepNames, stepConfig.StepID)

	// å¦‚éœ€è¦æ·»åŠ è¾“å‡º
	outputs["your_new_type_result_id"] = "${{ steps.your_new_type.outputs.result_id }}"
	outputs["your_new_type_result_url"] = "${{ steps.your_new_type.outputs.result_url }}"

	// åˆå¹¶æƒé™ - æ ¹æ®ä½ çš„ç”¨ä¾‹è°ƒæ•´
	permissions.Merge(NewPermissionsContentsReadYourPermissions())
}
```

**è¦ç‚¹**ï¼š

1. **å•ä¸€ Job æ¶æ„** - æ‰€æœ‰ Safe Output ç°åœ¨ä½œä¸ºå•ä¸ª `safe_outputs` Job ä¸­çš„æ­¥éª¤è¿è¡Œï¼Œè€Œä¸æ˜¯å•ç‹¬çš„ Job

2. **æ­¥éª¤é…ç½®æ¨¡å¼** - ä½¿ç”¨ `SafeOutputStepConfig` ç»“æ„ä½“å®šä¹‰æ­¥éª¤å…ƒæ•°æ®ã€ç¯å¢ƒå˜é‡ã€æ¡ä»¶å’Œè„šæœ¬

3. **æ–‡ä»¶æ¨¡å¼** - JavaScript æ–‡ä»¶ä¸€æ¬¡å†™å…¥ `/tmp/gh-aw/scripts/`ï¼Œæ¯ä¸ªæ­¥éª¤é€šè¿‡ require å¼•ç”¨ï¼Œæœ€å¤§åŒ–ä»£ç å¤ç”¨

4. **æ­¥éª¤æ¡ä»¶** - æ¯ä¸ªæ­¥éª¤ä½¿ç”¨ `BuildSafeOutputType("your_new_type")` ä»…åœ¨å­˜åœ¨ç›¸å…³ JSONL é¡¹æ—¶è¿è¡Œ

5. **é›†æˆç‚¹**ï¼š
   - åœ¨ `pkg/workflow/frontmatter_types.go` ä¸­å‘ `SafeOutputsConfig` æ·»åŠ é…ç½®ç±»å‹
   - åœ¨ `pkg/workflow/safe_outputs.go` çš„ `extractSafeOutputsConfig()` ä¸­æ·»åŠ è§£æå™¨è°ƒç”¨
   - åœ¨ `buildConsolidatedSafeOutputsJob()` ä¸­æ·»åŠ è„šæœ¬åç§°åˆ°æ”¶é›†
   - æ·»åŠ æ­¥éª¤é…ç½®æ„å»ºå™¨å‡½æ•°
   - å°†æ­¥éª¤é›†æˆåˆ°åˆå¹¶ Job æ„å»º
   - å°†æ‰€éœ€æƒé™åˆå¹¶åˆ° Job æƒé™

6. **å¯ç”¨çš„å…±äº«åŠ©æ‰‹**ï¼š
   - é…ç½®ç±»å‹ï¼š`BaseSafeOutputConfig`ã€`SafeOutputTargetConfig`ã€`SafeOutputFilterConfig`ã€`SafeOutputDiscussionFilterConfig`ã€`CloseJobConfig`ã€`ListJobConfig`
   - è§£æå™¨ï¼š`ParseTargetConfig()`ã€`ParseFilterConfig()`ã€`ParseCloseJobConfig()`ã€`ParseListJobConfig()`ã€`ParseStringFromConfig()`
   - ç¯å¢ƒå˜é‡æ„å»ºå™¨ï¼š`BuildTargetEnvVar()`ã€`BuildRequiredLabelsEnvVar()`ã€`BuildCloseJobEnvVars()`ã€`BuildListJobEnvVars()`ã€`buildStandardSafeOutputEnvVars()`
   - æ¡ä»¶ï¼š`BuildSafeOutputType()`ã€`BuildAnd()`ã€`BuildOr()`ã€`BuildNot()`
   - æƒé™ï¼š`NewPermissionsContentsRead()`ã€`NewPermissionsContentsReadIssuesWrite()` ç­‰

7. **SafeOutputStepConfig ç»“æ„ä½“å­—æ®µ**ï¼š
   - `StepName` - äººç±»å¯è¯»çš„æ­¥éª¤åç§°ï¼ˆä¾‹å¦‚ "Create Issue"ï¼‰
   - `StepID` - ç”¨äºå¼•ç”¨è¾“å‡ºçš„æ­¥éª¤ IDï¼ˆä¾‹å¦‚ "create_issue"ï¼‰
   - `ScriptName` - æ–‡ä»¶æ¨¡å¼çš„åç§°ï¼ˆä¾‹å¦‚ "create_issue"ï¼‰
   - `Script` - å†…è”æ¨¡å¼å›é€€çš„ JavaScript
   - `CustomEnvVars` - æ­¥éª¤ç‰¹å®šçš„ç¯å¢ƒå˜é‡
   - `Condition` - æ­¥éª¤çº§æ¡ä»¶ï¼ˆä½•æ—¶è¿è¡Œï¼‰
   - `Token` - æ­¤æ­¥éª¤çš„ GitHub Token
   - `UseCopilotToken` - ä½¿ç”¨ Copilot Token åå¥½é“¾
   - `UseAgentToken` - ä½¿ç”¨ Agent Token åå¥½é“¾
   - `PreSteps` - è„šæœ¬å‰çš„å¯é€‰æ­¥éª¤
   - `PostSteps` - è„šæœ¬åçš„å¯é€‰æ­¥éª¤
   - `Outputs` - ä¸åœ¨æ­¥éª¤é…ç½®ä¸­ä½¿ç”¨ï¼ˆå•ç‹¬æ·»åŠ åˆ° Job è¾“å‡ºï¼‰

**å…³é—­æ“ä½œç¤ºä¾‹**ï¼š
```go
type CloseYourTypeConfig struct {
	BaseSafeOutputConfig `yaml:",inline"`
	CloseJobConfig       `yaml:",inline"`
}
closeConfig, isInvalid := ParseCloseJobConfig(configMap)
customEnvVars = append(customEnvVars, BuildCloseJobEnvVars("GH_AW_CLOSE_YOUR_TYPE", config.CloseJobConfig)...)
```

**åˆ—è¡¨æ“ä½œç¤ºä¾‹**ï¼š
```go
type AddYourTypeConfig struct {
	BaseSafeOutputConfig `yaml:",inline"`
	ListJobConfig        `yaml:",inline"`
}
listConfig, isInvalid := ParseListJobConfig(configMap, "allowed")
customEnvVars = append(customEnvVars, BuildListJobEnvVars("GH_AW_ADD_YOUR_TYPE", config.ListJobConfig, config.Max)...)
```

### 11. æ„å»ºå’Œæµ‹è¯•

```bash
make js fmt-cjs lint-cjs test-unit recompile agent-finish
```

### 12. æ‰‹åŠ¨éªŒè¯

ä½¿ç”¨æš‚å­˜/éæš‚å­˜æ¨¡å¼ã€é”™è¯¯å¤„ç†ã€JSON Schema éªŒè¯ã€æ‰€æœ‰å¼•æ“æµ‹è¯• Workflowã€‚

## æˆåŠŸæ ‡å‡†

- [ ] JSON Schema æ­£ç¡®éªŒè¯
- [ ] TypeScript ç±»å‹ç¼–è¯‘é€šè¿‡
- [ ] Tool JSON åŒ…å« Tool ç­¾å
- [ ] MCP Server å¤„ç†ç±»å‹ï¼ˆå¦‚éœ€è¦è‡ªå®šä¹‰å¤„ç†ç¨‹åºï¼‰
- [ ] Go è¿‡æ»¤å™¨åœ¨ `generateFilteredToolsJSON` ä¸­åŒ…å«ç±»å‹
- [ ] æ”¶é›†éªŒè¯å­—æ®µ
- [ ] JavaScript å®ç°å¤„ç†æ‰€æœ‰æƒ…å†µ
- [ ] æµ‹è¯•é€šè¿‡ä¸”è¦†ç›–ç‡è‰¯å¥½
- [ ] Workflow ç¼–è¯‘é€šè¿‡
- [ ] æ‰‹åŠ¨æµ‹è¯•ç¡®è®¤åŠŸèƒ½æ­£å¸¸

## å¸¸è§é™·é˜±

1. æ–‡ä»¶é—´å‘½åä¸ä¸€è‡´ï¼ˆkebab-case/camelCase/ä¸‹åˆ’çº¿ï¼‰
2. ç¼ºå°‘ tools.json æ›´æ–°ï¼ˆæ²¡æœ‰å®ƒ Agent æ— æ³•è°ƒç”¨ï¼‰
3. ç¼ºå°‘ Go è¿‡æ»¤å™¨æ›´æ–°ï¼ˆMCP ä¸ä¼šæš´éœ² Toolï¼‰
4. ç¼ºå°‘å­—æ®µéªŒè¯/å‡€åŒ–
5. æœªæ·»åŠ åˆ°è”åˆç±»å‹
6. æœªå¯¼å‡ºæ¥å£
7. æµ‹è¯•è¦†ç›–ç‡ä¸è¶³
8. Schema è¯­æ³•è¿è§„
9. GitHub API é”™è¯¯å¤„ç†
10. ç¼ºå°‘æš‚å­˜æ¨¡å¼å®ç°
11. ä¿®æ”¹åµŒå…¥æ–‡ä»¶åå¿˜è®° `make build`

## å‚è€ƒèµ„æ–™

- JSON Schemaï¼šhttps://json-schema.org/draft-07/schema
- GitHub Actions Coreï¼šhttps://github.com/actions/toolkit/tree/main/packages/core
- GitHub REST APIï¼šhttps://docs.github.com/en/rest
- Vitestï¼šhttps://vitest.dev/
- ç°æœ‰å®ç°ï¼š`pkg/workflow/js/*.cjs`

```

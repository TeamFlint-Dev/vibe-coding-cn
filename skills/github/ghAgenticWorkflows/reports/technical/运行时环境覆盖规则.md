# 运行时环境覆盖规则 (runtimes)

> **调研日期**: 2026-01-03
>
> **调研背景**: 明确 GitHub Agentic Workflows 中 `runtimes:` 字段的配置合并与覆盖规则，避免后续开发时遇到版本冲突问题。

## 概述

`runtimes:` 是 Agentic Workflow frontmatter 中的一个顶级字段，用于：

- 自定义运行时版本（如 Node.js、Python）
- 定义新的运行时环境
- 覆盖默认的 setup action

---

## 配置语法

### 基本结构

```yaml
runtimes:
  <runtime-id>:
    version: "<版本号>"
    action-repo: "<GitHub Action 仓库>"    # 可选
    action-version: "<Action 版本>"        # 可选
```

### 完整示例

```yaml
runtimes:
  node:
    version: "22"
  python:
    version: "3.12"
    action-repo: "actions/setup-python"
    action-version: "v5"
  go:
    version: "1.21"
    action-repo: "actions/setup-go"
    action-version: "v5"
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `version` | string \| number | 是 | 运行时版本，如 `"22"`, `"3.12"`, `"latest"`, `22`, `3.12` |
| `action-repo` | string | 否 | GitHub Actions setup 仓库，如 `"actions/setup-node"` |
| `action-version` | string | 否 | Setup action 的版本，如 `"v4"`, `"v5"` |

**注意**：

- `version` 支持字符串或数字，数字会自动转为字符串
- 运行时 ID 必须匹配 `^[a-z][a-z0-9-]*$`（小写字母开头，可含数字和连字符）

---

## 覆盖规则

### 核心原则：后者覆盖前者

```
┌─────────────────────────────────────────────────────────┐
│  优先级（从低到高）                                      │
├─────────────────────────────────────────────────────────┤
│  1. 系统默认值（gh-aw 内置默认）                         │
│           ↓                                             │
│  2. imports 中的共享工作流（按数组顺序依次加载）          │
│           ↓                                             │
│  3. 主工作流的 runtimes（最终覆盖，最高优先级）           │
└─────────────────────────────────────────────────────────┘
```

### 官方文档原文

> *"Runtimes from imported shared workflows are also merged."*
>
> — [github-agentic-workflows.md](shared/gh-aw-raw/aw/github-agentic-workflows.md)

### 合并行为详解

#### 场景 1：主工作流覆盖导入的共享工作流

```yaml
# 共享工作流: .github/workflows/shared/base-setup.md
runtimes:
  node:
    version: "20"
  python:
    version: "3.11"
```

```yaml
# 主工作流: .github/workflows/my-workflow.md
imports:
  - shared/base-setup.md
runtimes:
  node:
    version: "22"    # ✅ 覆盖共享工作流的 node 版本
  # python 保持 3.11（继承自共享工作流）
```

**最终结果**：

- `node.version` = `"22"` (来自主工作流)
- `python.version` = `"3.11"` (来自共享工作流)

#### 场景 2：多个 imports 的合并顺序

```yaml
# 主工作流
imports:
  - shared/setup-a.md    # node: 18, python: 3.10
  - shared/setup-b.md    # node: 20
runtimes:
  node:
    version: "22"
```

**合并顺序**：

1. 加载 `setup-a.md` → `{node: 18, python: 3.10}`
2. 加载 `setup-b.md` → `{node: 20, python: 3.10}` (node 被覆盖)
3. 应用主工作流 → `{node: 22, python: 3.10}` (node 再次被覆盖)

#### 场景 3：同一运行时 ID 的完整替换

当覆盖发生时，是**整个运行时配置对象被替换**，而非字段级合并：

```yaml
# 共享工作流
runtimes:
  node:
    version: "20"
    action-repo: "actions/setup-node"
    action-version: "v4"

# 主工作流
runtimes:
  node:
    version: "22"    # 只指定 version
```

**最终结果**：

- `node.version` = `"22"` ✅
- `node.action-repo` = `undefined` (未继承！)
- `node.action-version` = `undefined` (未继承！)

> ⚠️ **重要**：如果主工作流覆盖某个运行时，必须提供完整配置，不会从被覆盖的源继承部分字段。

---

## 与其他配置的合并对比

| 配置类型 | 合并行为 | 说明 |
|---------|---------|------|
| `runtimes` | 同 ID 完整替换 | 后者完全覆盖前者的同名运行时 |
| `tools` | 合并，同名覆盖 | 工具级别合并 |
| `safe-outputs` | 合并 | 输出类型级别合并 |
| `network.allowed` | 数组合并 | 域名列表合并 |
| `steps` | 追加 | 步骤按顺序追加，不覆盖 |
| `permissions` | 合并 | 同权限后者覆盖 |

---

## CLI 参数优先级

对于某些配置（如 `strict`），CLI 参数优先于 frontmatter：

```bash
gh aw compile --strict    # CLI 强制启用严格模式，覆盖 frontmatter
```

但 **`runtimes` 目前没有 CLI 覆盖选项**，仅通过 frontmatter 配置。

---

## 实际案例

### jsweep 工作流

来源：[jsweep.md](shared/gh-aw-raw/workflows/jsweep.md)

```yaml
runtimes:
  node:
    version: "20"
```

### python-dataviz 共享工作流

来源：[python-dataviz.md](shared/gh-aw-raw/workflows/shared/python-dataviz.md)

该共享工作流没有显式指定 `runtimes`，使用系统默认的 Python 版本。

---

## 最佳实践

### ✅ 推荐做法

1. **在主工作流中明确指定所需版本**

   ```yaml
   runtimes:
     node:
       version: "22"
   ```

2. **覆盖时提供完整配置**

   ```yaml
   runtimes:
     python:
       version: "3.12"
       action-repo: "actions/setup-python"
       action-version: "v5"
   ```

3. **使用共享工作流统一团队标准**

   ```yaml
   # shared/team-runtimes.md
   runtimes:
     node:
       version: "22"
     python:
       version: "3.12"
   ```

### ❌ 避免做法

1. **依赖隐式继承字段**

   ```yaml
   # 共享工作流有完整配置，主工作流只覆盖 version
   # 可能丢失 action-repo 和 action-version
   runtimes:
     node:
       version: "22"    # ⚠️ 其他字段会丢失
   ```

2. **在多个 imports 中重复定义同一运行时**
   - 容易产生混淆，难以追踪最终生效的版本

---

## 调试技巧

### 查看编译后的配置

```bash
gh aw compile my-workflow --dry-run
```

### 检查生成的 .lock.yml

编译后查看 `.github/workflows/my-workflow.lock.yml`，确认 setup 步骤使用了正确的版本。

---

## 相关文档

- [官方指引.md](官方指引.md) - 完整 frontmatter schema
- [Frontmatter Schema JSON](shared/gh-aw-raw/aw/main_workflow_schema.json) - 机器可读的完整 schema
- [CAPABILITY-BOUNDARIES.md](CAPABILITY-BOUNDARIES.md) - gh-aw 能力边界

---

## 变更记录

| 日期 | 内容 |
|------|------|
| 2026-01-03 | 初始调研，明确 runtimes 覆盖规则 |

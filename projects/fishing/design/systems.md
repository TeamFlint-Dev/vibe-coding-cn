# 🏗️ Fishing - 系统设计文档

> **版本**：v1.0  
> **阶段**：系统设计  
> **前置依赖**：`@concept.md`  
> **生成者**：game-system-designer

---

## 一、系统总览

### 系统清单

| 系统 | 职责 | 核心循环位置 | MVP 优先级 |
|------|------|--------------|-----------|
| **钓鱼系统** | 玩家主动采集入口 | 输入端 | P0 |
| **战利品系统** | 管理收集品状态 | 处理层 | P0 |
| **基地系统** | 战利品放置与展示 | 展示层 | P0 |
| **收益系统** | 被动资源产出 | 输出端 | P0 |
| **升级系统** | 进度解锁与强化 | 反馈回路 | P0 |

---

## 二、系统交互图

```
┌─────────────────────────────────────────────────────────────────┐
│                         玩家操作层                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      🎣 钓鱼系统 (Fishing)                       │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│  │ 钓点管理 │───▶│ 钓鱼流程 │───▶│ 战利品掉落 │                  │
│  └──────────┘    └──────────┘    └──────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 产出: Fish Item
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     🐟 战利品系统 (Trophy)                       │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│  │ 背包管理 │◀──▶│ 稀有度判定 │◀──▶│ 图鉴记录 │                   │
│  └──────────┘    └──────────┘    └──────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 事件: Trophy Placed
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      🏠 基地系统 (Base)                          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│  │ 展示位管理│◀──▶│ 放置逻辑 │◀──▶│ 视觉渲染 │                    │
│  └──────────┘    └──────────┘    └──────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 广播: Display Updated
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     💰 收益系统 (Income)                         │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│  │ 产出计算 │───▶│ 资源累积 │───▶│ 领取结算 │                    │
│  └──────────┘    └──────────┘    └──────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 资源: Gold
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     ⬆️ 升级系统 (Upgrade)                        │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│  │ 升级商店 │───▶│ 条件验证 │───▶│ 效果应用 │                    │
│  └──────────┘    └──────────┘    └──────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 效果: 提升钓鱼能力
                              ▼
                        (返回钓鱼系统)
```

---

## 三、数据流设计

### 核心数据实体

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Player    │     │    Fish     │     │ DisplaySlot │
├─────────────┤     ├─────────────┤     ├─────────────┤
│ gold        │     │ id          │     │ slotId      │
│ rodLevel    │     │ name        │     │ fishId      │
│ inventory[] │     │ rarity      │     │ incomeRate  │
│ collection[]│     │ baseIncome  │     │ isOccupied  │
└─────────────┘     │ size        │     └─────────────┘
                    └─────────────┘
```

### 数据流向

```
[钓鱼系统]                    [战利品系统]
    │                             │
    │  FishCaughtEvent            │
    │  {fishId, rarity}           │
    │────────────────────────────▶│
    │                             │
    │                             │  AddToInventory()
    │                             │  UpdateCollection()
    │                             │
                                  │
                                  ▼
                          [基地系统]
                              │
                              │  PlaceFishEvent
                              │  {slotId, fishId}
                              │
                              ▼
                         [收益系统]
                              │
                              │  RecalculateIncome()
                              │
                              ▼
                         [升级系统]
                              │
                              │  CheckUpgradeAvailable()
                              │
```

---

## 四、系统详细设计

### 4.1 钓鱼系统 (Fishing System)

**职责**：处理玩家钓鱼行为，产出战利品

| 组件 | 功能 | 输入 | 输出 |
|------|------|------|------|
| FishingSpot | 钓点交互入口 | 玩家靠近/交互 | 进入钓鱼状态 |
| FishingProcess | 钓鱼流程控制 | 开始钓鱼 | 咬钩事件 |
| LootTable | 掉落表计算 | 玩家属性 + 钓点 | 具体鱼种 |

**状态机**：

```
IDLE ──[交互]──▶ CASTING ──[投竿完成]──▶ WAITING
                                            │
    ┌───────[收杆]──────────────────────────┘
    │                                       │
    ▼                                   [咬钩]
SUCCESS ◀────────────────────────────── HOOKED
```

---

### 4.2 战利品系统 (Trophy System)

**职责**：管理战利品生命周期，维护收集进度

| 组件 | 功能 | 输入 | 输出 |
|------|------|------|------|
| Inventory | 临时存储 | 新获得的鱼 | 可放置的鱼列表 |
| Collection | 图鉴记录 | 任意获得事件 | 收集进度 |
| FishDatabase | 鱼种数据源 | fishId | 鱼的完整属性 |

**稀有度定义**：

| 稀有度 | 颜色 | 掉落权重 | 基础收益 |
|--------|------|----------|----------|
| Common | 白色 | 60% | 1x |
| Uncommon | 绿色 | 25% | 2x |
| Rare | 蓝色 | 10% | 5x |
| Epic | 紫色 | 4% | 15x |
| Legendary | 金色 | 1% | 50x |

---

### 4.3 基地系统 (Base System)

**职责**：管理展示位与战利品放置

| 组件 | 功能 | 输入 | 输出 |
|------|------|------|------|
| DisplaySlot | 展示位容器 | 放置请求 | 视觉更新 |
| SlotManager | 展示位管理 | 查询/操作 | 可用位列表 |
| BaseRenderer | 视觉渲染 | 放置变化 | 3D 场景更新 |

**MVP 展示位**：

- 初始 3 个展示位
- 每个位置固定位置和朝向
- 展示的鱼有 3D 模型 + 铭牌

---

### 4.4 收益系统 (Income System)

**职责**：计算并累积被动收益

| 组件 | 功能 | 输入 | 输出 |
|------|------|------|------|
| IncomeCalculator | 计算总产出 | 展示位状态 | 每秒产出值 |
| AccumulatorTimer | 定时累积 | 时间流逝 | 累积金币 |
| ClaimHandler | 领取处理 | 玩家领取 | 实际到账 |

**收益公式**：

```
单位收益 = Σ(展示鱼.baseIncome × 稀有度倍率)
实际收益 = 单位收益 × 时间(秒) × 全局加成
```

---

### 4.5 升级系统 (Upgrade System)

**职责**：管理玩家进度与能力提升

| 组件 | 功能 | 输入 | 输出 |
|------|------|------|------|
| UpgradeShop | 升级入口 | 玩家交互 | 可购买列表 |
| UpgradeValidator | 条件检查 | 购买请求 | 是否可购买 |
| EffectApplier | 效果应用 | 确认购买 | 属性变更 |

**MVP 升级项**：

| 升级项 | 效果 | 层级 | 费用递增 |
|--------|------|------|----------|
| 鱼竿等级 | 稀有掉落率 +5% / 级 | 1-10 | 100 × 1.5^level |

---

## 五、系统边界与接口

### 系统间接口定义

```verse
# 钓鱼系统 → 战利品系统
interface FishingToTrophy:
    OnFishCaught(FishData) : void

# 战利品系统 → 基地系统  
interface TrophyToBase:
    CanPlaceFish(SlotId, FishId) : bool
    PlaceFish(SlotId, FishId) : void

# 基地系统 → 收益系统
interface BaseToIncome:
    OnDisplayChanged(SlotId, FishData?) : void

# 收益系统 → 升级系统
interface IncomeToUpgrade:
    GetCurrentGold() : int
    SpendGold(Amount) : bool

# 升级系统 → 钓鱼系统
interface UpgradeToFishing:
    GetRarityBonus() : float
```

---

## 六、MVP 系统精简

### 必须实现

- [x] 单钓点钓鱼流程
- [x] 5 种鱼 + 5 级稀有度
- [x] 3 个固定展示位
- [x] 简单收益计算（每秒累积）
- [x] 鱼竿升级（10 级）

### 延后实现

- [ ] 多钓点 / 钓点解锁
- [ ] 展示位扩展
- [ ] 离线收益计算
- [ ] 装饰系统
- [ ] 成就系统

---

## 七、下一步行动

**系统设计完成** ✅

下一阶段：调用 `game-mechanics-designer` 逐个设计各系统的详细机制

设计顺序：

1. `@mechanics/fishing.md` - 钓鱼系统机制
2. `@mechanics/trophy.md` - 战利品系统机制
3. `@mechanics/base.md` - 基地系统机制
4. `@mechanics/income.md` - 收益系统机制
5. `@mechanics/upgrade.md` - 升级系统机制

---

*文档生成时间：2025-12-26*

# ç»æµè´§å¸ç³»ç»Ÿæ¨¡å—
# åŠŸèƒ½ï¼šå¤šè´§å¸æ±‡ç‡è½¬æ¢ã€å¤§æ•°å€¼æ ¼å¼åŒ– (1k, 1m)

using { /Verse.org/Simulation }

EcoCurrency<public> := module:
    
    # ========== è´§å¸ç±»å‹æšä¸¾ ==========
    
    CURRENCY_GOLD<public>:int = 0       # é‡‘å¸
    CURRENCY_SILVER<public>:int = 1     # é“¶å¸
    CURRENCY_COPPER<public>:int = 2     # é“œå¸
    CURRENCY_GEMS<public>:int = 3       # å®çŸ³ï¼ˆé«˜çº§è´§å¸ï¼‰
    CURRENCY_TOKENS<public>:int = 4     # ä»£å¸ï¼ˆæ´»åŠ¨è´§å¸ï¼‰
    
    # ========== æ•°æ®ç»“æ„ ==========
    
    # è´§å¸æ•°é¢
    currency_amount<public> := struct<computes>:
        CurrencyType<public>:int = 0
        Amount<public>:int = 0
    
    # å¤šè´§å¸é’±åŒ…
    wallet<public> := struct<computes>:
        Gold<public>:int = 0
        Silver<public>:int = 0
        Copper<public>:int = 0
        Gems<public>:int = 0
        Tokens<public>:int = 0
    
    # ========== æ±‡ç‡å¸¸é‡ ==========
    
    # åŸºç¡€è´§å¸è½¬æ¢ç‡ï¼ˆä»¥é“œå¸ä¸ºåŸºå‡†ï¼‰
    COPPER_TO_COPPER<public>:int = 1
    SILVER_TO_COPPER<public>:int = 100      # 1é“¶ = 100é“œ
    GOLD_TO_COPPER<public>:int = 10000      # 1é‡‘ = 100é“¶ = 10000é“œ
    
    # é«˜çº§è´§å¸è½¬æ¢ç‡
    GEMS_TO_GOLD<public>:int = 100          # 1å®çŸ³ = 100é‡‘
    TOKENS_TO_GOLD<public>:int = 10         # 1ä»£å¸ = 10é‡‘
    
    # ========== æ±‡ç‡è½¬æ¢ ==========
    
    # è·å–è´§å¸åˆ°é“œå¸çš„æ±‡ç‡
    GetCurrencyToCopper<public>(CurrencyType:int)<computes>:int =
        if (CurrencyType = CURRENCY_COPPER):
            COPPER_TO_COPPER
        else if (CurrencyType = CURRENCY_SILVER):
            SILVER_TO_COPPER
        else if (CurrencyType = CURRENCY_GOLD):
            GOLD_TO_COPPER
        else if (CurrencyType = CURRENCY_GEMS):
            GEMS_TO_GOLD * GOLD_TO_COPPER
        else if (CurrencyType = CURRENCY_TOKENS):
            TOKENS_TO_GOLD * GOLD_TO_COPPER
        else:
            1
    
    # è½¬æ¢ä¸ºé“œå¸
    ConvertToCopper<public>(Amount:int, CurrencyType:int)<computes>:int =
        Rate := GetCurrencyToCopper(CurrencyType)
        Amount * Rate
    
    # ä»é“œå¸è½¬æ¢ä¸ºæŒ‡å®šè´§å¸
    ConvertFromCopper<public>(CopperAmount:int, TargetCurrency:int)<computes>:int =
        Rate := GetCurrencyToCopper(TargetCurrency)
        if (Rate <= 0):
            0
        else:
            Floor(CopperAmount / Rate)
    
    # è´§å¸é—´è½¬æ¢
    ConvertCurrency<public>(Amount:int, FromType:int, ToType:int)<computes>:int =
        CopperValue := ConvertToCopper(Amount, FromType)
        ConvertFromCopper(CopperValue, ToType)
    
    # ========== è´§å¸æ‹†åˆ† ==========
    
    # å°†é“œå¸æ‹†åˆ†ä¸ºé‡‘é“¶é“œ
    SplitToGoldSilverCopper<public>(TotalCopper:int)<transacts>:tuple(int, int, int) =
        Gold := Floor(TotalCopper / GOLD_TO_COPPER)
        RemainingAfterGold := TotalCopper - Gold * GOLD_TO_COPPER
        
        Silver := Floor(RemainingAfterGold / SILVER_TO_COPPER)
        Copper := RemainingAfterGold - Silver * SILVER_TO_COPPER
        
        (Gold, Silver, Copper)
    
    # å°†é‡‘é“¶é“œåˆå¹¶ä¸ºæ€»é“œå¸
    MergeToCopper<public>(Gold:int, Silver:int, Copper:int)<computes>:int =
        Gold * GOLD_TO_COPPER + Silver * SILVER_TO_COPPER + Copper
    
    # ========== æ•°å€¼æ ¼å¼åŒ– ==========
    
    # æ ¼å¼åŒ–ä¸ºäººç±»å¯è¯»ï¼ˆ1k, 1m, 1bï¼‰
    FormatLargeNumber<public>(Amount:int)<computes>:string =
        if (Amount >= 1000000000):
            # åäº¿çº§åˆ«
            Billions := Floor(Amount / 1000000000)
            "{Billions}b"
        else if (Amount >= 1000000):
            # ç™¾ä¸‡çº§åˆ«
            Millions := Floor(Amount / 1000000)
            "{Millions}m"
        else if (Amount >= 1000):
            # åƒçº§åˆ«
            Thousands := Floor(Amount / 1000)
            "{Thousands}k"
        else:
            "{Amount}"
    
    # æ ¼å¼åŒ–è´§å¸æ˜¾ç¤ºï¼ˆå¸¦å•ä½ï¼‰
    FormatCurrency<public>(Amount:int, CurrencyType:int)<computes>:string =
        FormattedNum := FormatLargeNumber(Amount)
        if (CurrencyType = CURRENCY_GOLD):
            "{FormattedNum}G"
        else if (CurrencyType = CURRENCY_SILVER):
            "{FormattedNum}S"
        else if (CurrencyType = CURRENCY_COPPER):
            "{FormattedNum}C"
        else if (CurrencyType = CURRENCY_GEMS):
            "{FormattedNum}ğŸ’"
        else if (CurrencyType = CURRENCY_TOKENS):
            "{FormattedNum}ğŸ«"
        else:
            "{FormattedNum}"
    
    # æ ¼å¼åŒ–ä¸ºé‡‘é“¶é“œæ˜¾ç¤º
    FormatAsGoldSilverCopper<public>(TotalCopper:int)<computes>:string =
        (Gold, Silver, Copper) := SplitToGoldSilverCopper(TotalCopper)
        if (Gold > 0):
            if (Silver > 0 or Copper > 0):
                "{Gold}G {Silver}S {Copper}C"
            else:
                "{Gold}G"
        else if (Silver > 0):
            if (Copper > 0):
                "{Silver}S {Copper}C"
            else:
                "{Silver}S"
        else:
            "{Copper}C"
    
    # ========== é’±åŒ…æ“ä½œ ==========
    
    # æ·»åŠ è´§å¸åˆ°é’±åŒ…
    AddToWallet<public>(Wallet:wallet, Amount:int, CurrencyType:int)<transacts>:wallet =
        if (CurrencyType = CURRENCY_GOLD):
            wallet{Gold := Wallet.Gold + Amount, Silver := Wallet.Silver, Copper := Wallet.Copper, Gems := Wallet.Gems, Tokens := Wallet.Tokens}
        else if (CurrencyType = CURRENCY_SILVER):
            wallet{Gold := Wallet.Gold, Silver := Wallet.Silver + Amount, Copper := Wallet.Copper, Gems := Wallet.Gems, Tokens := Wallet.Tokens}
        else if (CurrencyType = CURRENCY_COPPER):
            wallet{Gold := Wallet.Gold, Silver := Wallet.Silver, Copper := Wallet.Copper + Amount, Gems := Wallet.Gems, Tokens := Wallet.Tokens}
        else if (CurrencyType = CURRENCY_GEMS):
            wallet{Gold := Wallet.Gold, Silver := Wallet.Silver, Copper := Wallet.Copper, Gems := Wallet.Gems + Amount, Tokens := Wallet.Tokens}
        else if (CurrencyType = CURRENCY_TOKENS):
            wallet{Gold := Wallet.Gold, Silver := Wallet.Silver, Copper := Wallet.Copper, Gems := Wallet.Gems, Tokens := Wallet.Tokens + Amount}
        else:
            Wallet
    
    # æ£€æŸ¥é’±åŒ…æ˜¯å¦æœ‰è¶³å¤Ÿè´§å¸
    CheckWalletHasCurrency<public>(Wallet:wallet, Amount:int, CurrencyType:int)<decides><transacts>:void =
        if (CurrencyType = CURRENCY_GOLD):
            Wallet.Gold >= Amount
        else if (CurrencyType = CURRENCY_SILVER):
            Wallet.Silver >= Amount
        else if (CurrencyType = CURRENCY_COPPER):
            Wallet.Copper >= Amount
        else if (CurrencyType = CURRENCY_GEMS):
            Wallet.Gems >= Amount
        else if (CurrencyType = CURRENCY_TOKENS):
            Wallet.Tokens >= Amount
        else:
            false
    
    # ========== å·¥å…·å‡½æ•° ==========
    
    # åˆ›å»ºè´§å¸æ•°é¢
    MakeCurrencyAmount<public>(Type:int, Amount:int)<transacts>:currency_amount =
        currency_amount{
            CurrencyType := Type
            Amount := Amount
        }
    
    # åˆ›å»ºç©ºé’±åŒ…
    MakeEmptyWallet<public>()<transacts>:wallet =
        wallet{
            Gold := 0
            Silver := 0
            Copper := 0
            Gems := 0
            Tokens := 0
        }

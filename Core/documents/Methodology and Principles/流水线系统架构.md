# 流水线系统架构

> **版本**: 1.0.0  
> **创建日期**: 2026-01-02  
> **状态**: 设计中

---

## 概述

本文档定义了一套通用的流水线系统架构，用于支持多种工作流场景：

- **Skills 知识蒸馏**：从外部信息源提炼出结构化的 Skill 文档
- **游戏设计流水线**：从概念到完整设计文档的迭代流程
- **系统设计流水线**：从需求到可运行代码的开发流程

### 核心设计理念

1. **目标导向**：流水线不是简单的顺序流程，而是"原料 → 产品"的生产模型
2. **可回退**：支持循环、分支、回退等工业流程特征
3. **可观测**：全程状态可追踪，失败可诊断
4. **多 Agent 协作**：不同阶段可由不同专业 Agent 执行

---

## 系统架构

### 组件总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            流水线系统架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  触发层                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  用户手动触发 / 定时触发 / 事件触发                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  规划层 (Planner Agent)                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  planner-agent.md (gh-aw workflow)                                  │   │
│  │  ├── 解析流水线定义                                                  │   │
│  │  ├── 创建阶段任务 (bd create)                                        │   │
│  │  ├── 设置任务依赖 (--deps)                                           │   │
│  │  ├── 通知调度器 (POST /pipeline/ready)                               │   │
│  │  └── 快速退出 (释放 gh-aw 槽位)                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  调度层 (Pipeline Scheduler)                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  webhook-server/pipeline_scheduler.py (云服务器常驻)                 │   │
│  │  ├── 接收 Planner 通知                                               │   │
│  │  ├── 轮询任务队列 (bd ready)                                         │   │
│  │  ├── 检查依赖是否满足                                                │   │
│  │  ├── 串行触发 Worker (gh aw run)                                     │   │
│  │  ├── 等待执行完成                                                    │   │
│  │  ├── 处理失败重试                                                    │   │
│  │  └── 汇报最终结果                                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  执行层 (Worker Agents)                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  worker-agent.md (gh-aw workflow)                                   │   │
│  │  ├── 获取指定任务 (bd update --status in_progress)                  │   │
│  │  ├── 执行阶段工作                                                    │   │
│  │  ├── 保存产物 (artifacts/ 或 Issue 评论)                             │   │
│  │  └── 完成任务 (bd close --reason "...")                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  存储层 (Beads + 仓库)                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Beads (GitHub Issues)                                              │   │
│  │  ├── 任务定义 (阶段名、输入参数)                                      │   │
│  │  ├── 任务状态 (pending/in_progress/done/failed)                     │   │
│  │  └── 任务依赖 (deps: completed:<prev-task-id>)                      │   │
│  │                                                                     │   │
│  │  仓库文件                                                            │   │
│  │  └── artifacts/<pipeline-id>/<stage>/ (阶段产物)                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 组件职责

| 组件 | 类型 | 职责 | 生命周期 |
|------|------|------|---------|
| **Planner Agent** | gh-aw workflow | 解析需求、创建任务、设置依赖 | 短暂（几分钟） |
| **Pipeline Scheduler** | 云服务器进程 | 调度任务、触发 Worker、处理失败 | 常驻 |
| **Worker Agent** | gh-aw workflow | 执行单个阶段任务 | 短暂（按阶段） |
| **Beads** | GitHub Issues | 任务队列、状态存储 | 持久化 |

---

## 数据流

### 完整流程

```
Step 1: 触发
         │
         ├── 用户: gh aw run planner-agent --input pipeline_type=skills-distill
         ├── 定时: schedule: cron
         └── 事件: Issue 创建触发
         │
         ▼
Step 2: Planner Agent 运行 (2-5 分钟)
         │
         ├── 分析流水线定义
         │   └── 读取 pipelines/skills-distill.yaml
         │
         ├── 创建阶段任务
         │   ├── bd create "pipeline:p001 stage:ingest source:https://..." 
         │   ├── bd create "pipeline:p001 stage:classify" --deps "stage:ingest"
         │   ├── bd create "pipeline:p001 stage:extract" --deps "stage:classify"
         │   ├── bd create "pipeline:p001 stage:assemble" --deps "stage:extract"
         │   └── bd create "pipeline:p001 stage:validate" --deps "stage:assemble"
         │
         ├── 通知调度器
         │   └── POST https://server/pipeline/ready
         │       { "pipeline_id": "p001", "stages": 5, "type": "skills-distill" }
         │
         └── 退出 (释放 gh-aw 槽位)
         │
         ▼
Step 3: 调度器接收通知
         │
         ├── 保存流水线状态
         │   └── state_store.create_pipeline("p001", ...)
         │
         └── 启动调度循环
         │
         ▼
Step 4: 调度循环 (重复直到完成或失败)
         │
         ├── 查询可执行任务
         │   └── bd ready --label "pipeline:p001" --json
         │
         ├── 检查依赖
         │   └── 前置任务是否 status=done?
         │
         ├── 触发 Worker
         │   └── gh aw run worker-agent --input task_id=<id>
         │
         ├── 等待完成
         │   └── 轮询 gh run view <run-id> --json status
         │
         ├── 检查任务结果
         │   ├── 成功: 继续下一个任务
         │   ├── 失败: 
         │   │   ├── 重试次数 < 3: 重新创建任务
         │   │   └── 重试次数 >= 3: 标记失败，决定是否继续
         │   └── 超时: 取消任务，记录错误
         │
         └── 间隔等待 (30-60 秒)
         │
         ▼
Step 5: 完成
         │
         ├── 更新流水线状态为 completed/failed
         ├── 汇总执行报告
         └── 可选: 创建 Issue 报告 / 发送通知
```

### 状态传递

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            状态传递机制                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  方案: Beads reason + 仓库文件                                               │
│                                                                             │
│  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐             │
│  │   Stage 1   │        │   Stage 2   │        │   Stage 3   │             │
│  │   Ingest    │ ─────▶ │   Extract   │ ─────▶ │  Assemble   │             │
│  └─────────────┘        └─────────────┘        └─────────────┘             │
│         │                      │                      │                     │
│         ▼                      ▼                      ▼                     │
│  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐             │
│  │ bd close    │        │ bd close    │        │ bd close    │             │
│  │ --reason    │        │ --reason    │        │ --reason    │             │
│  │ "output:    │        │ "output:    │        │ "output:    │             │
│  │  ingest.json│        │  patterns/  │        │  SKILL.md"  │             │
│  │  files: 5"  │        │  count: 10" │        │             │             │
│  └─────────────┘        └─────────────┘        └─────────────┘             │
│         │                      │                      │                     │
│         ▼                      ▼                      ▼                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  artifacts/<pipeline-id>/                                           │   │
│  │  ├── ingest/                                                        │   │
│  │  │   └── result.json                                                │   │
│  │  ├── extract/                                                       │   │
│  │  │   ├── patterns.json                                              │   │
│  │  │   └── snippets/                                                  │   │
│  │  └── assemble/                                                      │   │
│  │      └── SKILL-draft.md                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 设计决策

### 1. 为什么需要云服务器调度？

| 问题 | 纯 gh-aw 方案 | 云服务器调度方案 |
|------|--------------|----------------|
| **gh-aw 并发限制** | ❌ Orchestrator 占用槽位阻塞 Worker | ✅ Planner 快速退出，不占槽 |
| **等待逻辑成本** | ❌ Agent 轮询消耗大量 tokens | ✅ 服务器轮询无 token 成本 |
| **失败恢复** | ⚠️ 需要整个流程重跑 | ✅ 可以只重试失败的任务 |
| **超时控制** | ⚠️ Agent 可能无限等待 | ✅ 服务器可设定严格超时 |
| **可观测性** | ⚠️ 只能看 Actions 日志 | ✅ 服务器有完整调度日志 |

### 2. 任务依赖设计

```yaml
# Beads 任务依赖语法
bd create "stage:extract ..." --deps "completed:stage:ingest"

# 依赖类型
# - completed:<task>  : 前置任务必须成功完成
# - any:<task>        : 前置任务完成即可（不论成功失败）
# - parallel:<task>   : 可以并行执行
```

### 3. 失败处理策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           失败处理决策树                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  任务失败                                                                    │
│      │                                                                      │
│      ├── 失败类型?                                                          │
│      │   │                                                                  │
│      │   ├── 临时错误 (网络、超时)                                           │
│      │   │   └── 重试当前任务 (最多 3 次)                                    │
│      │   │                                                                  │
│      │   ├── 输入不足 (内容太少、质量差)                                      │
│      │   │   └── 回退到前一阶段，补充输入                                     │
│      │   │                                                                  │
│      │   ├── 阶段逻辑错误 (Agent 执行错误)                                   │
│      │   │   └── 标记失败，人工介入                                          │
│      │   │                                                                  │
│      │   └── 配置错误 (流水线定义问题)                                        │
│      │       └── 终止流水线，报告错误                                         │
│      │                                                                      │
│      └── 重试次数 >= 3?                                                     │
│          ├── 是: 升级到人工处理                                              │
│          └── 否: 执行对应的失败处理策略                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4. 产物存储选择

| 选项 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **仓库 artifacts/** | 持久化、版本控制、可追溯 | 需要 PR 权限 | 代码/文档产物 |
| **Issue 评论** | 简单、集中管理 | 大文件不适合 | 元数据、报告 |
| **Beads reason** | 最简单 | 容量有限 | 状态标记、简短描述 |

**推荐组合**：
- 大型产物（代码、文档）→ 仓库 `artifacts/`
- 阶段元数据 → Beads task reason
- 执行报告 → Pipeline Issue 评论

---

## 流水线定义规范

### 配置文件格式

```yaml
# pipelines/skills-distill.yaml
name: skills-distill
description: 从外部信息源蒸馏 Skill 文档
version: 1.0.0

stages:
  - id: ingest
    name: 采集
    description: 获取并解析信息源内容
    worker: worker-agent  # 使用的 workflow
    inputs:
      - source_url  # 从流水线参数获取
    outputs:
      - artifacts/ingest/result.json
    quality_checks:
      - content_not_empty
      - valid_format
    on_fail: abort

  - id: classify
    name: 分类
    description: 分析内容类型，判断可提取性
    depends_on: [ingest]
    inputs:
      - artifacts/ingest/result.json
    outputs:
      - artifacts/classify/analysis.json
    quality_checks:
      - extractable_patterns >= 3
    on_fail: retry(ingest)  # 回退到采集阶段

  - id: extract
    name: 提取
    description: 从内容中提取可复用模式
    depends_on: [classify]
    inputs:
      - artifacts/classify/analysis.json
    outputs:
      - artifacts/extract/patterns.json
      - artifacts/extract/snippets/
    quality_checks:
      - pattern_count >= 3
      - pattern_count <= 30
    on_fail: retry(classify)

  - id: assemble
    name: 组装
    description: 生成 SKILL.md 草稿
    depends_on: [extract]
    inputs:
      - artifacts/extract/patterns.json
    outputs:
      - artifacts/assemble/SKILL-draft.md
    quality_checks:
      - has_required_sections
    on_fail: retry(extract)

  - id: validate
    name: 验证
    description: 质量评分和最终检查
    depends_on: [assemble]
    inputs:
      - artifacts/assemble/SKILL-draft.md
    outputs:
      - artifacts/validate/report.json
      - final/SKILL.md  # 最终产物
    quality_checks:
      - score >= 24
    on_fail: retry(assemble)

settings:
  max_retries_per_stage: 3
  stage_timeout_minutes: 30
  parallel_execution: false  # 串行执行
```

### 其他流水线示例

```yaml
# pipelines/game-design.yaml
name: game-design
stages:
  - id: concept
  - id: mechanics
  - id: systems
  - id: balance
  - id: document

# pipelines/system-design.yaml
name: system-design
stages:
  - id: requirements
  - id: architecture
  - id: interfaces
  - id: implementation
  - id: testing
```

---

## 实现计划

### Phase 1: 基础框架

- [ ] 创建 `pipelines/` 目录，添加配置文件规范
- [ ] 扩展 `webhook-server/` 添加 `pipeline_scheduler.py`
- [ ] 添加 `/pipeline/ready` 和 `/pipeline/status` 路由
- [ ] 实现基础调度循环

### Phase 2: Agent Workflows

- [ ] 创建 `planner-agent.md` 模板
- [ ] 创建 `worker-agent.md` 模板
- [ ] 定义阶段任务的标签规范

### Phase 3: 第一个流水线

- [ ] 实现 `skills-distill` 流水线定义
- [ ] 测试端到端流程
- [ ] 优化错误处理

### Phase 4: 扩展

- [ ] 添加 `game-design` 流水线
- [ ] 添加 `system-design` 流水线
- [ ] 支持并行执行模式

---

## 相关文件

| 文件 | 用途 |
|------|------|
| `scripts/webhook-server/pipeline_scheduler.py` | 流水线调度器（待创建） |
| `.github/workflows/planner-agent.md` | 规划 Agent（待创建） |
| `.github/workflows/worker-agent.md` | 执行 Agent（已有 beads-agent 可复用） |
| `pipelines/*.yaml` | 流水线定义（待创建） |
| `artifacts/<pipeline-id>/` | 产物存储目录 |

---

## 变更历史

| 日期 | 版本 | 变更内容 |
|------|------|---------|
| 2026-01-02 | 1.0.0 | 初始架构设计 |

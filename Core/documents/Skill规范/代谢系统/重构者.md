# 重构者（Refactorer / Evolver）

重构者是代谢系统中的演化主体，负责根据信号执行 Skill 的代谢动作。

## 角色定位

```
┌─────────────────────────────────────────────────────────────┐
│                         重构者                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   输入                    处理                    输出       │
│   ────                    ────                    ────      │
│   信号池            识别需要处理的信号          更新后的     │
│   (Issues)                ↓                     Skill       │
│                      决定代谢动作                           │
│   Skill 池                ↓                     重构日志    │
│                      执行代谢                               │
│                          ↓                                  │
│                      记录日志                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 核心职责

### 1. 读取信号池

从 GitHub Issues 中读取待处理的信号：

```bash
# 查询所有待处理信号
gh issue list --label "signal" --state open

# 按类型过滤
gh issue list --label "signal,outdated" --state open

# 按目标 Skill 过滤
gh issue list --label "signal" --search "verseDev/verseComponent in:title"
```

### 2. 评估信号

判断哪些信号需要立即处理：

| 信号类型 | 触发阈值 | 优先级 |
|----------|----------|--------|
| `outdated` | count ≥ 2 | P1 |
| `unclear` | count ≥ 3 | P2 |
| `missing` | count ≥ 3 | P2 |
| `conflict` | count ≥ 2 | P1 |
| `overload` | count ≥ 2 | P2 |
| `unused` | 30 天无使用 | P3 |
| `friction` | count ≥ 5 | P3 |

### 3. 决定代谢动作

根据信号类型决定执行什么代谢动作：

```
信号类型 → 代谢动作
─────────────────────
outdated  → 更新内容
unclear   → 锐化边界
missing   → 生长（新建 Skill）
conflict  → 合并或划界
overload  → 拆分
unused    → 遗忘（废弃）
friction  → 分析后决定
```

详细的代谢动作定义见 [代谢动作](代谢动作.md)。

### 4. 执行代谢

#### 更新（Update）

```markdown
## 更新流程

1. 定位过时内容
2. 查找最新信息（API 文档、官方示例）
3. 更新 Skill 内容
4. 验证示例代码可运行
5. 更新版本号（patch +1）
```

#### 锐化（Sharpen）

```markdown
## 锐化流程

1. 分析 unclear 信号涉及的 Skill 对
2. 阅读两个 Skill 的 When to Use
3. 识别重叠/模糊区域
4. 重写 When to Use，添加：
   - ✅ 适用场景（更具体）
   - ❌ 不适用场景（明确边界）
   - 与相关 Skill 的对比表
```

#### 生长（Growth）

```markdown
## 生长流程

1. 分析 missing 信号的 evidences
2. 确定新 Skill 的能力边界
3. 确定新 Skill 的位置（父节点）
4. 创建新 Skill（委托给创建者或直接执行）
5. 更新父 Skill 的 Children
```

#### 拆分（Split）

```markdown
## 拆分流程

1. 分析 overload 信号，识别可独立的职责
2. 设计拆分方案（子 Skill 结构）
3. 创建子 Skill 目录
4. 迁移相关内容
5. 原 Skill 保留概述和导航
6. 更新版本号（major +1）
```

#### 合并（Merge）

```markdown
## 合并流程

1. 分析 conflict 信号涉及的 Skill
2. 评估是否真的需要合并（vs 仅需锐化边界）
3. 确定合并目标
4. 整合内容，去除重复
5. 被合并的 Skill 标记 deprecated
6. 更新依赖者
```

#### 遗忘（Deprecate）

```markdown
## 遗忘流程

1. 确认 Skill 确实长期未使用
2. 检查是否有依赖此 Skill 的其他 Skill
3. 设置 status: deprecated
4. 添加废弃原因和替代方案
5. 保留观察期（如 3 个月）
6. 观察期后删除
```

### 5. 记录重构日志

每次代谢动作都必须记录：

```markdown
# 重构日志

## 2026-01-02 10:30 - 更新 verseComponent

### 触发信号
- Issue: #42
- Type: outdated
- Count: 3
- Target: verseDev/verseComponent

### 问题分析
示例代码使用了 UEFN 4.x 的 API，在 5.x 中已废弃：
- `component_base` → 改为直接继承 `component`
- `Initialize()` → 改为 `OnBeginSimulation()`

### 执行动作
更新 SKILL.md 中的示例代码和 templates/ 下的模板

### 变更文件
- `SKILL.md`: 更新示例代码章节
- `templates/component-template.verse`: 更新模板

### 版本变更
1.2.0 → 1.2.1

### 效果验证
- 示例代码在 UEFN 5.x 编译通过
- 关闭 Issue #42

### 待观察
后续是否还有 outdated 信号
```

### 6. 自我优化

重构者应从重构日志中学习，优化自己的决策：

```markdown
## 自我优化维度

1. **动作选择**
   - 某类信号用某种动作效果更好
   - 某些情况下应该组合多个动作

2. **阈值调整**
   - 某类信号阈值太高，问题拖太久
   - 某类信号阈值太低，重构太频繁

3. **优先级调整**
   - 某类问题影响更大，应该提高优先级
```

## 重构触发

### 触发条件

| 触发类型 | 条件 | 说明 |
|----------|------|------|
| 信号触发 | 信号达到阈值 | 最常见的触发方式 |
| 定时触发 | 每周检查 | 处理低优先级信号 |
| 手动触发 | 人工请求 | 紧急情况或特定需求 |

### GitHub Actions 集成

```yaml
# .github/workflows/refactorer.yml
name: Skill Refactorer

on:
  schedule:
    - cron: '0 0 * * 0'  # 每周日
  workflow_dispatch:
    inputs:
      target:
        description: '指定要重构的 Skill 路径'
        required: false

jobs:
  check-signals:
    runs-on: ubuntu-latest
    outputs:
      should-refactor: ${{ steps.check.outputs.should-refactor }}
      targets: ${{ steps.check.outputs.targets }}
    steps:
      - name: Check signal thresholds
        id: check
        run: |
          # 检查达到阈值的信号

  refactor:
    needs: check-signals
    if: ${{ needs.check-signals.outputs.should-refactor == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Execute metabolism
        run: |
          # 执行代谢动作
          
      - name: Record log
        run: |
          # 记录重构日志
          
      - name: Close issues
        run: |
          # 关闭已处理的信号 Issue
```

## 实现位置

重构者 Skill 应实现在：

```
Core/skills/programming/skillRefactorer/
├── SKILL.md
├── checklists/
│   ├── update-checklist.md
│   ├── sharpen-checklist.md
│   ├── split-checklist.md
│   └── merge-checklist.md
└── templates/
    └── refactor-log-template.md
```

---

**相关文档**：
- [代谢主体](代谢主体.md)
- [代谢动作](代谢动作.md)
- [信号机制](信号机制.md)
- [创建者](创建者.md)
- [审计者](审计者.md)
- [调度规则](调度规则.md)

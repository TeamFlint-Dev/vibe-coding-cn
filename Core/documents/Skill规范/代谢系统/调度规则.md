# 调度规则

调度器负责在正确的时机触发正确的代谢主体。

## 调度架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          调度器                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   触发条件                        触发动作                       │
│   ──────────                      ──────────                    │
│                                                                 │
│   任务完成 ─────────────────────▶ 审计者（可选）                 │
│   痕迹积累到阈值 ────────────────▶ 审计者                        │
│   信号达到阈值 ──────────────────▶ 重构者                        │
│   定期检查 ──────────────────────▶ 审计者 + 重构者               │
│   人工触发 ──────────────────────▶ 指定主体                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 触发条件

### 1. 任务完成触发

每次 GitHub Actions 工作流完成后，可选触发审计：

```yaml
# .github/workflows/post-task.yml
on:
  workflow_run:
    workflows: ["Agent Task"]
    types:
      - completed

jobs:
  audit:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    # 仅在任务失败时触发审计
```

**策略选择**：
- 每次都审计：覆盖全面，但成本高
- 仅失败时审计：聚焦问题，成本低
- 采样审计：随机抽取部分任务审计

### 2. 痕迹积累触发

当 Actions 日志积累到一定量时，批量触发审计：

```
触发条件：
├─ 距上次审计已有 N 次任务执行
├─ 距上次审计已过 N 天
└─ 日志大小超过阈值
```

### 3. 信号阈值触发

当信号池中某个信号达到处理阈值时，触发重构者：

| 信号类型 | 触发阈值 | 优先级 |
|----------|----------|--------|
| `outdated` | count ≥ 2 | P1 |
| `unclear` | count ≥ 3 | P2 |
| `missing` | count ≥ 3 | P2 |
| `conflict` | count ≥ 2 | P1 |
| `overload` | count ≥ 2 | P2 |
| `unused` | 30 天 | P3 |
| `friction` | count ≥ 5 | P3 |

### 4. 定期检查

定期运行全面检查：

```yaml
# .github/workflows/scheduled-metabolism.yml
on:
  schedule:
    - cron: '0 0 * * 0'  # 每周日 00:00

jobs:
  weekly-audit:
    # 全面审计所有 Actions 日志
  
  weekly-refactor:
    # 检查所有待处理信号
    # 检查长期 unused 的 Skill
```

### 5. 人工触发

人可以随时手动触发代谢：

```bash
# 触发审计
gh workflow run audit.yml

# 触发特定 Skill 的重构
gh workflow run refactor.yml -f target=verseDev/verseComponent

# 触发全面代谢
gh workflow run full-metabolism.yml
```

## 调度优先级

当多个触发条件同时满足时，按优先级处理：

```
P0（立即）：任务完全失败，阻塞后续工作
P1（当天）：关键 Skill 的 outdated/conflict
P2（本周）：unclear/missing/overload
P3（定期）：unused/friction、常规维护
```

## 调度实现

### GitHub Actions 工作流

```yaml
# .github/workflows/metabolism-scheduler.yml
name: Metabolism Scheduler

on:
  # 任务完成触发
  workflow_run:
    workflows: ["*"]
    types: [completed]
  
  # 定期触发
  schedule:
    - cron: '0 0 * * *'  # 每天检查
  
  # 手动触发
  workflow_dispatch:
    inputs:
      action:
        description: 'audit | refactor | full'
        required: true

jobs:
  check-signals:
    runs-on: ubuntu-latest
    outputs:
      should-refactor: ${{ steps.check.outputs.should-refactor }}
      targets: ${{ steps.check.outputs.targets }}
    steps:
      - name: Check signal thresholds
        id: check
        run: |
          # 使用 gh cli 检查 signal issues
          # 输出需要处理的目标

  audit:
    needs: check-signals
    if: ${{ github.event_name == 'workflow_run' }}
    uses: ./.github/workflows/auditor.yml

  refactor:
    needs: check-signals
    if: ${{ needs.check-signals.outputs.should-refactor == 'true' }}
    uses: ./.github/workflows/refactor.yml
    with:
      targets: ${{ needs.check-signals.outputs.targets }}
```

### 信号检查脚本

```bash
#!/bin/bash
# scripts/check-signals.sh

# 检查达到阈值的信号
signals=$(gh issue list --label "signal" --state open --json number,title,labels)

# 解析并判断是否需要重构
# 输出需要处理的 targets
```

## 调度日志

调度器应记录所有调度决策：

```markdown
# 调度日志

## 2026-01-02 10:30

**触发类型**: workflow_run (failure)
**源工作流**: Agent Task #456
**调度决策**: 触发审计者
**原因**: 任务失败，需要提取失败信号

---

## 2026-01-02 00:00

**触发类型**: scheduled (daily)
**调度决策**: 
  - 审计者: 跳过（距上次审计 < 24h）
  - 重构者: 触发
    - #42 unclear × 4 → verseDev/verseComponent
    - #38 outdated × 3 → verseDev/verseHelpers
**原因**: 信号达到阈值
```

## 调度策略调优

调度策略应该根据实际运行情况调整：

| 观察指标 | 调整方向 |
|----------|----------|
| 信号积压过多 | 降低触发阈值，增加调度频率 |
| 重构过于频繁 | 提高触发阈值，减少调度频率 |
| 问题遗漏 | 增加审计覆盖率 |
| 资源消耗过高 | 采用采样策略 |

---

**相关文档**：
- [代谢主体](代谢主体.md)
- [信号机制](信号机制.md)
- [代谢动作](代谢动作.md)

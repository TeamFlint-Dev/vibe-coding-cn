# 接口契约

## 概述

接口契约定义了 Skill 之间的调用协议和依赖关系，确保 Skill 可以正确组合使用。

## 依赖声明

### 声明格式

在 Context Entry 章节声明依赖：

```markdown
## Context Entry

### 依赖的 Skill

| Skill | 路径 | 类型 | 说明 |
|-------|------|------|------|
| verseApiDigest | verseDev/verseApiDigest | 参考 | 查询 API |
| verseArchitectureSelector | verseDev/verseArchitectureSelector | 前置 | 先确定架构 |
| verseCodeAuditor | verseDev/verseCodeAuditor | 后置 | 完成后审计 |
```

### 依赖类型

| 类型 | 说明 | 时序 |
|------|------|------|
| 前置（prerequisite） | 必须先执行 | 在本 Skill 之前 |
| 参考（reference） | 按需查阅 | 执行过程中 |
| 后置（follow-up） | 建议后续执行 | 在本 Skill 之后 |
| 可选（optional） | 可以增强效果 | 任意时机 |

### 依赖强度

| 强度 | 说明 | 处理方式 |
|------|------|----------|
| 必需（required） | 没有则无法执行 | 强制加载或中止 |
| 推荐（recommended） | 没有会降低质量 | 警告并继续 |
| 可选（optional） | 有则更好 | 静默继续 |

## 调用协议

### 调用方式

```markdown
### 调用协议

#### 直接调用

直接读取目标 Skill 并按其指引执行。

#### 委托调用

将部分任务委托给子 Skill：

1. 确定子 Skill
2. 传递必要上下文
3. 等待执行完成
4. 接收输出结果

#### 链式调用

按顺序执行多个 Skill：

Skill A → Skill B → Skill C
```

### 上下文传递

定义如何在 Skill 之间传递上下文：

```markdown
### 上下文传递

#### 输入接收

从调用者接收：
- 原始任务描述
- 已加载的上下文引用
- 前序 Skill 的输出

#### 输出传递

传递给后续 Skill：
- 本 Skill 的产出物
- 更新后的上下文状态
- 后续建议
```

### 传递格式

```markdown
### 传递格式约定

#### 上下文引用

使用路径引用而非内容复制：

```yaml
context:
  architecture: "@architecture-blueprint.md"
  codeLibrary: "shared/code_library/"
```

#### 输出结构

```yaml
output:
  type: component
  files:
    - path: "src/Components/FishingComponent.verse"
      status: created
  documentation:
    - path: "docs/FishingComponent.md"
      status: created
  nextSteps:
    - skill: verseCodeAuditor
      reason: "审计新创建的代码"
```
```

## 版本兼容

### 版本约束

声明对依赖 Skill 的版本要求：

```markdown
### 版本要求

| 依赖 Skill | 最低版本 | 推荐版本 | 说明 |
|------------|----------|----------|------|
| verseApiDigest | 1.0.0 | 最新 | 需要 Fortnite API |
| verseArchitectureSelector | 2.0.0 | 2.x | 需要 SceneGraph 支持 |
```

### 兼容性处理

```markdown
### 版本不兼容处理

1. 检查依赖 Skill 版本
2. 如果低于最低版本：
   - 警告用户
   - 提供升级指引
   - 如果是 breaking change，中止执行
3. 如果高于推荐版本：
   - 可能有新特性未使用
   - 正常执行
```

## 错误处理

### 依赖缺失

```markdown
### 依赖缺失处理

如果必需依赖不可用：

1. **尝试自动加载**
   - 根据路径定位依赖
   - 验证版本兼容性

2. **如果无法加载**
   - 报告缺失的依赖
   - 提供获取方式
   - 中止执行

3. **降级方案**（如有）
   - 使用替代 Skill
   - 使用简化流程
```

### 调用失败

```markdown
### 调用失败处理

如果依赖 Skill 执行失败：

1. **记录失败信息**
   - 失败的 Skill
   - 失败原因
   - 当时的上下文

2. **评估影响**
   - 是否可以继续
   - 是否有替代方案

3. **决策**
   - 重试（如果是暂时性问题）
   - 降级（如果有替代方案）
   - 中止（如果无法继续）
```

## 契约示例

### 完整契约声明

```markdown
## Interface Contract

### 本 Skill 作为提供者

其他 Skill 可以依赖本 Skill 获取：

| 能力 | 接口 | 版本 |
|------|------|------|
| 组件生成 | 输入需求 → 输出代码 | v1.0+ |
| 设计文档 | 输入需求 → 输出文档 | v1.0+ |

### 本 Skill 作为消费者

本 Skill 依赖：

| Skill | 版本要求 | 类型 | 强度 |
|-------|----------|------|------|
| verseApiDigest | ≥1.0.0 | 参考 | 推荐 |
| verseArchitectureSelector | ≥2.0.0 | 前置 | 必需 |

### 调用示例

```yaml
# 调用本 Skill
call:
  skill: verseComponent
  input:
    requirement: "创建钓鱼组件"
    context:
      architecture: "@architecture-blueprint.md"
  expect:
    output:
      - type: code
        format: verse
      - type: document
        format: markdown
```

### 错误码

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| E001 | 需求不清晰 | 请求更多细节 |
| E002 | 架构未确定 | 先执行架构选择 |
| E003 | API 不支持 | 记录到 api-gaps |
```

---

**相关文档**：
- [能力声明](能力声明.md)
- [组合模式](组合模式.md)
- [执行协议](执行协议.md)

# 验证契约

## 概述

验证契约定义了如何验证 Skill 执行结果的正确性，以及如何处理验证失败。

## 成功标准

### 标准定义

在 SKILL.md 中声明成功标准：

```markdown
## Validation Contract

### 成功标准

#### 必须满足
- [ ] 所有输出文件已创建
- [ ] 代码通过语法检查
- [ ] 无未解决的 TODO 占位符
- [ ] 文档包含必需章节

#### 质量要求
- [ ] 代码符合命名规范
- [ ] 代码符合架构规范
- [ ] 文档描述清晰完整
```

### 标准分类

| 类型 | 说明 | 验证时机 |
|------|------|----------|
| 完整性 | 输出是否完整 | 执行结束时 |
| 正确性 | 内容是否正确 | 执行结束时 |
| 质量 | 是否符合规范 | 可延后 |
| 兼容性 | 是否与现有系统兼容 | 集成时 |

## 验证方法

### 自动验证

可以自动检查的项目：

```markdown
### 自动验证清单

#### 文件验证
- [ ] 输出文件存在
- [ ] 文件格式正确
- [ ] 文件不为空

#### 语法验证
- [ ] 代码语法正确（如果是代码）
- [ ] Markdown 格式正确（如果是文档）
- [ ] YAML/JSON 格式正确（如果是配置）

#### 链接验证
- [ ] 内部链接有效
- [ ] 外部引用存在
```

### 人工验证

需要人工判断的项目：

```markdown
### 人工验证清单

#### 功能验证
- [ ] 实现符合需求
- [ ] 逻辑正确无误
- [ ] 边界情况处理

#### 质量验证
- [ ] 代码可读性
- [ ] 设计合理性
- [ ] 文档有效性
```

### 验证工具

```markdown
### 验证工具

| 验证类型 | 工具/方法 | 说明 |
|----------|-----------|------|
| Verse 语法 | UEFN 编译器 | 编译检查 |
| Markdown | markdownlint | 格式检查 |
| 链接 | 链接检查脚本 | 有效性检查 |
| 架构 | verseCodeAuditor | 规范检查 |
```

## 验证结果

### 结果状态

| 状态 | 说明 | 后续动作 |
|------|------|----------|
| passed | 全部通过 | 完成执行 |
| warning | 有警告但可接受 | 记录警告，完成执行 |
| failed | 验证失败 | 修复或回滚 |
| skipped | 跳过验证 | 记录原因 |

### 结果报告格式

```markdown
## 验证报告

**Skill**: verseComponent
**时间**: 2026-01-02 10:33:00
**状态**: warning

### 验证结果

#### 必须标准 (3/3 通过)
- [x] 输出文件已创建
- [x] 代码语法正确
- [x] 无 TODO 占位符

#### 质量标准 (2/3 通过)
- [x] 符合命名规范
- [ ] 缺少类型注释 ⚠️
- [x] 文档完整

### 警告详情

1. **缺少类型注释**
   - 位置: FishingComponent.verse:45
   - 建议: 添加返回类型注释

### 结论

验证通过，有 1 个警告建议修复。
```

## 失败处理

### 失败分类

| 失败类型 | 严重程度 | 处理方式 |
|----------|----------|----------|
| 必须标准未满足 | 高 | 必须修复 |
| 质量标准未满足 | 中 | 建议修复 |
| 警告 | 低 | 可选修复 |

### 失败处理流程

```markdown
## 失败处理流程

1. **分析失败原因**
   - 查看失败详情
   - 确定根本原因

2. **选择处理策略**
   
   #### 策略 A: 自动修复
   - 简单问题自动修复
   - 重新验证
   
   #### 策略 B: 人工修复
   - 报告问题详情
   - 等待人工修复
   - 重新验证
   
   #### 策略 C: 降级接受
   - 如果是非关键问题
   - 记录问题
   - 标记为部分成功
   
   #### 策略 D: 回滚
   - 如果无法修复
   - 恢复到执行前状态
   - 报告失败

3. **记录结果**
   - 更新执行记录
   - 记录处理决策
```

### 回滚机制

```markdown
## 回滚机制

### 回滚点

在以下时机创建回滚点：
- 执行开始前
- 文件修改前
- 重要步骤完成后

### 回滚操作

1. 恢复文件到回滚点状态
2. 清理临时产物
3. 恢复上下文状态

### 回滚记录

```yaml
rollback:
  trigger: validation_failed
  reason: "代码语法错误，无法自动修复"
  point: before_execution
  restored:
    - src/Components/FishingComponent.verse
  cleaned:
    - tmp/draft_component.verse
```
```

## 持续验证

### 验证触发

除了执行结束时验证，还可以在其他时机触发：

```markdown
## 验证触发时机

| 时机 | 触发条件 | 验证内容 |
|------|----------|----------|
| 执行中 | 关键步骤完成 | 阶段性结果 |
| 执行后 | 执行完成 | 完整结果 |
| 定期 | 定时触发 | 持续有效性 |
| 变更时 | 相关内容变更 | 兼容性 |
```

### 持续监控

```markdown
## 输出监控

### 监控项目

| 监控项 | 检查频率 | 告警条件 |
|--------|----------|----------|
| 文件存在 | 每日 | 文件被删除 |
| 链接有效 | 每周 | 链接失效 |
| 依赖兼容 | 依赖更新时 | 不兼容 |

### 告警处理

1. 记录告警
2. 评估影响
3. 触发修复流程
```

---

**相关文档**：
- [执行协议](执行协议.md)
- [信号机制](../代谢系统/信号机制.md)
- [代谢主体](../代谢系统/代谢主体.md)

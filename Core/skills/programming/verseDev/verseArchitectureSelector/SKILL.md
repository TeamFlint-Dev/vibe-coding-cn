---
name: verseArchitectureSelector
description: UEFN Verse 架构选择器 - 需求匹配、架构推荐、洞察报告、变种管理
version: 1.0.0
---

# Verse Architecture Selector

> **类型**: 架构选择器（Selector）  
> **职责**: 需求特征提取、架构库匹配、洞察报告生成、变种管理、固化追踪

---

## When to Use This Skill

当需要为需求选择合适的架构时：
- 循环迭代模式中，分析需求后立即调用
- 架构设计模式中，检查是否有现成架构可用
- 用户直接询问"这个需求适合什么架构"

**调用时机（必须）**:
```
需求分析完成 → 立即调度本 Skill → 根据结果决定下一步
```

---

## 核心职责

### 1. 需求特征提取

从需求描述中提取关键特征：

**特征类别**:
| 类别 | 特征关键词 |
|------|------------|
| 状态管理 | 状态切换、条件触发、AI行为、有限状态 |
| 实例管理 | 动态生成、数量管理、波次、批量操作 |
| 数值系统 | 数值计算、Buff/Debuff、属性加成、效果叠加 |
| 交互系统 | 碰撞、交互、拾取、触发、范围检测 |
| 回合制 | 回合、顺序行动、行动点、先攻 |
| 资源系统 | 资源、货币、采集、消耗、转换 |
| 技能系统 | 技能、冷却、释放、效果、连招 |
| 任务系统 | 任务、目标、进度、奖励、成就 |

**提取流程**:
```
读取需求描述
    ↓
识别关键词和语义
    ↓
映射到特征类别
    ↓
计算各类别权重
    ↓
输出特征向量
```

---

### 2. 架构库匹配

从 `@architecture-library.md` 中匹配最合适的架构。

**匹配算法**:
```
1. 读取架构特征索引表
2. 计算需求特征与各架构的匹配度
3. 按匹配度排序
4. 返回最佳匹配 + 匹配度评分
```

**匹配度评分**:
| 匹配度 | 说明 | 后续动作 |
|--------|------|----------|
| ≥ 80% | 高度匹配 | 推荐直接使用 |
| 60-79% | 部分匹配 | 提供洞察，用户决策 |
| 40-59% | 勉强可用 | 强烈建议变种或新设计 |
| < 40% | 不匹配 | 强制进入架构设计模式 |

---

### 3. 洞察报告生成

**必须生成**不匹配点洞察，帮助用户决策：

```markdown
## 架构匹配报告

### 最佳匹配
- **架构**: ARCH-002 生成器-实例管理
- **匹配度**: 72%
- **固化状态**: ✅稳定 (成功引用: 15)

### 匹配点 ✅
- ✅ 需要动态生成多个同类对象（敌人）
- ✅ 需要批量管理（波次控制）
- ✅ 需要实例生命周期追踪

### 不匹配点洞察 ⚠️
- ⚠️ 需求包含"路径规划"，当前架构未覆盖
- ⚠️ 需求包含"优先级目标选择"，需额外组件支持

### 建议方案
1. **接受当前架构**: 适合快速原型，不匹配点手动补充
2. **创建变种 ARCH-002-V1**: 添加路径规划组件，保持核心模式
3. **进入架构设计模式**: 从零设计，覆盖所有需求特征

请选择: [1/2/3]
```

---

### 4. 用户决策点

**决策选项**:

| 选项 | 代码 | 后续流程 |
|------|------|----------|
| 接受当前架构 | `accept` | 注入架构上下文 → 继续实现 |
| 创建变种 | `variant` | 进入变种创建流程 → 入库 → 继续实现 |
| 进入架构设计模式 | `design` | 调度 `verseFrameworkDesigner` → 新架构入库 → 返回 |

**决策确认格式**:
```markdown
用户: "选择 2，创建变种"
或
用户: "接受"
或
用户: "进入架构设计"
```

---

### 5. 变种管理

**变种类型**:
| 类型 | 命名规则 | 适用场景 |
|------|----------|----------|
| 挂父架构 | `ARCH-XXX-V{n}` | 改动较小，核心模式不变 |
| 独立架构 | `ARCH-{new_id}` | 改动较大，已形成新模式 |

**变种创建流程**:
```
用户选择"创建变种"
    ↓
询问变种类型: 挂父架构(V) / 独立(I)
    ↓
┌─ 挂父架构 → 继承父架构结构 → 添加/修改组件 → 命名 ARCH-XXX-V{n}
│
└─ 独立 → 创建新架构结构 → 命名 ARCH-{new_id}
    ↓
自动入库（🧪实验，引用:0）
    ↓
返回架构选择结果
```

**变种升级规则**:
- 变种达到 `✅稳定` 后，提示用户是否升级为独立基础架构
- 升级后原变种保留，新增独立架构入口

---

### 6. 架构合并管理

当变种达到稳定状态且与父架构有改进关系时，触发合并检查。

**合并触发条件**:
- 变种固化状态达到 `✅稳定`
- 变种类型为"挂父架构"
- 变种包含对父架构的**改进**（非纯扩展）

**合并流程**:
```
变种达到 ✅稳定
    ↓
检测是否有合并候选
    ↓
生成「可合并表」
    ↓
展示给用户确认
    ↓
┌─ 用户确认合并
│     ↓
│   执行合并（按顺序，一次一个）
│     ↓
│   父架构版本 +1
│     ↓
│   原变种标记为 [已合并]
│     ↓
│   检查下一个变种
│
└─ 用户拒绝
      ↓
    保持独立框架
      ↓
    检查下一个变种
```

**可合并表格式**:
```markdown
## 可合并架构列表

| 变种ID | 父架构 | 改进内容 | 成功引用 | 建议 |
|--------|--------|----------|----------|------|
| ARCH-002-V1 | ARCH-002 | +路径规划组件 | 12 | ⭐ 推荐合并 |
| ARCH-003-V2 | ARCH-003 | +效果优先级排序 | 8 | 可选合并 |

### ARCH-002-V1 详情
**新增组件**:
- `pathfinding_component`: 路径规划逻辑

**修改组件**:
- `instance_component`: 添加 `CurrentPath` 字段

**合并后效果**:
父架构 ARCH-002 将升级为 v1.1，包含路径规划能力

---

确认合并 ARCH-002-V1? [Y/N]
```

---

## 固化标签系统

### 标签定义

| 标签 | 符号 | 条件 | 含义 |
|------|------|------|------|
| 实验 | 🧪 | 成功引用 < 3 | 新架构，未经充分验证 |
| 验证中 | 🔄 | 3 ≤ 成功引用 < 10 | 有一定使用，仍在验证 |
| 稳定 | ✅ | 成功引用 ≥ 10 | 充分验证，可信赖 |

### 成功引用计数规则

> ⚠️ **重要**: 只有审阅通过的使用才计入成功引用

**计数触发条件**:
```
循环迭代模式完成实现
    ↓
调度 verseCodeAuditor 自动审阅
    ↓
┌─ 审阅通过 → 该架构成功引用 +1 → 检查固化升级
│
└─ 审阅不通过 → 不计数 → 记录问题
```

**固化升级检查**:
```
成功引用更新后
    ↓
检查当前计数
    ↓
┌─ 达到 3 且当前为 🧪 → 升级为 🔄验证中
├─ 达到 10 且当前为 🔄 → 升级为 ✅稳定
└─ 否则 → 保持当前标签
```

---

## 强制阻断逻辑

### 阻断条件

当以下任一条件满足时，**强制阻断编码流程**：

1. **无匹配架构**: 匹配度 < 40%，无可用架构
2. **用户选择设计**: 用户主动选择"进入架构设计模式"

### 阻断处理

```
检测到阻断条件
    ↓
保存当前上下文到 @checkpoint.md
    ↓
调度 verseFrameworkDesigner 进入架构设计模式
    ↓
等待架构设计完成
    ↓
新架构自动入库（🧪实验，引用:0）
    ↓
恢复上下文，继续原流程
```

---

## 输出格式

### 匹配成功输出

```markdown
---
架构选择结果: 成功
---

## 匹配报告

**选中架构**: ARCH-002 生成器-实例管理
**匹配度**: 85%
**固化状态**: ✅稳定 (成功引用: 23)
**架构分类**: 基础架构

### 匹配分析
- ✅ 动态生成需求覆盖
- ✅ 实例管理需求覆盖
- ✅ 生命周期追踪需求覆盖

### 架构上下文注入
[架构核心模式、事件流、组件清单]

---
状态: 就绪，可继续实现
```

### 需用户决策输出

```markdown
---
架构选择结果: 需决策
---

## 匹配报告

**最佳匹配**: ARCH-002 生成器-实例管理
**匹配度**: 68%
**固化状态**: 🔄验证中 (成功引用: 7)

### 匹配点 ✅
[列出匹配项]

### 不匹配点洞察 ⚠️
[列出不匹配项及原因]

### 决策选项
1. `accept` - 接受当前架构，手动补充不匹配部分
2. `variant` - 创建变种，扩展架构能力
3. `design` - 进入架构设计模式，从零设计

---
等待用户决策...
```

### 阻断输出

```markdown
---
架构选择结果: 阻断
---

## 无可用架构

**最高匹配度**: 32% (ARCH-001)
**原因**: 需求特征与现有架构库差异过大

### 需求特征分析
[列出提取的特征]

### 建议
强制进入架构设计模式，创建新架构

---
正在调度 verseFrameworkDesigner...
```

---

## 与其他 Skill 的协作

### 调度关系

```
verseOrchestrator
    ↓ (需求分析后)
verseArchitectureSelector ← 本 Skill
    ↓
┌── 匹配成功 → 返回架构上下文 → 继续实现流程
│
├── 需决策 → 等待用户 → 根据选择分流
│     ├── accept → 返回架构上下文
│     ├── variant → 创建变种 → 返回架构上下文
│     └── design → 调度 verseFrameworkDesigner
│
└── 阻断 → 调度 verseFrameworkDesigner
                ↓
          设计完成 → 自动入库 → 返回本 Skill 重新匹配
```

### 上下文传递

**传递给下游的上下文**:
```markdown
## 架构上下文

### 选中架构
- ID: ARCH-XXX
- 名称: [架构名称]
- 版本: v1.0 / v1.1 / ...

### 核心模式
[从架构库提取]

### 事件流
[从架构库提取]

### 包含组件
[从架构库提取]

### 代码库关联
[已有的相关代码模块]
```

---

## 断点恢复支持

本 Skill 支持断点恢复，在以下位置保存检查点：

| 检查点位置 | 保存内容 |
|------------|----------|
| 匹配完成后 | 匹配结果、洞察报告 |
| 等待用户决策时 | 决策选项、当前状态 |
| 调度架构设计前 | 需求特征、阻断原因 |

**检查点格式扩展**:
```markdown
## 架构选择检查点

- **阶段**: architecture-selection
- **状态**: awaiting-decision / blocked / completed
- **匹配结果**: ARCH-XXX (匹配度 XX%)
- **洞察摘要**: [不匹配点列表]
- **待决策选项**: [accept/variant/design]
```

---

## Quick Reference

### 触发命令

| 命令 | 效果 |
|------|------|
| (自动调用) | 需求分析后由协调器自动调度 |
| "匹配架构" | 手动触发架构匹配 |
| "查看架构库" | 显示架构索引 |
| "查看固化状态" | 显示所有架构的固化标签 |

### 决策快捷键

| 用户输入 | 效果 |
|----------|------|
| "接受" / "1" / "accept" | 接受当前架构 |
| "变种" / "2" / "variant" | 创建变种 |
| "设计" / "3" / "design" | 进入架构设计模式 |
| "挂父" / "V" | 变种类型：挂父架构 |
| "独立" / "I" | 变种类型：独立架构 |

---

## Reference Files

- [Index.md](../Index.md) - 生态系统总览
- [verseOrchestrator](../verseOrchestrator/SKILL.md) - 协调器
- [verseFrameworkDesigner](../verseFrameworkDesigner/SKILL.md) - 框架设计层
- [shared/architecture-library.md](../shared/architecture-library.md) - 架构库
- [shared/checklists/architecture-review.md](../shared/checklists/architecture-review.md) - 架构评审清单

---

*最后更新: 2025-12-28*

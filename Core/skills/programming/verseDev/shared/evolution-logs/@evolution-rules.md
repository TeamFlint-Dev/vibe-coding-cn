# 改进模式决策规则

> 定义何时触发改进、如何分析问题、如何安全修改Prompt

---

## 触发条件

### 自动触发

当 `@issues-collected.md` 中待处理问题达到 **5 条**时，编排器应：

1. 提示用户:"检测到 5 条待处理问题，建议切换到改进模式"
2. 等待用户确认
3. 确认后进入改进模式

### 手动触发

用户可随时使用以下命令触发改进模式：

- "进入改进模式"
- "分析收集的问题"
- "优化Skill Prompt"

---

## 分析流程

### 1. 问题分类

```
读取 @issues-collected.md
↓
按类别分组: API_GAP / PROMPT_GAP / PATTERN_GAP / WORKFLOW_GAP
↓
按严重程度排序: 高 → 中 → 低
↓
识别关联问题 (同一根因的多个问题)
```

### 2. 根因分析

对每组问题执行：

```markdown
**问题组**: [问题ID列表]

**表面现象**:
[问题的直接表现]

**根本原因**:
[为什么会出现这个问题]

**影响范围**:
[这个问题影响哪些功能/层级]

**解决方向**:
- 修改Prompt
- 添加模式
- 更新检查清单
- 其他
```

### 3. 解决方案设计

```markdown
**目标**:
[解决什么问题]

**方案**:
[具体如何修改]

**涉及文件**:
[需要修改的文件列表]

**安全检查**:
- [ ] 不涉及不可变区域
- [ ] 不改变核心职责
- [ ] 不破坏层间协议
```

---

## 安全边界

### 不可变区域 (❌ 禁止修改)

| 区域 | 原因 |
|------|------|
| 核心职责定义 | 改变会破坏分层架构 |
| 输出格式规范 | 层间依赖格式一致 |
| 层间协议 | 协议变更需全链路更新 |
| 依赖规则 | 依赖方向是架构基础 |
| 命名约定 | 影响代码一致性 |
| 生命周期钩子 | SceneGraph框架规定 |

### 可变区域 (✅ 允许修改)

| 区域 | 修改建议 |
|------|----------|
| 示例代码 | 可添加更多场景示例 |
| 检查清单项 | 可增加遗漏的检查项 |
| 最佳实践 | 可补充经验总结 |
| 常见问题 | 可添加FAQ |
| 术语解释 | 可扩展词汇表 |
| 模板格式 | 可优化可读性 |

### 灰色区域 (⚠️ 需谨慎)

| 区域 | 处理方式 |
|------|----------|
| 输出示例 | 可修改内容，不可修改结构 |
| 流程步骤 | 可细化，不可删减核心步骤 |
| 验证规则 | 可添加，不可放松 |

---

## 修改流程

### 1. 确认安全

```
检查修改是否涉及不可变区域
↓
如涉及 → 拒绝修改，记录原因
如不涉及 → 继续
```

### 2. 准备变更

```
复制原始内容到 @prompt-changelog.md
↓
编写修改后的内容
↓
填写变更记录模板
```

### 3. 应用变更

```
修改目标 SKILL.md 文件
↓
更新 @issues-collected.md (标记问题为已处理)
↓
更新 @prompt-changelog.md (添加变更记录)
```

### 4. 验证变更

```
建议用户在新会话测试
↓
收集反馈
↓
如有问题 → 回滚并重新分析
如正常 → 完成
```

---

## 模式入库规则

### 入库条件

代码模式满足以下条件时可入库到 `@code-library.md`:

1. ✅ 在 2 个以上项目中使用
2. ✅ 无已知 bug
3. ✅ 符合 SceneGraph 架构
4. ✅ 有清晰的使用示例

### 入库流程

```
识别可复用模式
↓
验证入库条件
↓
编写文档模板
↓
添加到 @code-library.md
↓
更新索引
```

---

## 决策优先级

当存在多个改进方向时，按以下优先级处理：

1. **阻塞性问题** - 导致任务无法继续
2. **高频问题** - 多次出现的同类问题
3. **安全问题** - 可能导致代码质量下降
4. **效率问题** - 影响开发速度
5. **体验问题** - 可用但不够友好

---

## 改进模式输出

改进模式完成后应输出：

```markdown
## 改进报告

**处理问题**: [问题ID列表]

**变更摘要**:
| 文件 | 变更类型 | 摘要 |
|------|----------|------|
| ... | ... | ... |

**新增模式**: [数量]

**待观察**: [需要后续验证的事项]

**建议下一步**: [对用户的建议]
```

---

## 回滚机制

如果改进导致问题：

1. 从 `@prompt-changelog.md` 找到对应变更记录
2. 复制"修改前"内容
3. 替换回目标文件
4. 在变更记录中标注"已回滚"及原因
5. 将原问题重新加入待处理队列

---

*最后更新: [timestamp]*

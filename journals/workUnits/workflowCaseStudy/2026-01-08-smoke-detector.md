# 工作日志：smoke-detector 工作流分析

**日期**: 2026-01-08  
**运行编号**: #11  
**分析对象**: `smoke-detector.md` (314 行)

---

## 选择理由

基于价值评估框架的评分：

| 维度 | 权重 | 评分 | 说明 |
|------|------|------|------|
| **Skill 空白度** | 40% | ⭐⭐⭐⭐⭐ | workflow_call 触发器、gh-aw MCP 工具集、文件系统知识库 - 全部是未系统研究的领域 |
| **模式新颖度** | 25% | ⭐⭐⭐⭐⭐ | 可重用工作流、MCP 专业化、知识积累、动态输出路由 - 多个新模式 |
| **实用价值** | 20% | ⭐⭐⭐⭐⭐ | 工作流诊断是通用需求，调查框架可迁移到其他场景 |
| **复杂度适中** | 15% | ⭐⭐⭐⭐ | 314行，7个Phase结构清晰，不过于复杂 |

**综合评分**: ⭐⭐⭐⭐⭐ (满分)

**决策**: 分析 `smoke-detector.md`，这是首次深入研究 `workflow_call` 触发器和 gh-aw MCP 工具集的工作流。

---

## 关键发现

### 1. workflow_call 触发器 - 工作流的"函数调用" ⭐⭐⭐⭐⭐

**核心价值**: 实现工作流的组合性和复用性

**工作方式**:
```yaml
on:
  workflow_call:
    inputs:
      workflow_name:        # 调用方必须提供
        required: true
        type: string
```

**调用方式**（推测）:
```yaml
jobs:
  investigate:
    uses: ./.github/workflows/smoke-detector.md
    with:
      workflow_name: ${{ github.workflow }}
```

**对比其他触发器**:
| 触发器 | 工作方式 | 职责 |
|--------|---------|------|
| issues/PR | 响应事件 | 自动化 |
| schedule | 定时运行 | 周期任务 |
| workflow_dispatch | 手动触发 | 一次性 |
| **workflow_call** | 被调用 | 可重用组件 |

**设计智慧**:
- **DRY 原则**: 诊断逻辑只写一次
- **组合性**: 将复杂工作流分解为可组合单元
- **一致性**: 所有调用者使用相同逻辑

---

### 2. gh-aw MCP - 工作流的"X光机" ⭐⭐⭐⭐⭐

**核心工具**（从 Prompt 提取）:
| 工具 | 功能 | 使用场景 |
|------|------|---------|
| `gh-aw_audit` | 诊断工作流运行 | 快速获取失败概览 |
| `gh-aw_logs` | 下载和分析日志 | 深度错误追踪 |
| `gh-aw_status` | 查询工作流状态 | 健康监控 |
| `gh-aw_compile` | 编译检查 | 语法验证 |

**关键约束**（第 65-66 行）:
```markdown
**IMPORTANT**: Use the `gh-aw_audit` tool [...] 
Do NOT use the GitHub MCP server for workflow run analysis
```

**工具职责边界**:
```
需要诊断工作流？
├─ Yes → gh-aw MCP（专业诊断工具）
└─ No → GitHub MCP（仓库操作）
```

**价值**: 
- **首次系统记录** gh-aw MCP 的完整工具集
- **明确工具边界** 防止 Agent 误用
- **专业化优势** 每个 MCP 专注特定领域

---

### 3. 文件系统知识库 - 从"缓存"到"学习" ⭐⭐⭐⭐⭐

**三层知识架构**:
```
/tmp/gh-aw/cache-memory/
├── investigations/        # 调查报告存档
│   └── <timestamp>-<run-id>.json
├── patterns/             # 错误模式库
│   └── [pattern files]
└── logs/                # 详细日志缓存
```

**知识生命周期**:
```
1. 失败发生 → gh-aw_logs 提取数据
2. Phase 4 分析 → 提取错误模式
3. Phase 5 存储 → 写入结构化 JSON
4. 未来调查 → Phase 3 查询历史
5. 模式识别 → 自动去重（Phase 6）
```

**对比其他 cache-memory 用途**:
| 工作流 | cache-memory 用途 | 时间跨度 |
|--------|------------------|---------|
| cloclo | 对话上下文 | 短期（单次运行） |
| smoke-detector | 知识库 | 长期（跨运行累积） |

**核心价值**:
- **机器学习基础**: 积累数据支持模式识别
- **快速诊断**: 相似失败直接参考历史
- **知识复利**: 每次调查让系统更智能

---

### 4. 动态输出路由 - 智能选择通知位置 ⭐⭐⭐⭐

**路由逻辑**（Phase 7）:
```
失败工作流运行
    │
    ▼
查询 PR（使用 head_sha）
    │
    ├─ 找到 PR → add_comment（评论到 PR）
    │
    └─ 未找到 PR → create_issue（创建 Issue）
```

**实现细节**:
```markdown
Query: `repo:${{ github.repository }} is:pr ${{ inputs.head_sha }}`
```

**safe-outputs 配置**:
```yaml
add-comment:
  target: "*"              # 可评论任意 PR/Issue
  hide-older-comments: true  # 折叠旧评论
create-issue:
  expires: 2h              # 临时 Issue，自动过期
```

**设计优雅之处**:
- **上下文感知**: 失败信息出现在最相关的地方
- **减少噪音**: PR 失败不会创建独立 Issue
- **用户体验**: 开发者在工作的地方看到反馈

---

### 5. 漏斗式调查框架 - 7 个 Phase 的时间哲学 ⭐⭐⭐⭐

**Phase 时间预算**（总 20 分钟）:
| Phase | 任务 | 预估时间 | 占比 | 关键产出 |
|-------|------|---------|------|---------|
| Phase 1 | 初步分类 | 2 分钟 | 10% | gh-aw_audit 报告 |
| Phase 2 | 日志分析 | 5 分钟 | 25% | 错误模式 |
| Phase 3 | 历史搜索 | 3 分钟 | 15% | 相似失败 |
| Phase 4 | 根因分析 | 5 分钟 | 25% | 失败分类 |
| Phase 5 | 知识存储 | 2 分钟 | 10% | 持久化 |
| Phase 6 | 去重判断 | 1 分钟 | 5% | 重复检测 |
| Phase 7 | 报告输出 | 2 分钟 | 10% | 调查报告 |

**漏斗设计**:
```
Phase 1-2: 收集数据（35%）
    ↓
Phase 3-4: 分析理解（40%）
    ↓
Phase 5-6: 知识管理（15%）
    ↓
Phase 7: 行动输出（10%）
```

**时间分配哲学**:
- **快速失败**: Phase 1 快速判断是否需要深入
- **核心聚焦**: Phase 3-4 占 40%，核心价值所在
- **输出轻量**: Phase 7 仅 10%，大部分工作已完成

---

### 6. Expiring Issue - "通知即焚"模式 ⭐⭐⭐

**配置**:
```yaml
create-issue:
  expires: 2h              # 2小时后自动关闭
  title-prefix: "[smoke-detector] "
  labels: [smoke-test, investigation]
```

**设计意图**:
- **临时通知**: Issue 仅作为通知，不需长期跟踪
- **防止堆积**: 保持 Issue 列表清洁
- **快速反馈**: 强制开发者快速响应

**与知识持久化结合**:
- ✅ Issue 自动过期（2小时）
- ✅ 但重要信息已保存到 cache-memory
- ✅ 未来可从知识库查询

---

### 7. Reporting Format 导入机制 ⭐⭐⭐

**导入方式**:
```yaml
imports:
  - shared/reporting.md
```

**格式规范**（从 shared/reporting.md）:
```markdown
1. **Overview**: 1-2 段落概述
2. **Details**: `<details><summary>` 折叠详细内容
3. **Run References**: `[§RunID](url)` 格式
4. **References**: 最多 3 个链接
```

**价值**:
- **一致性**: 所有报告使用相同格式
- **配置复用**: shared/ 目录集中管理
- **可维护性**: 修改一处，所有工作流受益

---

## 发现的新模式（7 个）

1. **Reusable Workflow Pattern** ⭐⭐⭐⭐⭐ - workflow_call 实现工作流复用
2. **MCP-Specialized Tool Pattern** ⭐⭐⭐⭐⭐ - 明确工具职责边界，专业化胜过通用化
3. **File-Based Knowledge Accumulation Pattern** ⭐⭐⭐⭐⭐ - cache-memory 构建知识库
4. **Dynamic Output Routing Pattern** ⭐⭐⭐⭐ - 基于上下文智能选择输出位置
5. **Phased Investigation Framework Pattern** ⭐⭐⭐⭐ - 漏斗式调查流程
6. **Expiring Issue Pattern** ⭐⭐⭐ - 临时 Issue 自动过期
7. **Themed Messages Pattern** ⭐⭐⭐ - 火警主题一致性设计

---

## 可复用片段（7 个）

1. Reusable Workflow 基础模板
2. MCP 工具选择约束模板
3. 文件系统知识库模板
4. 动态输出路由模板
5. Phased 调查框架模板
6. Expiring Issue 配置模板
7. Reporting Format 导入复用模板

---

## Skill 更新记录

### workflowAnalyzer Skill

**更新内容**: 新增 7 个设计模式

**更新位置**: `skills/workUnits/workflowCaseStudy/skills/workflowAnalyzer/SKILL.md`

**影响**:
- 扩展模式库（从 30 个增加到 37 个）
- **首次系统覆盖** workflow_call 触发器
- **首次深入记录** gh-aw MCP 工具集
- **首次区分** cache-memory 的不同用途

### workflowAuthoring Skill

**更新内容**: 新增 7 个可复用片段

**更新位置**: `skills/workUnits/workflowCaseStudy/skills/workflowAuthoring/SKILL.md`

**影响**:
- 丰富片段库（从 22 个增加到 29 个）
- **首次提供** workflow_call 模板
- **首次提供** 知识库设计模板
- **首次提供** 输出路由模板

---

## 批判性反思

### 做得好的地方 ✅

1. **填补了重要知识空白**:
   - workflow_call 是工作流组合的基础，之前完全未涉及
   - gh-aw MCP 工具集首次系统记录
   - 知识积累模式首次深入分析

2. **深度追问设计意图**:
   - 为何使用 workflow_call？→ 组合性和复用性
   - 为何明确约束使用 gh-aw_audit？→ 工具专业化
   - 为何 7 个 Phase？→ 漏斗式流程优化
   - 每个"为什么"都有推测和分析

3. **批判性视角**:
   - 诚实指出 6 个可改进之处
   - 指出缺少重试机制、时间约束不强、知识库无清理等问题
   - 不盲目赞美，保持客观

4. **横向对比**:
   - 对比 cloclo 的 cache-memory 用途（对话 vs 知识库）
   - 对比 cloclo 的多 MCP 策略（平等协作 vs 专业化）
   - 横向对比帮助理解设计权衡

5. **可迁移性思考**:
   - Phased 调查框架可应用于其他场景
   - 动态输出路由模式通用性强
   - 提取了可复用的调查框架模板

### 可以改进的地方 ⚠️

1. **未验证 workflow_call 的调用方式**:
   - 推测了调用语法，但未找到实际调用案例
   - 应该搜索其他工作流是否调用了 smoke-detector
   - **下次改进**: 找到调用案例验证推测

2. **gh-aw MCP 工具集不完整**:
   - 只从 Prompt 提取了 4 个工具
   - 可能还有其他工具未提及
   - **下次改进**: 查看 gh-aw.md 源文件或文档

3. **知识库文件格式未验证**:
   - 推测了 JSON 格式，但未找到实际示例
   - 不确定 `error_signature` 如何计算
   - **下次改进**: 查看实际运行产生的文件

4. **未分析 shared/reporting.md 的完整内容**:
   - 只读取了 14 行的简化版
   - 可能有更多格式规范
   - **下次改进**: 深入分析 reporting.md

5. **缺少性能分析**:
   - 20 分钟超时是否合理？
   - 7 个 Phase 实际运行需要多久？
   - **下次改进**: 如果可能，查看实际运行日志

### 下次改进措施 📝

1. **验证驱动**: 对每个推测，尝试找到实际案例验证
2. **源文件优先**: 直接查看导入的文件（gh-aw.md, reporting.md）
3. **实际运行日志**: 如果可访问，查看实际运行产生的文件
4. **调用者分析**: 搜索调用 smoke-detector 的工作流

---

## 未解决的问题 ❓

1. **workflow_call 的调用语法**:
   - 实际调用语法是什么？
   - 如何传递多个 inputs？
   - 调用者如何获取返回值？

2. **gh-aw MCP 的完整工具集**:
   - 除了 audit/logs/status/compile，还有哪些工具？
   - 每个工具的完整参数是什么？
   - 如何启动 gh-aw MCP 服务器？

3. **知识库的具体实现**:
   - `error_signature` 如何计算？
   - index.json 的结构是什么？
   - patterns/ 目录中的文件格式？

4. **去重算法的准确性**:
   - Phase 6 的搜索查询是什么？
   - 如何判断两个失败"相似"？
   - 误判率如何？

5. **Expiring Issue 的机制**:
   - 2 小时后如何自动关闭？
   - 是 GitHub Actions 的原生功能还是自定义逻辑？
   - 如果手动关闭，会发生什么？

**建议**: 创建 Issue 追踪这些问题，标记为 "research questions"

---

## 后续研究建议

### 方向 1: workflow_call 生态全景图 ⭐⭐⭐⭐⭐

**目标**: 系统性研究所有可重用工作流

**任务**:
1. 搜索所有使用 `workflow_call` 的工作流
2. 分类可重用工作流（诊断、部署、通知等）
3. 总结参数设计模式
4. 找到调用案例，分析调用方式

**产出**:
- workflow_call 使用模式库
- 可重用工作流设计最佳实践
- 调用方式参考手册

**价值**: 这是构建复杂工作流系统的基础知识

---

### 方向 2: gh-aw MCP 完整工具集文档

**目标**: 系统化记录 gh-aw MCP 的所有工具和能力

**任务**:
1. 深度分析 `shared/mcp/gh-aw.md`
2. 列举所有可用工具
3. 总结每个工具的参数、输出、使用场景
4. 提取工具组合的最佳实践

**产出**:
- gh-aw MCP 工具参考手册
- 工具选择决策树
- 常见诊断场景的工具组合模板

**价值**: gh-aw MCP 是工作流诊断的核心工具，值得深入研究

---

### 方向 3: 知识积累模式对比研究

**目标**: 对比不同工作流的知识积累策略

**任务**:
1. 分析所有使用 cache-memory 的工作流
2. 分类知识积累模式（对话、知识库、状态存储）
3. 评估每种模式的优缺点
4. 总结知识库设计的最佳实践

**产出**:
- 知识积累模式分类
- cache-memory 使用最佳实践
- 知识库设计模板

**价值**: 知识积累是 AI 工作流的核心价值，值得深入研究

---

### 方向 4: 调查框架的通用性研究

**目标**: 验证 Phased 调查框架的可迁移性

**任务**:
1. 识别其他使用类似框架的工作流
2. 分析不同领域的调查流程（性能、安全、质量）
3. 提取通用的调查框架模板
4. 创建"调查框架选择指南"

**产出**:
- 通用调查框架模板
- 不同领域的调查流程对比
- 调查框架设计最佳实践

**价值**: 调查框架可应用于多种场景，通用价值高

---

## 核心洞见 💡

1. **workflow_call 是工作流的"函数调用"**:
   - 实现了代码复用的核心原则
   - 将工作流从"脚本"提升为"可组合的组件"
   - 是构建复杂工作流系统的基础

2. **MCP 专业化 > MCP 数量**:
   - 明确的工具边界优于"万能工具"
   - 专业工具提供更好的能力
   - 约束是指引，不是限制

3. **知识积累是 AI 工作流的核心价值**:
   - 不只是"自动化任务"
   - 而是"学习和改进"
   - 每次运行都让系统更智能

4. **输出路由的智能化很重要**:
   - 盲目创建 Issue 会造成噪音
   - 上下文感知提高用户体验
   - 临时通知 + 持久化知识 = 最佳实践

5. **调查框架的可迁移性**:
   - Phased 调查模式不只适用于工作流失败
   - 可应用于性能、安全、质量等多种场景
   - 这是一个通用的"系统化调查"模板

6. **imports 是配置管理的艺术**:
   - shared/ 目录是知识库的一部分
   - 配置复用不是简单的复制粘贴
   - 一致性和可维护性的保证

---

## 时间统计

- **分析时长**: 50 分钟
- **报告撰写**: 60 分钟
- **日志记录**: 20 分钟
- **Skill 更新**: 预计 25 分钟
- **总计**: 预计 155 分钟

---

## 心得体会 💭

这次分析让我对 GitHub Agentic Workflows 的架构设计有了全新的认识：

1. **workflow_call 打开了新世界**:
   - 之前分析的都是"独立工作流"
   - 现在意识到工作流可以像函数一样被调用
   - 这意味着可以构建"工作流库"

2. **gh-aw MCP 是元编程的体现**:
   - 工作流可以"自省"和"诊断"自己
   - 这是高阶抽象的体现
   - 元能力是构建智能系统的关键

3. **知识积累的重要性再次被强化**:
   - smoke-detector 不只是"分析失败"
   - 更是"学习失败模式"
   - 这是从"自动化"到"智能化"的关键

4. **7 个 Phase 的设计很优雅**:
   - 漏斗式流程高效分配时间
   - 每个 Phase 有明确的边界
   - 可跳过机制（Phase 6）很聪明

5. **动态输出路由提升了用户体验**:
   - 不是"一刀切"的通知方式
   - 而是"上下文感知"的智能选择
   - 这是 UX 设计在工作流中的体现

6. **下次分析应该更多验证**:
   - 这次仍有很多"推测"
   - 应该查阅文档、查看源码、找实际案例
   - 验证 > 推测

---

**下次见！** 🔥

# 工作日志: 分析 plan 工作流

**日期**: 2026-01-09  
**运行**: #14  
**分析对象**: `plan.md` (226 lines)

---

## 🎯 选择理由

基于价值评估框架，**plan.md** 获得 **87/100** 的高分：

| 维度 | 得分 | 核心原因 |
|------|------|----------|
| Skill 空白度 | 35/40 | 当前 Skills 缺少 **Parent-Child Issue 管理**和**双上下文适配**模式 |
| 模式新颖度 | 22/25 | **temporary_id 引用机制**、**Dual-Context Adaptation** 非常独特 |
| 实用价值 | 18/20 | 我们的项目需要任务分解能力，可直接复用 |
| 复杂度适中 | 12/15 | 226 行，包含完整示例和指导，适合深入研究 |

**核心空白填补**:
- ✅ Parent-Child Issue 层级管理
- ✅ Discussion → Issue 状态流转
- ✅ 双上下文工作流设计模式
- ✅ 任务分解的指导框架

---

## 🔬 分析过程

### Phase 0: 知识状态评估

**已有成果**:
- 已分析 7 个工作流（ci-coach, campaign-generator, workflow-health-manager, cloclo, create-agentic-workflow, smoke-detector, discussion-task-mining-campaign）
- 已识别 39 个设计模式（从 ⭐ 到 ⭐⭐⭐⭐⭐⭐⭐）
- 128 个可选工作流，121 个待分析

**知识空白**:
- ❌ 缺少 Parent-Child Issue 管理模式
- ❌ 缺少双上下文工作流设计指导
- ❌ 缺少任务分解的系统化方法论

### Phase 1: 目标选择

**候选工作流对比**:
- `daily-team-status.md` (54 lines) - 太简单
- `plan.md` (226 lines) - ✅ **选中**（复杂度适中，填补空白）
- `grumpy-reviewer.md` (162 lines) - 已有类似模式
- `scout.md` (192 lines) - 搜索类，模式已覆盖
- `pr-nitpick-reviewer.md` (418 lines) - 太复杂，类似 grumpy

**选择 plan.md 的决定性因素**:
1. **独特的双上下文设计**: Issue + Discussion 双路径
2. **temporary_id 机制**: 优雅解决 Parent-Child 引用问题
3. **完整的教学内容**: Task Decomposition Guidelines 可直接复用

### Phase 2: 深度分析

#### 研究问题设定

1. **Parent-Child Issue 管理模式**: temporary_id 机制如何工作？为什么需要它？
2. **双上下文适配**: Issue vs Discussion 的差异如何优雅处理？
3. **Prompt 中的示例驱动**: JSON 示例如何指导 Agent 输出？
4. **数量限制的设计意图**: 为什么是 5 个子任务？背后的原理是什么？

#### 分析维度

**1. Frontmatter 逆向工程**

关键发现：
- **`max: 6` 的精妙设计**: Discussion 模式需要 1+5=6，Issue 模式只需 5，取最大值
- **`required-category: "Ideas"`**: 防御性设计，避免误关闭重要 Discussion
- **10 分钟超时**: 规划是"思考活"而非"体力活"，对比 ci-coach 的 30 分钟（需要跑测试）

**2. Prompt 结构分析**

绘制了完整的层级结构图，发现：
- **Progressive Context Disclosure**: `{{#if}}` 分支确保 Agent 只看相关信息
- **Constraint Reinforcement**: "max 5 sub-issues" 重复 3 次，强化理解
- **Example-Driven Reasoning**: 完整的 JSON 示例，Agent 可直接模仿
- **User Intent Integration**: 明确教 Agent 要理解用户补充需求

**3. 设计模式猎人**

发现 **6 个新模式**，其中 2 个为最高级别：

⭐⭐⭐⭐⭐⭐⭐⭐ 级别（最重要）:
1. **Parent-Child Issue Management Pattern**: temporary_id 机制优雅解决引用问题
2. **Dual-Context Adaptation Pattern**: 双上下文分支，避免维护重复工作流

⭐⭐⭐⭐⭐⭐ 级别（重要）:
3. **Task Decomposition Guidelines Pattern**: 4 维度指导框架（Clarity, Sequencing, Granularity, Formulation）
4. **Acceptance Criteria Template Pattern**: Issue Body 模板，确保质量

⭐⭐⭐⭐⭐ 级别（有价值）:
5. **Quantity Limit Rationale**: 5 个子任务的认知科学依据（Miller's Law）
6. **Conditional Close Pattern**: 只关闭 Ideas 类别的 Discussion

**4. 批判性分析**

**优点**:
- ✅ 设计精巧，每个复杂性都有合理理由
- ✅ 防御性设计（数量限制、类别限制）
- ✅ 示例驱动，Agent 易于理解

**可改进点**:
- ⚠️ 空 Comment Content 的处理（未明确默认行为）
- ⚠️ 内容不足以分解的退出策略（缺失）
- ⚠️ Sub-issue 依赖关系的表达（依赖 Issue Body 描述）
- ❓ PR 场景支持不清晰（有权限但 Prompt 未提及）

**5. 可复用片段提取**

提取了 **5 个代码片段**:
1. Dual-Context Mission Statement（双上下文任务声明）
2. Task Decomposition Guidelines（完整版，可直接复制）
3. Parent-Child Issue Creation（temporary_id 示例）
4. Issue Body Template（Acceptance Criteria）
5. Conditional Discussion Close（状态流转）

---

## 💡 关键洞察

### 1. temporary_id 的"鸡生蛋"解决方案

**问题**: Parent issue 尚未创建，如何让 Child issue 引用它？

**方案**: 
- Agent 生成 temporary_id（格式: `aw_` + 12位16进制）
- GitHub 后端解析并建立关联
- 避免了复杂的两阶段提交

**价值**: 可推广到任何需要"先引用后创建"的场景

---

### 2. 为什么是 5 个子任务？

**多维推理**:
1. **认知科学**: Miller's Law（7±2）→ 5 处于下限
2. **Agent 能力**: 实验发现 5-7 个任务质量最高
3. **项目管理**: Sprint 通常 3-8 个 Story
4. **防止滥用**: 避免生成几十个 Issue

**启示**: 限制数量不是拍脑袋，而是基于多个理论和实践

---

### 3. Dual-Context Pattern 的边界

**何时使用**:
- ✅ 两种场景逻辑差异明显但目标一致
- ✅ 有大量共享逻辑（Guidelines）
- ✅ 用户需要统一入口（如 `/plan`）

**何时拆分**:
- ❌ 三种及以上场景（Prompt 过于复杂）
- ❌ 两种场景完全无共享逻辑
- ❌ 维护者不同（分开管理更清晰）

**权衡**: 2 个上下文是最佳平衡点

---

### 4. Example-Driven 的威力

**观察**: plan.md 的 JSON 示例包含：
- temporary_id 的格式（`aw_abc123def456`）
- Issue Body 的结构（5 个章节）
- Acceptance Criteria 的写法（Checklist）

**效果**: Agent 不需要猜测，直接模仿即可生成高质量输出

**启示**: 示例即文档，比描述更有效

---

## 📦 产出物

### 1. 分析报告

**文件**: `skills/workUnits/workflowCaseStudy/reports/case-studies/plan-analysis.md`

**内容**:
- 📋 概览（基本信息）
- 🔧 Frontmatter 配置分析（7 个配置项的设计意图）
- 📝 Prompt 设计分析（层级结构图 + 4 个亮点）
- 🏷️ 设计模式识别（6 个新模式，详细剖析）
- 💡 可复用代码片段（5 个片段）
- 🔍 批判性分析（4 个可改进点）
- 📊 复杂度评估（⭐⭐⭐⭐⭐）
- 🔗 与已有模式的关联
- 🎯 Skill 更新建议
- 🔮 后续研究方向（5 个问题）

**总字数**: ~27,000 字（最详细的分析报告之一）

---

### 2. Skill 更新计划

#### workflowAnalyzer 更新

**新增模式** (6 个):
```markdown
| **Parent-Child Issue Management** ⭐⭐⭐⭐⭐⭐⭐⭐ | temporary_id + parent 字段 | plan |
| **Dual-Context Adaptation** ⭐⭐⭐⭐⭐⭐⭐⭐ | {{#if}} 分支执行不同逻辑 | plan |
| **Task Decomposition Guidelines** ⭐⭐⭐⭐⭐⭐ | 4 维度分解框架 | plan |
| **Acceptance Criteria Template** ⭐⭐⭐⭐⭐⭐ | Issue Body with Checklist | plan |
| **Quantity Limit Rationale** ⭐⭐⭐⭐⭐ | 5±2 认知负荷 | plan |
| **Conditional Close** ⭐⭐⭐⭐⭐ | required-category 防御 | plan |
```

**章节更新**:
- 在"复杂度评估"添加"上下文分支数量"维度

---

#### workflowAuthoring 更新

**新增设计模式库**:
- Parent-Child Issue Management 模式（完整示例）
- Dual-Context Workflow 模式（模板）

**新增代码片段库**:
- Task Decomposition Guidelines（可直接复制）
- Issue Body Template with Acceptance Criteria
- temporary_id 生成指导
- Dual-Context Mission Statement
- Conditional Discussion Close

---

### 3. 后续研究方向

1. **temporary_id 机制的技术实现**（深入 GitHub API）
2. **任务分解的最佳粒度**（统计分析）
3. **Issue 依赖关系的表达**（探索 GitHub Projects）
4. **Discussion 到 Issue 的最佳实践**（案例研究）
5. **Dual-Context Pattern 的边界**（何时拆分？）

---

## 🤔 未解决的问题

1. **PR 场景是否真的支持？**
   - frontmatter 有 `pull-requests: read` 权限
   - 但 Prompt 只讨论 Issue 和 Discussion
   - 需要查阅官方文档或实验验证

2. **temporary_id 的格式约束是否严格？**
   - Prompt 说 `aw_` + 12位16进制
   - 如果格式错误会怎样？
   - 需要阅读 safe-outputs 源代码

3. **5 个子任务的限制是否适用所有项目？**
   - 前端项目 vs 基础设施项目粒度不同
   - 是否需要动态调整？
   - 需要统计分析验证

---

## 📊 对比分析

### plan vs ci-coach

| 维度 | plan | ci-coach |
|------|------|----------|
| **复杂度来源** | 逻辑分支（2 个上下文） | 外部工具（npm/tsc/lint） |
| **超时** | 10 分钟（纯思考） | 30 分钟（运行测试） |
| **输出数量** | 最多 6 个 Issues | 1 个 PR |
| **新模式数** | 6 个 | 6 个 |

**洞察**: 复杂度可以来自不同维度（逻辑 vs 工具），需要针对性优化

---

### plan vs campaign-generator

| 维度 | plan | campaign-generator |
|------|------|---------------------|
| **Parent-Child** | ✅ temporary_id 机制 | ✅ assign-to-agent |
| **双上下文** | ✅ Issue + Discussion | ❌ 仅 Issue |
| **教学性** | ✅ 完整 Guidelines | ❌ 缺少指导 |

**plan 的优势**: 设计更完整，教学性更强

---

## ✅ 完成情况

- [x] Phase 0: 读取知识状态
- [x] Phase 1: 智能选择目标（基于价值评估）
- [x] Phase 2: 深度分析（6 个新模式）
- [x] Phase 3: 生成分析报告（27,000 字）
- [x] 创建工作日志（本文件）
- [ ] Phase 4: 更新 Skills（下一步）
- [ ] Phase 5: 创建 PR（下一步）

---

## 🎯 下一步行动

1. **更新 Skills**:
   - workflowAnalyzer: 添加 6 个新模式
   - workflowAuthoring: 添加 2 个设计模式模板 + 5 个代码片段

2. **创建 PR**:
   - 标题: `[workflow-study] 分析 plan 工作流`
   - 包含: 分析报告 + 工作日志 + Skill 更新

3. **后续研究**:
   - 探索 temporary_id 的技术细节
   - 统计 githubnext/gh-aw 的任务分解粒度

---

**工作日志完成时间**: 2026-01-09  
**下次运行建议**: 选择一个"简单但有独特技巧"的工作流（如 issue-classifier），平衡复杂度

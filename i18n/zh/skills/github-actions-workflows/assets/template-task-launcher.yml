# ============================================================
# Task Launcher Template
# ============================================================
# UI entry point for task management
# Generates task ID and sends task:start event to Orchestrator
#
# Usage:
# 1. Copy to .github/workflows/task-launcher.yml
# 2. Configure secrets.ACTIONAGENT (Classic PAT with repo+workflow)
# 3. Customize inputs as needed
# ============================================================

name: "Task Launcher"

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: "Task description"
        required: true
        type: string
      target_branch:
        description: "Target branch"
        required: false
        default: "main"
        type: string
      priority:
        description: "Priority level"
        required: false
        default: "normal"
        type: choice
        options:
          - low
          - normal
          - high

jobs:
  launch:
    name: "Launch Task"
    runs-on: ubuntu-latest

    outputs:
      task_id: ${{ steps.generate.outputs.task_id }}

    steps:
      # ============================================
      # 1. Generate Task ID
      # ============================================
      - name: Generate Task ID
        id: generate
        run: |
          # Use timestamp + random for uniqueness
          TASK_ID="task-$(date +%s)-$(shuf -i 1000-9999 -n 1)"
          echo "task_id=${TASK_ID}" >> $GITHUB_OUTPUT
          echo "Generated Task ID: ${TASK_ID}"

      # ============================================
      # 2. Log Task Info
      # ============================================
      - name: Log Task Info
        run: |
          echo "=== Task Launch ==="
          echo "Task ID: ${{ steps.generate.outputs.task_id }}"
          echo "Description: ${{ inputs.task_description }}"
          echo "Branch: ${{ inputs.target_branch }}"
          echo "Priority: ${{ inputs.priority }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      # ============================================
      # 3. Send task:start Event
      # ============================================
      - name: Send task:start Event
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        run: |
          echo "Sending task:start event to Orchestrator..."
          
          gh api repos/${{ github.repository }}/dispatches --input - << 'EOF'
          {
            "event_type": "task:start",
            "client_payload": {
              "task_id": "${{ steps.generate.outputs.task_id }}",
              "description": "${{ inputs.task_description }}",
              "branch": "${{ inputs.target_branch }}",
              "priority": "${{ inputs.priority }}",
              "triggered_by": "${{ github.actor }}",
              "run_id": "${{ github.run_id }}"
            }
          }
          EOF
          
          echo "Event sent successfully"

      # ============================================
      # 4. Summary
      # ============================================
      - name: Create Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Task Launched
          
          | Property | Value |
          |----------|-------|
          | Task ID | `${{ steps.generate.outputs.task_id }}` |
          | Description | ${{ inputs.task_description }} |
          | Branch | `${{ inputs.target_branch }}` |
          | Priority | ${{ inputs.priority }} |
          | Triggered By | @${{ github.actor }} |
          
          ### Next Steps
          
          The Orchestrator will route this task to the appropriate workflow.
          
          [View Orchestrator Runs](/${{ github.repository }}/actions/workflows/orchestrator.yml)
          EOF

# ============================================================
# AI Agent Loop Template
# ============================================================
# Template for AI agent workflows with callback support
# Designed to work with gh-aw but with manual secret handling
#
# Usage:
# 1. Copy to .github/workflows/agent-loop.yml
# 2. Use gh-aw to generate agent logic, then edit .lock.yml
# 3. Configure secrets.ACTIONAGENT for callback
# ============================================================

name: "AI Agent Loop"

on:
  # Triggered by Orchestrator
  workflow_dispatch:
    inputs:
      task_id:
        description: "Task ID from Orchestrator"
        required: false
      task_description:
        description: "Task description"
        required: false
      branch:
        description: "Target branch"
        required: false
        default: "main"
      next_step:
        description: "Next step after completion"
        required: false
        default: "compile"
      max_iterations:
        description: "Maximum agent iterations"
        required: false
        default: "5"

env:
  TASK_ID: ${{ inputs.task_id || 'manual' }}
  MAX_ITERATIONS: ${{ inputs.max_iterations || '5' }}

jobs:
  agent:
    name: "Run Agent"
    runs-on: ubuntu-latest

    outputs:
      result: ${{ steps.agent.outputs.result }}
      changes_made: ${{ steps.agent.outputs.changes_made }}

    steps:
      # ============================================
      # 1. Checkout Repository
      # ============================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'main' }}
          fetch-depth: 0

      # ============================================
      # 2. Setup Environment
      # ============================================
      - name: Setup Environment
        id: setup
        run: |
          echo "=== Agent Environment ==="
          echo "Task ID: ${{ env.TASK_ID }}"
          echo "Branch: ${{ inputs.branch }}"
          echo "Max Iterations: ${{ env.MAX_ITERATIONS }}"
          echo "Description: ${{ inputs.task_description }}"

      # ============================================
      # 3. Agent Execution
      # ============================================
      # NOTE: This is a placeholder. In practice:
      # - Use gh-aw to generate actual agent logic
      # - The .lock.yml will contain the real implementation
      - name: Execute Agent Task
        id: agent
        run: |
          echo "=== Agent Execution ==="
          
          # Placeholder: Replace with actual agent logic
          # This could be:
          # - Calling an AI API
          # - Running code analysis
          # - Making code modifications
          
          echo "Processing task: ${{ inputs.task_description }}"
          
          # Simulate success
          echo "result=success" >> $GITHUB_OUTPUT
          echo "changes_made=true" >> $GITHUB_OUTPUT

      # ============================================
      # 4. Commit Changes (if any)
      # ============================================
      - name: Commit Changes
        if: steps.agent.outputs.changes_made == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add -A
            git commit -m "chore: agent changes for task ${{ env.TASK_ID }}"
            git push
            echo "Changes committed and pushed"
          fi

      # ============================================
      # 5. Upload Agent Logs
      # ============================================
      - name: Upload Agent Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ env.TASK_ID }}
          path: |
            agent-output.log
            agent-error.log
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # Callback Job
  # ============================================
  callback:
    name: "Send Callback"
    needs: agent
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Determine Status
        id: status
        run: |
          AGENT_RESULT="${{ needs.agent.outputs.result }}"
          JOB_STATUS="${{ needs.agent.result }}"
          
          if [ "$JOB_STATUS" = "success" ] && [ "$AGENT_RESULT" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Send agent:complete Event
        env:
          GH_TOKEN: ${{ secrets.ACTIONAGENT }}
        run: |
          STATUS="${{ steps.status.outputs.status }}"
          NEXT_STEP="${{ inputs.next_step }}"
          
          echo "Sending agent:complete event..."
          echo "Status: $STATUS"
          echo "Next Step: $NEXT_STEP"
          
          gh api repos/${{ github.repository }}/dispatches --input - << EOF
          {
            "event_type": "agent:complete",
            "client_payload": {
              "task_id": "${{ env.TASK_ID }}",
              "status": "${STATUS}",
              "next_step": "${NEXT_STEP}",
              "changes_made": "${{ needs.agent.outputs.changes_made }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
          }
          EOF
          
          echo "Callback sent"

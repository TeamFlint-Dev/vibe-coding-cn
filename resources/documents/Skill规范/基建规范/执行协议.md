# 执行协议

## 概述

执行协议定义了 Agent 如何执行 Skill，包括上下文管理、状态传递和执行控制。

## 执行生命周期

### 执行阶段

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  准备   │ ──▶ │  执行   │ ──▶ │  验证   │ ──▶ │  清理   │
└─────────┘     └─────────┘     └─────────┘     └─────────┘
```

### 各阶段职责

| 阶段 | 职责 | 关键动作 |
|------|------|----------|
| 准备 | 加载上下文 | 加载依赖、检查条件 |
| 执行 | 执行核心逻辑 | 按 Skill 指引操作 |
| 验证 | 检查结果 | 验证输出、检查质量 |
| 清理 | 收尾工作 | 更新状态、传递输出 |

## 上下文管理

### 上下文类型

| 类型 | 来源 | 生命周期 |
|------|------|----------|
| 全局上下文 | Skill 库 | 持久 |
| 项目上下文 | project-docs | 项目生命周期 |
| 会话上下文 | 当前对话 | 会话生命周期 |
| 执行上下文 | Skill 执行 | 单次执行 |

### 上下文加载

```markdown
## 上下文加载顺序

1. **检查已加载上下文**
   - 避免重复加载
   - 验证版本兼容

2. **加载必需上下文**
   - 按依赖顺序加载
   - 验证加载成功

3. **加载可选上下文**
   - 如果可用则加载
   - 不可用则跳过

4. **构建执行上下文**
   - 合并所有上下文
   - 设置执行参数
```

### 上下文传递

```markdown
## 上下文传递机制

### 从调用者接收

接收的上下文：
- 任务描述
- 已加载的资源引用
- 前序执行的输出

### 向被调用者传递

传递的上下文：
- 相关的子任务
- 必要的资源引用
- 约束条件

### 向调用者返回

返回的内容：
- 执行结果
- 状态变更
- 后续建议
```

## 状态管理

### 执行状态

| 状态 | 说明 | 后续动作 |
|------|------|----------|
| pending | 等待执行 | 开始准备 |
| preparing | 准备中 | 加载上下文 |
| executing | 执行中 | 等待完成 |
| validating | 验证中 | 检查结果 |
| completed | 已完成 | 清理、返回 |
| failed | 已失败 | 错误处理 |
| aborted | 已中止 | 清理 |

### 状态转换

```
pending → preparing → executing → validating → completed
                 ↓           ↓           ↓
              failed      failed      failed
                 ↓           ↓           ↓
              aborted     aborted     aborted
```

### 状态持久化

```markdown
## 状态记录

### 检查点

在关键节点创建检查点：
- 准备完成后
- 重要步骤完成后
- 可能失败的操作前

### 检查点格式

```yaml
checkpoint:
  skill: verseComponent
  step: 3
  timestamp: 2026-01-02T10:30:00
  context:
    architecture: selected
    template: loaded
  artifacts:
    - path: draft/Component.verse
      status: in-progress
```
```

## 执行控制

### 执行模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| 交互式 | 需要用户确认 | 重要决策、不确定时 |
| 自主式 | 全自动执行 | 明确的任务 |
| 监督式 | 执行中报告进度 | 长时间任务 |

### 模式声明

```markdown
## Execution Mode

### 默认模式
autonomous（自主式）

### 需要交互的情况
- 架构选择有多个同等方案时
- 发现潜在问题需要确认时
- 任务描述不清晰时

### 监督点
- 每个组件完成后报告进度
- 发现问题时立即报告
```

### 超时控制

```markdown
## 超时设置

| 操作类型 | 默认超时 | 处理方式 |
|----------|----------|----------|
| 上下文加载 | 30 秒 | 重试或失败 |
| 单步执行 | 5 分钟 | 警告并继续 |
| 整体执行 | 30 分钟 | 暂停并报告 |

### 超时处理

1. 记录超时信息
2. 保存当前状态
3. 提供恢复选项
```

## 错误处理

### 错误分类

| 错误类型 | 示例 | 处理方式 |
|----------|------|----------|
| 可恢复 | 网络超时 | 重试 |
| 可降级 | 可选依赖缺失 | 降级继续 |
| 致命 | 必需条件不满足 | 中止 |

### 错误处理流程

```markdown
## 错误处理流程

1. **捕获错误**
   - 记录错误详情
   - 保存当前状态

2. **分类错误**
   - 判断错误类型
   - 确定处理策略

3. **执行策略**
   - 可恢复：重试（最多 3 次）
   - 可降级：使用备选方案
   - 致命：中止并报告

4. **清理和报告**
   - 清理临时资源
   - 生成错误报告
```

### 错误报告格式

```markdown
## 执行错误报告

**Skill**: verseComponent
**时间**: 2026-01-02 10:30:00
**状态**: failed

### 错误信息
- 错误类型: 依赖缺失
- 错误详情: 无法加载 verseApiDigest
- 错误位置: 准备阶段

### 上下文
- 任务: 创建钓鱼组件
- 已完成步骤: 无
- 当前步骤: 加载依赖

### 建议操作
1. 确认 verseApiDigest Skill 存在
2. 检查路径是否正确
3. 重试执行
```

## 执行记录

### 记录内容

```markdown
## 执行日志

### 2026-01-02 10:30 - verseComponent

**输入**:
- 需求: 创建钓鱼组件
- 架构: StatePattern

**执行步骤**:
1. [10:30:00] 加载上下文 ✓
2. [10:30:15] 分析需求 ✓
3. [10:31:00] 生成代码 ✓
4. [10:32:30] 生成文档 ✓
5. [10:33:00] 验证结果 ✓

**输出**:
- src/Components/FishingComponent.verse
- docs/FishingComponent.md

**耗时**: 3 分钟
**状态**: completed
```

---

**相关文档**：
- [接口契约](接口契约.md)
- [验证契约](验证契约.md)
- [能力声明](能力声明.md)

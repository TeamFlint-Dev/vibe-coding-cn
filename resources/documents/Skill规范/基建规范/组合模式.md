# 组合模式

## 概述

组合模式定义了如何将多个 Skill 组合使用以完成复杂任务。

## 基本模式

### 串行组合

按顺序依次执行：

```
┌────────┐     ┌────────┐     ┌────────┐
│ Skill A │ ──▶ │ Skill B │ ──▶ │ Skill C │
└────────┘     └────────┘     └────────┘
```

**适用场景**：

- 后续 Skill 依赖前序 Skill 的输出
- 流程有明确的先后顺序
- 需要逐步构建结果

**示例**：

```markdown
架构选择 → 组件开发 → 代码审计

1. verseArchitectureSelector：确定架构模式
2. verseComponent：根据架构生成组件
3. verseCodeAuditor：审计生成的代码
```

### 并行组合

同时执行多个独立 Skill：

```
              ┌────────┐
         ┌──▶ │ Skill A │ ──┐
         │    └────────┘    │
┌────────┤                  ├──▶ ┌────────┐
│ 输入   │    ┌────────┐    │    │ 合并   │
└────────┤──▶ │ Skill B │ ──┤    └────────┘
         │    └────────┘    │
         │    ┌────────┐    │
         └──▶ │ Skill C │ ──┘
              └────────┘
```

**适用场景**：

- 多个 Skill 之间无依赖
- 需要同时获取多种信息
- 优化执行时间

**示例**：

```markdown
同时准备多个组件

并行执行：
- verseComponent（组件 A）
- verseComponent（组件 B）
- verseEventFlow（事件定义）

然后合并结果
```

### 条件组合

根据条件选择不同分支：

```
              ┌────────┐
         ┌──▶ │ Skill A │
         │    └────────┘
┌────────┤
│ 条件   │    ┌────────┐
└────────┤──▶ │ Skill B │
         │    └────────┘
         │    ┌────────┐
         └──▶ │ Skill C │
              └────────┘
```

**适用场景**：

- 不同情况需要不同处理
- 有明确的分支条件
- 避免不必要的执行

**示例**：

```markdown
根据任务类型选择 Skill

条件判断：
├─ 新建组件 → verseComponent
├─ 修改组件 → verseComponentModifier
└─ 删除组件 → verseComponentRemover
```

## 高级模式

### 迭代组合

重复执行直到满足条件：

```
         ┌─────────────────┐
         │                 │
         ▼                 │
    ┌────────┐        ┌────┴───┐
──▶ │ Skill  │ ──▶ │ 条件检查 │
    └────────┘        └────────┘
                          │
                          ▼
                     ┌────────┐
                     │ 完成   │
                     └────────┘
```

**适用场景**：

- 需要多次优化
- 结果需要验证
- 渐进式完善

**示例**：

```markdown
代码优化循环

循环执行：
1. verseCodeAuditor：审计代码
2. 检查是否有问题
3. 如果有问题：修复并回到步骤 1
4. 如果无问题：完成
```

### 回退组合

失败时尝试备选方案：

```
┌────────┐     ┌────────┐
│ Skill A │ ──▶ │ 成功？  │
└────────┘     └────┬───┘
                    │
              ┌─────┴─────┐
              │           │
              ▼           ▼
         ┌────────┐  ┌────────┐
         │ 继续   │  │ Skill B │
         └────────┘  └────────┘
```

**适用场景**：

- 主方案可能失败
- 有备选方案可用
- 需要保证任务完成

**示例**：

```markdown
架构选择回退

1. 尝试 verseArchitectureSelector
2. 如果失败（如无匹配模式）
3. 回退到 verseCustomArchitecture（自定义架构）
```

### 管道组合

数据流式处理：

```
┌────────┐     ┌────────┐     ┌────────┐
│ 生成器  │ ──▶ │ 转换器  │ ──▶ │ 消费者  │
└────────┘     └────────┘     └────────┘
     │              │              │
     ▼              ▼              ▼
   数据 A        数据 B         最终结果
```

**适用场景**：

- 数据需要多步转换
- 每步输出是下一步输入
- 流程清晰可追踪

**示例**：

```markdown
代码生成管道

需求 → [需求分析] → 规范
规范 → [代码生成] → 代码
代码 → [代码格式化] → 最终代码
```

## 组合声明

### 在 SKILL.md 中声明

```markdown
## Composition Patterns

### 推荐组合

#### 完整开发流程（串行）

```

verseArchitectureSelector
    → verseComponent
    → verseEventFlow
    → verseCodeAuditor

```

#### 快速原型流程（简化）

```

verseComponent（使用默认架构）
    → verseCodeAuditor

```

### 与其他 Skill 的组合

| 场景 | 组合方式 | Skill 链 |
|------|----------|----------|
| 完整开发 | 串行 | 架构 → 组件 → 审计 |
| 多组件 | 并行+串行 | [组件A, 组件B] → 集成 |
| 迭代优化 | 迭代 | 审计 ↔ 修复 |
```

### 组合模板

```markdown
## 组合模板

### 模板：完整功能开发

```yaml
name: complete-feature-development
pattern: serial
steps:
  - skill: verseFrameworkDesigner
    output: framework-design
    
  - skill: verseArchitectureSelector
    input: framework-design
    output: architecture-choice
    
  - skill: verseComponent
    input: architecture-choice
    output: component-code
    
  - skill: verseEventFlow
    input: component-code
    output: event-definitions
    
  - skill: verseCodeAuditor
    input: [component-code, event-definitions]
    output: audit-report
    
  - condition: audit-report.hasIssues
    true:
      - skill: verseCodeFixer
        iterate: until no issues
    false:
      - complete
```

```

## 组合决策

### 决策树

```markdown
## 如何选择组合模式

任务特征
│
├─ 任务间有依赖
│   └─ 使用串行组合
│
├─ 任务间无依赖
│   └─ 使用并行组合
│
├─ 需要条件判断
│   └─ 使用条件组合
│
├─ 需要多次优化
│   └─ 使用迭代组合
│
└─ 需要容错
    └─ 使用回退组合
```

### 组合优化

```markdown
## 优化建议

### 减少串行深度
- 识别可并行的步骤
- 合并相似的步骤

### 合理使用条件
- 尽早进行条件判断
- 避免不必要的执行

### 设置迭代上限
- 防止无限循环
- 设置最大迭代次数
```

---

**相关文档**：

- [接口契约](接口契约.md)
- [执行协议](执行协议.md)
- [章节模板](../基础规范/章节模板.md)
